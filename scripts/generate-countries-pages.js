#!/usr/bin/env node

/**
 * Generate /countries/{country}/ pages from data/regions.json
 *
 * Creates one page per country that has at least one datacenter region physically located there.
 * Example: /countries/norway/ shows country details, laws, and datacenter providers.
 *
 * Usage: node scripts/generate-countries-pages.js
 */

const fs = require('fs');
const path = require('path');

const DATA_DIR = path.join(__dirname, '..', 'data');
const CONTENT_COUNTRIES_DIR = path.join(__dirname, '..', 'content', 'countries');

function readJson(p) {
  return JSON.parse(fs.readFileSync(p, 'utf8'));
}

function ensureDir(p) {
  fs.mkdirSync(p, { recursive: true });
}

function safeWrite(filePath, content) {
  fs.writeFileSync(filePath, content);
}

// Title is auto-generated by layout from country data, no need to include flag

function main() {
  const regions = readJson(path.join(DATA_DIR, 'regions.json'));
  const datacenters = readJson(path.join(DATA_DIR, 'datacenters', 'datacenters.json'));
  const providers = datacenters.datacenters || datacenters;

  const regionById = new Map(regions.map((r) => [r.identifier, r]));

  // Count datacenter regions by physical country
  const countsByCountry = new Map(); // countryId -> count

  providers.forEach((p) => {
    (p.regions || []).forEach((r) => {
      const cid = r.countryId;
      if (!cid) return;
      countsByCountry.set(cid, (countsByCountry.get(cid) || 0) + 1);
    });
  });

  ensureDir(CONTENT_COUNTRIES_DIR);

  let generated = 0;
  Array.from(countsByCountry.entries())
    .filter(([cid, count]) => count > 0 && regionById.has(cid))
    .map(([cid, count]) => {
      const meta = regionById.get(cid);
      return { cid, count, meta };
    })
    .filter((x) => x.meta && x.meta.slug) // needs slug to build URL
    .sort((a, b) => (a.meta.name || a.cid).localeCompare((b.meta.name || b.cid)))
    .forEach(({ cid, count, meta }) => {
      const slug = meta.slug;
      const targetDir = path.join(CONTENT_COUNTRIES_DIR, slug);
      const indexPath = path.join(targetDir, 'index.md');

      ensureDir(targetDir);

      // Use abstract as description, fallback to generated text
      const abstract = meta.abstract || `Datacenter regions physically located in ${meta.name}.`;
      const summary = meta.summary || '';
      const body = meta.body || '';
      const image = meta.image || '';

      // Layout auto-generates title, map, laws, and providers sections from countryId
      const md = `---
countryId: "${cid}"
name: "${meta.name}"
flag: "${meta.flag || ''}"
slug: "${meta.slug}"
abstract: "${abstract.replace(/"/g, '\\"')}"
summary: "${summary.replace(/"/g, '\\"')}"
body: "${body.replace(/"/g, '\\"')}"
image: "${image}"
riskLevel: "${meta.riskLevel || ''}"
euMember: ${meta.euMember || false}
eeaMember: ${meta.eeaMember || false}
blocs: ${JSON.stringify(meta.blocs || [])}
lawConcern: ${meta.lawConcern || false}
nationalLaws: ${JSON.stringify(meta.nationalLaws || [])}
echarts: true
layout: "single"
showTableOfContents: true
---
`;

      safeWrite(indexPath, md);
      generated += 1;
    });

  console.log(`Generated ${generated} country pages in content/countries/{country}/index.md`);
}

main();




































