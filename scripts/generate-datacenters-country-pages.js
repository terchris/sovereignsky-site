#!/usr/bin/env node

/**
 * Generate /datacenters/{country}/ pages from data/regions.json + data/datacenters/providers.json
 *
 * Creates one page per country that has at least one datacenter region physically located there.
 * Example: /datacenters/norway/ shows all provider regions located in Norway, with a map auto-zoomed to Norway.
 *
 * Usage: node scripts/generate-datacenters-country-pages.js
 */

const fs = require('fs');
const path = require('path');

const DATA_DIR = path.join(__dirname, '..', 'data');
const CONTENT_DC_DIR = path.join(__dirname, '..', 'content', 'datacenters');

function readJson(p) {
  return JSON.parse(fs.readFileSync(p, 'utf8'));
}

function ensureDir(p) {
  fs.mkdirSync(p, { recursive: true });
}

function safeWrite(filePath, content) {
  fs.writeFileSync(filePath, content);
}

// Title is auto-generated by layout from country data, no need to include flag

function main() {
  const regions = readJson(path.join(DATA_DIR, 'regions.json'));
  const datacenters = readJson(path.join(DATA_DIR, 'datacenters', 'datacenters.json'));
  const providers = datacenters.datacenters || datacenters;

  const regionById = new Map(regions.map((r) => [r.identifier, r]));
  const providerIds = new Set(providers.map((p) => p.identifier).filter(Boolean));

  // Count datacenter regions by physical country, and capture provider counts per country.
  const countsByCountry = new Map(); // countryId -> count
  const providersByCountry = new Map(); // countryId -> Map(providerId -> count)

  providers.forEach((p) => {
    const pid = p.identifier;
    (p.regions || []).forEach((r) => {
      const cid = r.countryId;
      if (!cid) return;
      countsByCountry.set(cid, (countsByCountry.get(cid) || 0) + 1);
      if (!providersByCountry.has(cid)) providersByCountry.set(cid, new Map());
      const m = providersByCountry.get(cid);
      m.set(pid, (m.get(pid) || 0) + 1);
    });
  });

  ensureDir(CONTENT_DC_DIR);

  let generated = 0;
  Array.from(countsByCountry.entries())
    .filter(([cid, count]) => count > 0 && regionById.has(cid))
    .map(([cid, count]) => {
      const meta = regionById.get(cid);
      return { cid, count, meta };
    })
    .filter((x) => x.meta && x.meta.slug) // needs slug to build URL
    .sort((a, b) => (a.meta.name || a.cid).localeCompare((b.meta.name || b.cid)))
    .forEach(({ cid, count, meta }) => {
      const slug = meta.slug;
      const targetDir = path.join(CONTENT_DC_DIR, slug);
      const indexPath = path.join(targetDir, 'index.md');

      // Avoid collisions: if someone ever adds a provider_id equal to a country slug,
      // or if a provider page already exists at that path, we don't overwrite it.
      if (providerIds.has(slug)) {
        console.warn(`Skipping /datacenters/${slug}/: conflicts with provider_id "${slug}"`);
        return;
      }
      if (fs.existsSync(indexPath)) {
        const existing = fs.readFileSync(indexPath, 'utf8');
        if (existing.includes('provider_id:') || existing.includes('providerId:')) {
          console.warn(`Skipping /datacenters/${slug}/: existing page looks like a provider page`);
          return;
        }
      }

      ensureDir(targetDir);

      // Use abstract as description, fallback to generated text
      const abstract = meta.abstract || `Datacenter regions physically located in ${meta.name}.`;
      const summary = meta.summary || '';
      const body = meta.body || '';
      const image = meta.image || '';

      // Layout auto-generates title, map, laws, and providers sections from countryId
      const md = `---
countryId: "${cid}"
name: "${meta.name}"
flag: "${meta.flag || ''}"
slug: "${meta.slug}"
abstract: "${abstract.replace(/"/g, '\\"')}"
summary: "${summary.replace(/"/g, '\\"')}"
body: "${body.replace(/"/g, '\\"')}"
image: "${image}"
riskLevel: "${meta.riskLevel || ''}"
euMember: ${meta.euMember || false}
eeaMember: ${meta.eeaMember || false}
blocs: ${JSON.stringify(meta.blocs || [])}
lawConcern: ${meta.lawConcern || false}
nationalLaws: ${JSON.stringify(meta.nationalLaws || [])}
echarts: true
layout: "country"
showTableOfContents: true
---
`;

      safeWrite(indexPath, md);
      generated += 1;
    });

  console.log(`Generated ${generated} country datacenter pages in content/datacenters/{country}/index.md`);
}

main();




































