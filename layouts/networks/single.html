{{ define "main" }}
{{ .Scratch.Set "scope" "single" }}

{{/* Get identifier from front matter */}}
{{ $identifier := .Params.identifier | default "" }}

{{/* Look up connection data from networks.json */}}
{{ $networksRoot := site.Data.networks | default dict }}
{{ $connections := (index $networksRoot "networks") | default (slice) }}
{{ $actors := (index $networksRoot "networks-actors") | default (slice) }}
{{ $places := (index $networksRoot "networks-places") | default (slice) }}

{{ $connection := dict }}
{{ range $connections }}
  {{ if eq .identifier $identifier }}
    {{ $connection = . }}
  {{ end }}
{{ end }}

{{/* Build actor lookup */}}
{{ $actorById := dict }}
{{ range $actors }}
  {{ $actorById = merge $actorById (dict .identifier .) }}
{{ end }}

{{/* Build place lookup */}}
{{ $placeById := dict }}
{{ range $places }}
  {{ $placeById = merge $placeById (dict .identifier .) }}
{{ end }}

{{/* Build countries lookup for flags */}}
{{ $countries := site.Data.countries.countries.itemListElement }}
{{ $countriesById := dict }}
{{ range $countries }}
  {{ $countriesById = merge $countriesById (dict .identifier .) }}
{{ end }}

{{/* Get display title */}}
{{ $displayTitle := .Title }}
{{ if and $connection $connection.name }}
  {{ $displayTitle = $connection.name }}
{{ end }}

{{/* External URL from sources or url field */}}
{{ $externalUrl := "" }}
{{ if $connection }}
  {{ with $connection.url }}
    {{ $externalUrl = . }}
  {{ else }}
    {{ with $connection.sources }}
      {{ $first := index . 0 }}
      {{ if $first }}
        {{ $externalUrl = $first.url | default "" }}
      {{ end }}
    {{ end }}
  {{ end }}
{{ end }}

{{/* Build endpoints display */}}
{{ $endpointNames := slice }}
{{ if $connection }}
  {{ range $connection.endpointPlaceIds }}
    {{ $place := index $placeById . }}
    {{ $flag := "" }}
    {{ if $place }}
      {{ $countryId := "" }}
      {{ with $place.address }}{{ $countryId = .addressCountry }}{{ end }}
      {{ if $countryId }}
        {{ $region := index $countriesById $countryId }}
        {{ if $region }}{{ $flag = $region.flag }}{{ end }}
      {{ end }}
      {{ $endpointNames = $endpointNames | append (printf "%s %s" $flag ($place.name | default .)) }}
    {{ else }}
      {{ $endpointNames = $endpointNames | append . }}
    {{ end }}
  {{ end }}
{{ end }}

{{/* Build pageData for content partial */}}
{{ $pageData := dict
    "identifier" $identifier
    "connection" $connection
    "connections" $connections
    "places" $places
    "actors" $actors
    "endpointNames" $endpointNames
}}

{{ partial "common-single-page.html" (dict
    "page" .
    "icon" "network"
    "section" "Networks"
    "sectionUrl" "/networks/"
    "headerDescription" .Description
    "externalUrl" $externalUrl
    "externalLabel" "View on SubmarineCableMap"
    "showAbstract" false
    "showSummary" false
    "showFeaturedImage" false
    "showQuote" false
    "showToc" false
    "contentPartial" "content/networks-content.html"
    "pageData" $pageData
    "sidebarCards" (slice
        "sidebar/networks-details-card.html"
        "sidebar/common-topics-card.html"
        "sidebar/common-tags-card.html"
        (dict "partial" "sidebar/networks-endpoints-card.html"
              "params" (dict "connection" $connection "placeById" $placeById "countriesById" $countriesById))
        (dict "partial" "sidebar/networks-owners-card.html"
              "params" (dict "connection" $connection "actorById" $actorById "countriesById" $countriesById))
        (dict "partial" "sidebar/networks-links-card.html"
              "params" (dict "connection" $connection))
    )
) }}

{{ end }}
