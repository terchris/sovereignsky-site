{{ define "main" }}
{{ .Scratch.Set "scope" "single" }}

{{/* Resolve provider_id (prefer front matter) */}}
{{ $providerId := .Params.identifier | default "" }}
{{ if not $providerId }}
  {{ with .File }}
    {{ $providerId = strings.TrimSuffix "/" (strings.TrimPrefix "datacenters/" .Dir) }}
  {{ end }}
{{ end }}

{{/* Lookups */}}
{{ $datacenters := site.Data.datacenters }}
{{ $providers := $datacenters.datacenters | default (slice) }}
{{ $provider := dict }}
{{ range $providers }}
  {{ if eq .identifier $providerId }}
    {{ $provider = . }}
  {{ end }}
{{ end }}

{{ $regions := site.Data.countries.countries.itemListElement }}
{{ $regionsById := dict }}
{{ range $regions }}
  {{ $regionsById = merge $regionsById (dict .identifier .) }}
{{ end }}

{{/* Provider HQ metadata */}}
{{ $hqId := "" }}
{{ $hq := dict }}
{{ $hqName := "" }}
{{ $hqFlag := "" }}
{{ $hqRisk := "unknown" }}
{{ $hqSlug := "" }}
{{ if $provider }}
  {{ $hqId = $provider.vendorCountryId | default "" }}
{{ end }}
{{ if $hqId }}
  {{ $hq = index $regionsById $hqId }}
  {{ if $hq }}
    {{ $hqName = $hq.name }}
    {{ $hqFlag = $hq.flag }}
    {{ $hqRisk = $hq.riskLevel }}
    {{ $hqSlug = $hq.slug }}
  {{ end }}
{{ end }}

{{/* Risk label + emoji */}}
{{ $riskLevels := (site.Data.blocs.riskLevels | default dict) }}
{{ $riskLabel := $hqRisk }}
{{ with index $riskLevels $hqRisk }}
  {{ if .label }}{{ $riskLabel = .label }}{{ end }}
{{ end }}
{{ $riskEmoji := "" }}
{{ if eq $hqRisk "low" }}{{ $riskEmoji = "‚úÖ" }}{{ end }}
{{ if eq $hqRisk "moderate" }}{{ $riskEmoji = "‚ö†Ô∏è" }}{{ end }}
{{ if eq $hqRisk "elevated" }}{{ $riskEmoji = "üî∂" }}{{ end }}
{{ if eq $hqRisk "high" }}{{ $riskEmoji = "üö®" }}{{ end }}
{{ if eq $hqRisk "sanctioned" }}{{ $riskEmoji = "‚õî" }}{{ end }}

{{/* Compute provider physical-country distribution for sidebar */}}
{{ $countryCounts := dict }}
{{ $providerRegions := slice }}
{{ if $provider }}
  {{ $providerRegions = $provider.regions | default (slice) }}
  {{ range $providerRegions }}
    {{ $cid := .countryId | default "" }}
    {{ if $cid }}
      {{ $prev := index $countryCounts $cid | default 0 }}
      {{ $countryCounts = merge $countryCounts (dict $cid (add $prev 1)) }}
    {{ end }}
  {{ end }}
{{ end }}

{{ $countryItems := slice }}
{{ range $cid, $count := $countryCounts }}
  {{ $meta := index $regionsById $cid }}
  {{ $name := $cid }}
  {{ $flag := "" }}
  {{ $slug := "" }}
  {{ if $meta }}
    {{ $name = $meta.name | default $cid }}
    {{ $flag = $meta.flag | default "" }}
    {{ $slug = $meta.slug | default "" }}
  {{ end }}
  {{ $countryItems = $countryItems | append (dict "id" $cid "count" $count "meta" $meta "name" $name "flag" $flag "slug" $slug) }}
{{ end }}
{{ $countryItems = sort $countryItems "count" "desc" }}

{{/* Compare list (same type) */}}
{{ $compare := slice }}
{{ $ptype := "" }}
{{ if $provider }}{{ $ptype = $provider.providerType | default "" }}{{ end }}
{{ if $ptype }}
  {{ $same := where $providers "providerType" $ptype }}
  {{ range $same }}
    {{ if ne .identifier $providerId }}
      {{ $regionCount := len (.regions | default (slice)) }}
      {{ $compare = $compare | append (dict "identifier" .identifier "name" .name "regionCount" $regionCount) }}
    {{ end }}
  {{ end }}
  {{ $compare = sort $compare "regionCount" "desc" }}
{{ end }}

{{/* Provider name for display */}}
{{ $providerName := "" }}
{{ if $provider }}
  {{ $providerName = $provider.name | default $providerId }}
{{ end }}

{{/* Display title */}}
{{ $displayTitle := .Title }}
{{ if or (not .Title) (eq .Title "Index") (eq .Title "") }}
  {{ if $providerName }}
    {{ $displayTitle = printf "%s Datacenters" $providerName }}
  {{ end }}
{{ end }}

<article class="max-w-full">
  {{/* Detail Header with breadcrumbs */}}
  {{ partial "common-detail-header.html" (dict
      "title" $displayTitle
      "description" .Description
      "icon" "server"
      "breadcrumbs" (slice
          (dict "title" "Datacenters" "url" "/datacenters/")
      )
  ) }}

  {{/* Two-column layout */}}
  <section class="flex flex-col max-w-full mt-0 lg:flex-row">

    {{/* Right Sidebar */}}
    {{ partial "sidebar/common-sidebar.html" . }}

        {{/* External link button */}}
        {{ with $provider.url }}
        <a class="btn btn-primary btn-outline w-full gap-2"
           href="{{ . }}"
           target="_blank"
           rel="noopener noreferrer">
          {{ partial "content-icon.html" (dict "name" "external" "size" "4") }}
          Visit website
        </a>
        {{ end }}

        {{/* Provider Details Card */}}
        {{ if $provider }}
        <div class="card bg-base-100 shadow-sm border border-base-300">
          <div class="card-body p-4">
            <h3 class="card-title text-sm font-semibold flex items-center gap-2">
              {{ partial "content-icon.html" (dict "name" "info" "color" "primary" "size" "4") }}
              Provider Details
            </h3>
            <dl class="mt-2 text-sm">
              {{/* HQ */}}
              <div class="flex justify-between py-1">
                <dt class="text-neutral-500 dark:text-neutral-400">Headquarters</dt>
                <dd class="font-medium">{{ if $hqFlag }}{{ $hqFlag }} {{ end }}{{ $hqName }}</dd>
              </div>
              {{/* Total Regions */}}
              <div class="flex justify-between py-1">
                <dt class="text-neutral-500 dark:text-neutral-400">Total Regions</dt>
                <dd class="font-medium">{{ len $providerRegions }}</dd>
              </div>
              {{/* Countries */}}
              <div class="flex justify-between py-1">
                <dt class="text-neutral-500 dark:text-neutral-400">Countries</dt>
                <dd class="font-medium">{{ len $countryCounts }}</dd>
              </div>
              {{/* Provider Type */}}
              {{ with $provider.providerType }}
              <div class="flex justify-between py-1">
                <dt class="text-neutral-500 dark:text-neutral-400">Type</dt>
                <dd class="font-medium">{{ . | title }}</dd>
              </div>
              {{ end }}
              {{/* Data updated */}}
              {{ with $provider.updated }}
              <div class="pt-2 mt-2 border-t border-base-200">
                <div class="text-xs text-neutral-500 dark:text-neutral-400">Data updated {{ . }}</div>
              </div>
              {{ end }}
            </dl>
          </div>
        </div>
        {{ end }}

        {{/* Jurisdiction Card */}}
        {{ if $hqSlug }}
        <div class="card bg-base-100 shadow-sm border border-base-300">
          <div class="card-body p-4">
            <h3 class="card-title text-sm font-semibold flex items-center gap-2">
              {{ partial "content-icon.html" (dict "name" "scale" "color" "warning" "size" "4") }}
              Jurisdiction
            </h3>
            <div class="mt-2">
              <a href="/countries/{{ $hqSlug }}/"
                 class="text-sm block px-2 py-1 -mx-2 rounded hover:bg-base-200 dark:hover:bg-neutral-800 no-underline">
                {{ if $hqFlag }}{{ $hqFlag }} {{ end }}{{ $hqName }} laws
              </a>
              {{ if $riskEmoji }}
              <div class="mt-2 text-xs text-neutral-500 dark:text-neutral-400">
                {{ $riskEmoji }} {{ $riskLabel | title }} risk jurisdiction
              </div>
              {{ end }}
            </div>
          </div>
        </div>
        {{ end }}

        {{/* Countries Card */}}
        {{ if gt (len $countryItems) 0 }}
        <div class="card bg-base-100 shadow-sm border border-base-300">
          <div class="card-body p-4">
            <h3 class="card-title text-sm font-semibold flex items-center gap-2">
              {{ partial "content-icon.html" (dict "name" "globe" "color" "info" "size" "4") }}
              Countries
            </h3>
            <div class="text-xs text-neutral-500 dark:text-neutral-400 mb-2">
              {{ len $countryItems }} countries, {{ len $providerRegions }} regions
            </div>
            <ul class="space-y-0.5 max-h-48 overflow-y-auto">
              {{ range $countryItems }}
              <li>
                {{ if .slug }}
                <a href="/countries/{{ .slug }}/"
                   title="{{ .name }}: {{ .count }} regions"
                   class="text-sm block px-2 py-1 -mx-2 rounded hover:bg-base-200 dark:hover:bg-neutral-800 no-underline flex justify-between items-center">
                  <span>{{ if .flag }}{{ .flag }} {{ end }}{{ .name }}</span>
                  <span class="text-neutral-500 dark:text-neutral-400">{{ .count }}</span>
                </a>
                {{ else }}
                <span class="text-sm block px-2 py-1 -mx-2 flex justify-between items-center">
                  <span>{{ if .flag }}{{ .flag }} {{ end }}{{ .name }}</span>
                  <span class="text-neutral-500 dark:text-neutral-400">{{ .count }}</span>
                </span>
                {{ end }}
              </li>
              {{ end }}
            </ul>
          </div>
        </div>
        {{ end }}

        {{/* Compare Card */}}
        {{ if gt (len $compare) 0 }}
        <div class="card bg-base-100 shadow-sm border border-base-300">
          <div class="card-body p-4">
            <h3 class="card-title text-sm font-semibold flex items-center gap-2">
              {{ partial "content-icon.html" (dict "name" "compare" "color" "secondary" "size" "4") }}
              Compare
            </h3>
            <div class="text-xs text-neutral-500 dark:text-neutral-400 mb-2">
              Other {{ $ptype }} providers
            </div>
            <ul class="space-y-0.5">
              {{ range first 8 $compare }}
              <li>
                <a href="/datacenters/{{ .identifier }}/"
                   title="{{ .name }}: {{ .regionCount }} regions"
                   class="text-sm block px-2 py-1 -mx-2 rounded hover:bg-base-200 dark:hover:bg-neutral-800 no-underline flex justify-between items-center">
                  <span>{{ .name }}</span>
                  <span class="text-neutral-500 dark:text-neutral-400">{{ .regionCount }}</span>
                </a>
              </li>
              {{ end }}
            </ul>
          </div>
        </div>
        {{ end }}

        {{/* Related content */}}
        {{ partial "related-content-sidebar.html" . }}

        {{/* Table of Contents */}}
        {{ $showToc := in .TableOfContents "<ul" }}
        {{ if $showToc }}
        <div class="mt-6">
          {{ partial "toc.html" . }}
        </div>
        {{ end }}

    {{ partial "sidebar/common-sidebar-end.html" . }}

    {{/* Main Content */}}
    <div class="min-w-0 flex-1">
      <div class="article-content prose dark:prose-invert max-w-none mb-20">
        {{ .Content }}

        {{/* Back link */}}
        <hr class="mt-8">
        <p>
          <a href="/datacenters/">‚Üê Back to all datacenters</a>
        </p>
      </div>
    </div>

  </section>
</article>
{{ end }}
