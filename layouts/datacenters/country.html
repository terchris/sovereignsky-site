{{ define "main" }}
{{ .Scratch.Set "scope" "single" }}

{{/* Resolve country slug/id */}}
{{ $slug := "" }}
{{ with .File }}
  {{ $slug = strings.TrimSuffix "/" (strings.TrimPrefix "datacenters/" .Dir) }}
{{ end }}

{{ $countryId := .Params.countryId | default "" }}
{{ $country := dict }}
{{ if not $countryId }}
  {{ $match := first 1 (where site.Data.regions "slug" $slug) }}
  {{ with index $match 0 }}
    {{ $country = . }}
    {{ $countryId = .identifier }}
  {{ end }}
{{ else }}
  {{ $match := first 1 (where site.Data.regions "identifier" $countryId) }}
  {{ with index $match 0 }}
    {{ $country = . }}
  {{ end }}
{{ end }}

{{ $countryName := $countryId }}
{{ $countryFlag := "" }}
{{ $lawsSlug := $slug }}
{{ if $country }}
  {{ $countryName = $country.name | default $countryId }}
  {{ $countryFlag = $country.flag | default "" }}
  {{ $lawsSlug = $country.slug | default $slug }}
{{ end }}

{{/* Auto-generate title from regions.json if frontmatter title is not set */}}
{{ $autoTitle := "" }}
{{ if $countryName }}
  {{ $autoTitle = printf "%s Datacenters" $countryName }}
{{ end }}
{{ $displayTitle := .Title }}
{{ if and $autoTitle (or (not .Title) (eq .Title "Index") (eq .Title "")) }}
  {{ $displayTitle = $autoTitle }}
{{ end }}

{{/* Build region lookup for use by partials */}}
{{ $regionsById := dict }}
{{ range (site.Data.regions | default (slice)) }}
  {{ $regionsById = merge $regionsById (dict .identifier .) }}
{{ end }}

{{/* Providers that have regions in this country */}}
{{ $providers := site.Data.datacenters.datacenters | default (slice) }}
{{ $providerItems := slice }}
{{ $totalRegions := 0 }}
{{ if $countryId }}
  {{ range $providers }}
    {{ $p := . }}
    {{ $count := 0 }}
    {{ range ($p.regions | default (slice)) }}
      {{ if eq .countryId $countryId }}
        {{ $count = add $count 1 }}
      {{ end }}
    {{ end }}
    {{ if gt $count 0 }}
      {{ $totalRegions = add $totalRegions $count }}
      {{ $providerItems = $providerItems | append (dict "provider" $p "count" $count "name" ($p.name | default $p.identifier)) }}
    {{ end }}
  {{ end }}
{{ end }}
{{ $providerItems = sort $providerItems "name" "asc" }}
{{ $providerItems = sort $providerItems "count" "desc" }}

{{/* Get risk info for country */}}
{{ $hqRisk := "unknown" }}
{{ $riskLabel := "" }}
{{ $riskEmoji := "" }}
{{ if $country }}
  {{ $hqRisk = $country.riskLevel | default "unknown" }}
  {{ $riskLevels := (site.Data.jurisdictions.riskLevels | default dict) }}
  {{ $riskLabel = $hqRisk }}
  {{ with index $riskLevels $hqRisk }}
    {{ if .label }}{{ $riskLabel = .label }}{{ end }}
  {{ end }}
  {{ if eq $hqRisk "low" }}{{ $riskEmoji = "‚úÖ" }}{{ end }}
  {{ if eq $hqRisk "moderate" }}{{ $riskEmoji = "‚ö†Ô∏è" }}{{ end }}
  {{ if eq $hqRisk "elevated" }}{{ $riskEmoji = "üî∂" }}{{ end }}
  {{ if eq $hqRisk "high" }}{{ $riskEmoji = "üö®" }}{{ end }}
  {{ if eq $hqRisk "sanctioned" }}{{ $riskEmoji = "‚õî" }}{{ end }}
{{ end }}

<article class="max-w-full">
  {{/* Detail Header with breadcrumbs */}}
  {{ partial "common-detail-header.html" (dict
      "title" $displayTitle
      "description" .Description
      "flag" $countryFlag
      "breadcrumbs" (slice
          (dict "title" "Datacenters" "url" "/datacenters/")
      )
  ) }}

  {{/* Two-column layout */}}
  <section class="flex flex-col max-w-full mt-0 lg:flex-row">
    {{ $topClass := cond (hasPrefix site.Params.header.layout "fixed") "lg:top-[140px]" "lg:top-10" }}

    {{/* Right Sidebar */}}
    <div class="order-first px-0 lg:order-last lg:ps-8 lg:max-w-xs lg:min-w-[260px] lg:flex-shrink-0">
      <div class="print:hidden lg:sticky {{ $topClass }} space-y-4">

        {{/* Country Details Card */}}
        {{ if $country }}
        <div class="card bg-base-100 shadow-sm border border-base-300">
          <div class="card-body p-4">
            <h3 class="card-title text-sm font-semibold flex items-center gap-2">
              {{ partial "content-icon.html" (dict "name" "info" "color" "primary" "size" "4") }}
              Overview
            </h3>
            <dl class="mt-2 text-sm">
              {{/* Providers */}}
              <div class="flex justify-between py-1">
                <dt class="text-neutral-500 dark:text-neutral-400">Providers</dt>
                <dd class="font-medium">{{ len $providerItems }}</dd>
              </div>
              {{/* Total Regions */}}
              <div class="flex justify-between py-1">
                <dt class="text-neutral-500 dark:text-neutral-400">Total Regions</dt>
                <dd class="font-medium">{{ $totalRegions }}</dd>
              </div>
              {{/* Risk level */}}
              {{ if $riskEmoji }}
              <div class="flex justify-between py-1">
                <dt class="text-neutral-500 dark:text-neutral-400">Risk Level</dt>
                <dd class="font-medium">{{ $riskEmoji }} {{ $riskLabel | title }}</dd>
              </div>
              {{ end }}
            </dl>
          </div>
        </div>
        {{ end }}

        {{/* Jurisdiction Card */}}
        {{ if $lawsSlug }}
        <div class="card bg-base-100 shadow-sm border border-base-300">
          <div class="card-body p-4">
            <h3 class="card-title text-sm font-semibold flex items-center gap-2">
              {{ partial "content-icon.html" (dict "name" "scale" "color" "warning" "size" "4") }}
              Jurisdiction
            </h3>
            <div class="mt-2">
              <a href="/jurisdictions/{{ $lawsSlug }}/"
                 class="text-sm block px-2 py-1 -mx-2 rounded hover:bg-base-200 dark:hover:bg-neutral-800 no-underline">
                {{ if $countryFlag }}{{ $countryFlag }} {{ end }}{{ $countryName }} laws
              </a>
            </div>
          </div>
        </div>
        {{ end }}

        {{/* Providers sidebar section */}}
        {{ partial "datacenter-country-providers-sidebar.html" (dict "providerItems" $providerItems "countryName" $countryName "countryFlag" $countryFlag) }}

        {{/* Cities sidebar section */}}
        {{ partial "datacenter-country-cities-sidebar.html" (dict "countryId" $countryId "countryName" $countryName "countryFlag" $countryFlag "providers" $providers) }}

        {{/* Related content - laws, blog posts, publications based on country_id */}}
        {{ partial "related-content-sidebar.html" . }}

        {{/* Table of Contents */}}
        {{ $showToc := in .TableOfContents "<ul" }}
        {{ if $showToc }}
        <div class="mt-6">
          {{ partial "toc.html" . }}
        </div>
        {{ end }}

      </div>
    </div>

    {{/* Main Content */}}
    <div class="min-w-0 flex-1">
      <div class="article-content prose dark:prose-invert max-w-none mb-20">
        {{/* Render any custom markdown content first (like laws template does) */}}
        {{ .Content }}

        {{/* Always auto-generate the standard sections after custom content */}}
        {{ if $countryId }}
          <h2 id="map">Map</h2>
          {{ $mapShortcode := printf "{{< datacenter-map countries=\"%s\" showFilters=\"false\" >}}" $countryId }}
          {{ $mapShortcode | .Page.RenderString }}

          <h2 id="providers">Providers</h2>
          {{ partial "datacenter-country-providers-inline.html" (dict "countryId" $countryId "regionsById" $regionsById) }}

          <h2 id="regions">Regions</h2>
          {{ partial "datacenter-country-regions-inline.html" (dict "countryId" $countryId "regionsById" $regionsById) }}
        {{ end }}

        {{/* Back link */}}
        <hr class="mt-8">
        <p>
          <a href="/datacenters/">‚Üê Back to all datacenters</a>
        </p>
      </div>
    </div>

  </section>
</article>
{{ end }}
