{{ define "main" }}
  {{ .Scratch.Set "scope" "single" }}

  {{/* Resolve provider from slug or provider_id */}}
  {{ $slug := "" }}
  {{ with .File }}
    {{ $slug = strings.TrimSuffix "/" (strings.TrimPrefix "datacenters/" .Dir) }}
  {{ end }}

  {{ $providerId := .Params.provider_id | default $slug }}
  {{ $providers := site.Data.datacenters.providers | default (slice) }}
  {{ $provider := dict }}
  {{ range $providers }}
    {{ if eq .provider_id $providerId }}
      {{ $provider = . }}
    {{ end }}
  {{ end }}

  {{ $providerName := $provider.provider_name | default $providerId }}
  {{ $vendorCountryId := $provider.vendor_country_id | default "" }}

  {{/* Build region lookup */}}
  {{ $regionsById := dict }}
  {{ range (site.Data.regions | default (slice)) }}
    {{ $regionsById = merge $regionsById (dict .id .) }}
  {{ end }}

  {{/* Get vendor country info */}}
  {{ $vendorCountry := dict }}
  {{ $vendorFlag := "" }}
  {{ $vendorCountryName := "" }}
  {{ $vendorCountrySlug := "" }}
  {{ if $vendorCountryId }}
    {{ $vendorCountry = index $regionsById $vendorCountryId }}
    {{ if $vendorCountry }}
      {{ $vendorFlag = $vendorCountry.flag | default "" }}
      {{ $vendorCountryName = $vendorCountry.name | default $vendorCountryId }}
      {{ $vendorCountrySlug = $vendorCountry.slug | default "" }}
    {{ end }}
  {{ end }}

  {{/* Auto-generate title */}}
  {{ $autoTitle := printf "%s Datacenters" $providerName }}
  {{ $displayTitle := .Title }}
  {{ if or (not .Title) (eq .Title "Index") (eq .Title "") }}
    {{ $displayTitle = $autoTitle }}
  {{ end }}

  <article>
    <header id="single_header" class="mt-5 max-w-prose">
      {{ if .Params.showBreadcrumbs | default (site.Params.article.showBreadcrumbs | default false) }}
        {{ partial "breadcrumbs.html" . }}
      {{ end }}
      <h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">
        {{ $displayTitle | emojify }}
      </h1>
      <div class="mt-1 mb-4 text-base text-neutral-500 dark:text-neutral-400 print:hidden">
        {{ partial "article-meta/basic.html" (dict "context" . "scope" "single") }}
      </div>
    </header>

    {{/* Body with right sidebar */}}
    <section class="flex flex-col max-w-full mt-0 lg:flex-row">
      {{ $enableToc := site.Params.article.showTableOfContents | default false }}
      {{ $enableToc = .Params.showTableOfContents | default $enableToc }}
      {{ $showToc := and $enableToc (in .TableOfContents "<ul") }}
      {{ $topClass := cond (hasPrefix site.Params.header.layout "fixed") "lg:top-[140px]" "lg:top-10" }}

      {{/* Count regions by country for sidebar */}}
      {{ $countryCounts := dict }}
      {{ $providerRegions := $provider.regions | default (slice) }}
      {{ range $providerRegions }}
        {{ $countryId := .country_id }}
        {{ $existing := index $countryCounts $countryId | default 0 }}
        {{ $countryCounts = merge $countryCounts (dict $countryId (add $existing 1)) }}
      {{ end }}

      {{/* Calculate risk info for sidebar */}}
      {{ $hqRisk := "unknown" }}
      {{ $riskLabel := "" }}
      {{ $riskEmoji := "" }}
      {{ $blocNames := slice }}
      {{ if $vendorCountry }}
        {{ $hqRisk = $vendorCountry.risk_level | default "unknown" }}
        {{ $riskLevels := (site.Data.jurisdictions.risk_levels | default dict) }}
        {{ $riskLabel = $hqRisk }}
        {{ with index $riskLevels $hqRisk }}
          {{ if .label }}{{ $riskLabel = .label }}{{ end }}
        {{ end }}
        {{ if eq $hqRisk "low" }}{{ $riskEmoji = "‚úÖ" }}{{ end }}
        {{ if eq $hqRisk "moderate" }}{{ $riskEmoji = "‚ö†Ô∏è" }}{{ end }}
        {{ if eq $hqRisk "elevated" }}{{ $riskEmoji = "üî∂" }}{{ end }}
        {{ if eq $hqRisk "high" }}{{ $riskEmoji = "üö®" }}{{ end }}
        {{ if eq $hqRisk "sanctioned" }}{{ $riskEmoji = "‚õî" }}{{ end }}
        {{/* Get bloc names */}}
        {{ $blocsById := dict }}
        {{ range (site.Data.jurisdictions.blocs | default (slice)) }}
          {{ $blocsById = merge $blocsById (dict .id .) }}
        {{ end }}
        {{ range ($vendorCountry.blocs | default (slice)) }}
          {{ $b := index $blocsById . }}
          {{ if $b }}
            {{ $blocNames = $blocNames | append $b.name }}
          {{ end }}
        {{ end }}
      {{ end }}

      {{ $showSidebar := or $showToc (gt (len $countryCounts) 0) }}
      {{ if $showSidebar }}
        <div class="order-first lg:ml-auto px-0 lg:order-last lg:ps-8 lg:max-w-2xs">
          <div class="toc ps-5 print:hidden lg:sticky {{ $topClass }}">
            {{ if $showToc }}
              {{ partial "toc.html" . }}
            {{ end }}

            {{/* Provider Info sidebar - at top */}}
            {{ if $provider }}
              <div class="{{ if $showToc }}mt-6{{ end }}">
                <div class="text-lg font-semibold text-neutral-800 dark:text-neutral-100">{{ $providerName }}</div>
                <div class="min-w-[220px] py-2 border-dotted border-s-1 -ms-5 ps-5 dark:border-neutral-600">
                  <ul class="m-0 p-0 list-none space-y-1.5 text-sm">
                    {{/* HQ */}}
                    <li class="m-0 p-0 flex items-center gap-2">
                      <span class="text-neutral-500 dark:text-neutral-400 w-20">HQ</span>
                      <span class="font-medium">{{ if $vendorFlag }}{{ $vendorFlag }} {{ end }}{{ $vendorCountryName }}</span>
                    </li>
                    {{/* Regions */}}
                    <li class="m-0 p-0 flex items-center gap-2">
                      <span class="text-neutral-500 dark:text-neutral-400 w-20">Regions</span>
                      <span class="font-medium">{{ len $providerRegions }}</span>
                    </li>
                  </ul>
                </div>
                {{/* Jurisdiction button */}}
                {{ if $vendorCountrySlug }}
                <div class="mt-4">
                  {{ partial "internal-button.html" (dict "url" (printf "/jurisdictions/%s/" $vendorCountrySlug) "icon" "‚öñÔ∏è" "label" "Jurisdiction") }}
                </div>
                {{ end }}
                {{/* Website button */}}
                {{ if $provider.vendor_website }}
                <div class="mt-3">
                  {{ partial "external-button.html" (dict "url" $provider.vendor_website "label" "Website") }}
                </div>
                {{ end }}
                {{/* Data updated */}}
                {{ if $provider.updated }}
                <div class="mt-2 text-xs italic text-neutral-500 dark:text-neutral-400">
                  Data updated {{ $provider.updated }}
                </div>
                {{ end }}
              </div>

            {{ end }}

            {{/* Countries sidebar */}}
            {{ if gt (len $countryCounts) 0 }}
              <div class="mt-6">
                <div class="text-lg font-semibold text-neutral-800 dark:text-neutral-100">Countries</div>
                <div class="text-sm text-neutral-500 dark:text-neutral-400">{{ len $countryCounts }} countries, {{ len $providerRegions }} regions</div>
                <div class="min-w-[220px] py-2 border-dotted border-s-1 -ms-5 ps-5 dark:border-neutral-600">
                  <ul class="m-0 p-0 list-none space-y-1">
                    {{/* Sort countries by count descending */}}
                    {{ $countryItems := slice }}
                    {{ range $countryId, $count := $countryCounts }}
                      {{ $c := index $regionsById $countryId }}
                      {{ $name := $countryId }}
                      {{ $flag := "" }}
                      {{ if $c }}
                        {{ $name = $c.name | default $countryId }}
                        {{ $flag = $c.flag | default "" }}
                      {{ end }}
                      {{ $countryItems = $countryItems | append (dict "id" $countryId "name" $name "flag" $flag "count" $count) }}
                    {{ end }}
                    {{ $countryItems = sort $countryItems "count" "desc" }}
                    {{ range $countryItems }}
                      <li class="m-0 p-0">
                        {{ if .flag }}<span class="mr-1">{{ .flag }}</span>{{ end -}}
                        <span>{{ .name }}</span>
                        <span class="text-neutral-500 dark:text-neutral-400">({{ .count }})</span>
                      </li>
                    {{ end }}
                  </ul>
                </div>
              </div>
            {{ end }}

            {{/* Compare - other providers in same category */}}
            {{ $providerType := $provider.provider_type | default "" }}
            {{ if $providerType }}
              {{ $sameTypeProviders := slice }}
              {{ range $providers }}
                {{ if and (eq .provider_type $providerType) (ne .provider_id $providerId) }}
                  {{ $regionCount := len (.regions | default (slice)) }}
                  {{ $sameTypeProviders = $sameTypeProviders | append (dict "provider_id" .provider_id "provider_name" .provider_name "region_count" $regionCount) }}
                {{ end }}
              {{ end }}
              {{ if gt (len $sameTypeProviders) 0 }}
                {{ $sameTypeProviders = sort $sameTypeProviders "region_count" "desc" }}
                <div class="mt-6">
                  <div class="text-lg font-semibold text-neutral-800 dark:text-neutral-100">Compare</div>
                  <div class="text-sm text-neutral-500 dark:text-neutral-400">Other providers in the same category</div>
                  <div class="min-w-[220px] py-2 border-dotted border-s-1 -ms-5 ps-5 dark:border-neutral-600">
                    <ul class="m-0 p-0 list-none space-y-1">
                      {{ range $sameTypeProviders }}
                        <li class="m-0 p-0">
                          <a href="/datacenters/{{ .provider_id }}/"
                             class="no-underline hover:text-primary-600 dark:hover:text-primary-400">
                            {{ .provider_name }}
                          </a>
                          <span class="text-neutral-500 dark:text-neutral-400">({{ .region_count }})</span>
                        </li>
                      {{ end }}
                    </ul>
                  </div>
                </div>
              {{ end }}
            {{ end }}
          </div>
        </div>
      {{ end }}

      <div class="min-w-0 min-h-0 flex-1">
        <div class="article-content prose dark:prose-invert max-w-full mb-20">
          {{/* Check if there's any custom content in the markdown file */}}
          {{ $rawContent := .RawContent | strings.TrimSpace }}
          {{ $hasCustomContent := gt (len $rawContent) 0 }}

          {{/* Render any custom content first */}}
          {{ if $hasCustomContent }}
            {{ .Content }}
          {{ end }}

          {{/* Always auto-generate the standard sections */}}
          {{ if $provider }}
            <h2 id="map">Map</h2>
            {{ $mapShortcode := printf "{{< datacenter-map providers=\"%s\" showFilters=\"false\" >}}" $providerId }}
            {{ $mapShortcode | .Page.RenderString }}

            <h2 id="locations">Locations by Country</h2>
            {{ partial "datacenter-provider-locations-inline.html" (dict "provider" $provider "regionsById" $regionsById) }}

            <p>‚Üí <a href="/datacenters/">Back to all providers</a></p>
          {{ end }}
        </div>
      </div>
    </section>
  </article>
{{ end }}
