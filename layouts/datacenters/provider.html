{{ define "main" }}
{{ .Scratch.Set "scope" "single" }}

{{/* Read all data from page params (frontmatter) */}}
{{ $providerId := .Params.provider_id | default "" }}
{{ $providerName := .Params.provider_name | default $providerId }}
{{ $providerUrl := .Params.provider_url | default "" }}
{{ $providerType := .Params.provider_type | default "" }}
{{ $dateModified := .Params.date_modified | default "" }}
{{ $totalRegions := .Params.total_regions | default 0 }}
{{ $totalCountries := .Params.total_countries | default 0 }}
{{ $regions := .Params.regions | default (slice) }}

{{ $vendorCountryId := .Params.vendor_country_id | default "" }}
{{ $vendorCountryName := .Params.vendor_country_name | default $vendorCountryId }}
{{ $vendorCountryFlag := .Params.vendor_country_flag | default "" }}
{{ $vendorCountrySlug := .Params.vendor_country_slug | default "" }}
{{ $vendorRisk := .Params.vendor_risk | default "unknown" }}

{{/* Build region lookup for locations display */}}
{{ $countriesById := dict }}
{{ range (site.Data.countries.countries.itemListElement | default (slice)) }}
  {{ $countriesById = merge $countriesById (dict .identifier .) }}
{{ end }}

{{/* Build provider dict for partials that expect it */}}
{{ $provider := dict
    "identifier" $providerId
    "name" $providerName
    "url" $providerUrl
    "providerType" $providerType
    "dateModified" $dateModified
    "vendorCountryId" $vendorCountryId
    "regions" $regions
}}

{{/* Build vendor country dict for partials */}}
{{ $vendorCountry := dict
    "identifier" $vendorCountryId
    "name" $vendorCountryName
    "flag" $vendorCountryFlag
    "slug" $vendorCountrySlug
    "riskLevel" $vendorRisk
}}

{{/* Get full vendor country from regions for bloc info */}}
{{ if $vendorCountryId }}
  {{ with index $countriesById $vendorCountryId }}
    {{ $vendorCountry = . }}
  {{ end }}
{{ end }}

{{/* Auto-generate title */}}
{{ $displayTitle := .Title }}
{{ if or (not .Title) (eq .Title "Index") (eq .Title "") }}
  {{ $displayTitle = printf "%s Datacenters" $providerName }}
{{ end }}

<article class="max-w-full">
  {{/* Detail Header with breadcrumbs */}}
  {{ partial "common-detail-header.html" (dict
      "title" $displayTitle
      "description" .Description
      "icon" "server"
      "breadcrumbs" (slice
          (dict "title" "Datacenters" "url" "/datacenters/")
      )
  ) }}

  {{/* Two-column layout */}}
  <section class="flex flex-col max-w-full mt-0 lg:flex-row">
    {{ $topClass := cond (hasPrefix site.Params.header.layout "fixed") "lg:top-[140px]" "lg:top-10" }}

    {{/* Right Sidebar */}}
    <div class="order-first px-0 lg:order-last lg:ps-8 lg:max-w-xs lg:min-w-[260px] lg:flex-shrink-0">
      <div class="print:hidden lg:sticky {{ $topClass }} space-y-4">

        {{/* External link button */}}
        {{ with $providerUrl }}
        <a class="btn btn-primary btn-outline w-full gap-2"
           href="{{ . }}"
           target="_blank"
           rel="noopener noreferrer">
          {{ partial "content-icon.html" (dict "name" "external" "size" "4") }}
          Visit website
        </a>
        {{ end }}

        {{/* Provider Details Card */}}
        {{ partial "sidebar/datacenter-provider-details-card.html" (dict "provider" $provider "vendorCountry" $vendorCountry) }}

        {{/* Risk Assessment Card */}}
        {{ partial "sidebar/jurisdiction-risk-card.html" (dict "countryId" $vendorCountryId) }}

        {{/* Jurisdiction Memberships Card */}}
        {{ partial "sidebar/jurisdiction-memberships-card.html" (dict "countryId" $vendorCountryId) }}

        {{/* Laws by Type Card */}}
        {{ partial "sidebar/jurisdiction-laws-card.html" (dict "countryId" $vendorCountryId) }}

        {{/* Countries Card */}}
        {{ partial "sidebar/datacenter-provider-countries-card.html" (dict "provider" $provider "regionsById" $countriesById) }}

        {{/* Compare Card */}}
        {{ $allProviders := site.Data.datacenters.datacenters | default (slice) }}
        {{ partial "sidebar/datacenter-provider-compare-card.html" (dict "provider" $provider "allProviders" $allProviders) }}

        {{/* Related content */}}
        {{ partial "related-content-sidebar.html" . }}

        {{/* Table of Contents */}}
        {{ $showToc := in .TableOfContents "<ul" }}
        {{ if $showToc }}
        <div class="mt-6">
          {{ partial "toc.html" . }}
        </div>
        {{ end }}

      </div>
    </div>

    {{/* Main Content */}}
    <div class="min-w-0 flex-1">
      <div class="article-content prose dark:prose-invert max-w-none mb-20">

        {{/* Map */}}
        {{ $mapShortcode := printf "{{< datacenter-map providers=\"%s\" showFilters=\"false\" >}}" $providerId }}
        {{ $mapShortcode | .Page.RenderString }}

        {{/* Locations */}}
        <h2 id="locations">Locations by Country</h2>
        {{ partial "datacenter-provider-locations-inline.html" (dict "provider" $provider "regionsById" $countriesById) }}

        {{/* Laws */}}
        <h2 id="laws">Laws in provider jurisdiction</h2>
        {{ partial "datacenter-provider-laws-inline.html" (dict "vendorCountryId" $vendorCountryId "vendorCountry" $vendorCountry) }}

        {{/* Render any custom markdown content */}}
        {{ if .Content }}
        <hr class="mt-8">
        {{ .Content }}
        {{ end }}

        {{/* Back link */}}
        <hr class="mt-8">
        <p>
          <a href="/datacenters/">‚Üê Back to all providers</a>
        </p>
      </div>
    </div>

  </section>
</article>
{{ end }}
