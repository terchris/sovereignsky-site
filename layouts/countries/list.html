{{ define "main" }}
<article class="max-w-full">
  {{/* Section Header */}}
  {{ partial "section-header.html" (dict
      "title" .Title
      "description" .Description
      "icon" "globe"
  ) }}

  {{/* Section Content - render markdown content which includes map shortcode */}}
  <section class="max-w-full mt-6 prose dark:prose-invert prose-table:w-full prose-img:max-w-full [&>*]:max-w-none">
    {{ .Content }}
  </section>

  {{/* Country List */}}
  <section class="mt-8">
    {{/* Build country data with datacenter and law counts */}}
    {{ $countries := site.Data.countries.countries.itemListElement | default (slice) }}
    {{ $countryData := slice }}

    {{ range $countries }}
      {{ $country := . }}
      {{ $countryId := .identifier }}

      {{/* Count datacenters for this country */}}
      {{ $dcCount := 0 }}
      {{ range (site.Data.datacenters.datacenters | default (slice)) }}
        {{ range (.regions | default (slice)) }}
          {{ if eq .countryId $countryId }}
            {{ $dcCount = add $dcCount 1 }}
          {{ end }}
        {{ end }}
      {{ end }}

      {{/* Count local laws for this country */}}
      {{ $lawCount := 0 }}
      {{ range (site.Data.laws.laws.itemListElement | default (slice)) }}
        {{ if in .legislationJurisdiction $countryId }}
          {{ $lawCount = add $lawCount 1 }}
        {{ end }}
      {{ end }}

      {{ $countryData = $countryData | append (dict
        "identifier" $countryId
        "name" $country.name
        "flag" $country.flag
        "slug" $country.slug
        "dcCount" $dcCount
        "lawCount" $lawCount
      ) }}
    {{ end }}

    {{/* Sort by country name */}}
    {{ $countryData = sort $countryData "name" "asc" }}

    <div class="not-prose grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-2">
      {{ range $countryData }}
      <a href="/countries/{{ .slug }}/" class="block p-2.5 rounded-lg border border-base-200 hover:border-primary/50 hover:bg-base-100 transition-all no-underline">
        <div class="flex items-center gap-2">
          <span class="text-lg flex-shrink-0">{{ .flag }}</span>
          <span class="text-sm font-medium text-base-content truncate">{{ .name }}</span>
        </div>
        <div class="text-xs text-neutral-500 dark:text-neutral-400 mt-1.5 space-y-0.5">
          <div>Datacenters: {{ .dcCount }}</div>
          <div>Local laws: {{ .lawCount }}</div>
        </div>
      </a>
      {{ end }}
    </div>
  </section>
</article>
{{ end }}
