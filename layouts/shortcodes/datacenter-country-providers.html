{{/*
Datacenter Country Providers list
Usage: {{< datacenter-country-providers country="DE" >}}

Renders provider chips for providers with regions in a specific country.
Shows the count of regions in THAT country (not total regions).
*/}}

{{ $countryId := .Get "country" }}
{{ $datacenters := site.Data.datacenters }}
{{ $countries := site.Data.countries.countries.itemListElement }}

{{/* Build countries lookup by id */}}
{{ $countriesById := dict }}
{{ range $countries }}
{{ $countriesById = merge $countriesById (dict .identifier .) }}
{{ end }}

{{ $allProviders := $datacenters.datacenters | default (slice) }}

{{/* Filter providers that have regions in this country and count regions per provider */}}
{{ $providersInCountry := slice }}
{{ range $allProviders }}
  {{ $provider := . }}
  {{ $countInCountry := 0 }}
  {{ range .regions }}
    {{ if eq .countryId $countryId }}
      {{ $countInCountry = add $countInCountry 1 }}
    {{ end }}
  {{ end }}
  {{ if gt $countInCountry 0 }}
    {{ $providersInCountry = $providersInCountry | append (dict
      "identifier" $provider.identifier
      "name" $provider.name
      "providerType" $provider.providerType
      "vendorCountryId" $provider.vendorCountryId
      "count_in_country" $countInCountry
    ) }}
  {{ end }}
{{ end }}

{{/* Output heading with total count */}}
{{ if gt (len $providersInCountry) 0 }}
<h2 id="providers" class="group">Providers ({{ len $providersInCountry }})</h2>
{{ end }}

{{/* Group providers by provider_type */}}
{{ $groups := slice
  (dict "key" "hyperscaler" "title" "Hyperscalers")
  (dict "key" "regional_cloud" "title" "Regional cloud providers")
  (dict "key" "datacenter_operator" "title" "Datacenter operators")
}}

{{ range $groups }}
  {{ $key := .key }}
  {{ $title := .title }}
  {{ $items := where $providersInCountry "providerType" $key }}
  {{/* Sort by count desc, then name asc */}}
  {{ $items = sort $items "name" "asc" }}
  {{ $items = sort $items "count_in_country" "desc" }}
  {{ if gt (len $items) 0 }}
  <h3 class="mt-6 mb-2 text-sm font-semibold text-neutral-700 dark:text-neutral-200">{{ $title }}</h3>
  <div class="flex flex-wrap gap-2">
    {{ range $items }}
    {{ $vendor := index $countriesById .vendorCountryId }}
    {{ $flag := "" }}
    {{ $vendorName := .vendorCountryId }}
    {{ $risk := "unknown" }}
    {{ if $vendor }}
      {{ $flag = $vendor.flag }}
      {{ $vendorName = $vendor.name }}
      {{ $risk = $vendor.riskLevel }}
    {{ end }}

    {{/* small colored dot by risk */}}
    {{ $dot := "bg-neutral-400" }}
    {{ if eq $risk "low" }}{{ $dot = "bg-green-500" }}{{ end }}
    {{ if eq $risk "moderate" }}{{ $dot = "bg-yellow-500" }}{{ end }}
    {{ if eq $risk "elevated" }}{{ $dot = "bg-orange-500" }}{{ end }}
    {{ if eq $risk "high" }}{{ $dot = "bg-red-500" }}{{ end }}
    {{ if eq $risk "sanctioned" }}{{ $dot = "bg-red-700" }}{{ end }}

    <a class="inline-flex items-center gap-2 no-underline px-3 py-1 rounded-full border border-neutral-200 dark:border-neutral-700 bg-white dark:bg-neutral-900 hover:border-primary-400 dark:hover:border-primary-500 transition-colors text-sm"
      href="/datacenters/{{ .identifier }}/"
      title="Type: {{ .providerType }} • HQ: {{ $vendorName }} ({{ .vendorCountryId }}) • Risk: {{ $risk }} • Regions in country: {{ .count_in_country }}">
      <span class="inline-block w-2 h-2 rounded-full {{ $dot }}"></span>
      <span class="font-medium">{{ .name }}</span>
      <span class="text-neutral-500 dark:text-neutral-400">
        {{ if $flag }}{{ $flag }}{{ end }} {{ .count_in_country }}
      </span>
    </a>
    {{ end }}
  </div>
  {{ end }}
{{ end }}
