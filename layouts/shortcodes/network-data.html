{{/* 
  network-data shortcode
  Renders Networks page sections from data/networks/networks.json (+ data/networks/networks-actors.json for owner display).
*/}}

{{ $networksRoot := site.Data.networks | default dict }}
{{ $networks := (index $networksRoot "networks") | default dict }}
{{ $actorsData := (index $networksRoot "networks-actors") | default dict }}
{{ $actors := (index $actorsData "actors") | default (slice) }}

{{ $placesData := (index $networksRoot "networks-places") | default dict }}
{{ $places := (index $placesData "places") | default (slice) }}
{{ $connections := (index $networks "connections") | default (slice) }}
{{ $operators := (index $networks "operators") | default (slice) }}

{{/* Build lookups */}}
{{ $s := newScratch }}
{{ $s.Set "actorById" (dict) }}
{{ range $actors }}
  {{ $actor := . }}
  {{ with $actor.actor_id }}{{ $s.SetInMap "actorById" . $actor }}{{ end }}
{{ end }}

{{ $s.Set "placeById" (dict) }}
{{ range $places }}
  {{ $pl := . }}
  {{ with $pl.identifier }}{{ $s.SetInMap "placeById" . $pl }}{{ end }}
{{ end }}

{{ $s.Set "operatorById" (dict) }}
{{ range $operators }}
  {{ $op := . }}
  {{ with $op.operator_id }}{{ $s.SetInMap "operatorById" . $op }}{{ end }}
{{ end }}

{{/* Helpers (inline) */}}
{{ $statusLabel := dict "active" "âœ… Active" "planned" "ðŸ”¶ Planned" }}
{{ $ownershipLabel := dict "private" "Commercial" "state_owned" "State-owned" "consortium" "Consortium" "project" "Project" }}

{{ $actorById := $s.Get "actorById" }}
{{ $placeById := $s.Get "placeById" }}
{{ $operatorById := $s.Get "operatorById" }}

{{ $internationalSubsea := where (where $connections "scope" "international") "map_category" "subsea" }}
{{ $internationalTerrestrial := where (where $connections "scope" "international") "map_category" "terrestrial" }}
{{ $domesticCables := where $connections "map_category" "domestic" }}

{{ $arcticCables := where $connections "connection_id" "in" (slice "svalbard-undersea" "arctic-way" "longyearbyen-ny-alesund") }}

<div class="space-y-10">
  <section>
    <h3 class="text-xl font-semibold">Subsea (Outside Norway)</h3>
    <p class="text-sm text-neutral-600 dark:text-neutral-300">International subsea systems with Norway landings (from <code>data/networks.json</code>).</p>
    <div class="mt-3 overflow-x-auto">
      <table class="min-w-full text-sm">
        <thead class="text-left">
          <tr class="border-b border-neutral-200 dark:border-neutral-700">
            <th class="py-2 pr-4">System</th>
            <th class="py-2 pr-4">Status</th>
            <th class="py-2 pr-4">Route</th>
            <th class="py-2">Owners</th>
          </tr>
        </thead>
        <tbody>
          {{ range sort $internationalSubsea "connection_name" "asc" }}
            {{ $id := .connection_id }}
            {{ $page := site.GetPage (printf "/networks/%s" $id) }}
            {{ $owners := (slice) }}
            {{ range (.owner_actor_ids | default (slice)) }}
              {{ $a := index $actorById . }}
              {{ if $a }}
                {{ $owners = $owners | append (printf "%s%s" ($a.actor_name | default .) (cond (ne ($a.country_id | default "") "") (printf " (%s)" $a.country_id) "")) }}
              {{ else }}
                {{ $owners = $owners | append . }}
              {{ end }}
            {{ end }}

            {{ $routeNames := (slice) }}
            {{ range (.endpoint_place_ids | default (slice)) }}
              {{ $pl := index $placeById . }}
              {{ if $pl }}
                {{ $routeNames = $routeNames | append ($pl.name | default .) }}
              {{ else }}
                {{ $routeNames = $routeNames | append . }}
              {{ end }}
            {{ end }}
            <tr class="border-b border-neutral-100 dark:border-neutral-800">
              <td class="py-2 pr-4 font-medium">
                {{ if $page }}
                  <a class="hover:underline" href="{{ $page.RelPermalink }}">{{ .connection_name }}</a>
                {{ else }}
                  {{ .connection_name }}
                {{ end }}
              </td>
              <td class="py-2 pr-4">{{ index $statusLabel (.status | default "active") | default (.status | default "active") }}</td>
              <td class="py-2 pr-4">{{ delimit $routeNames " â†” " }}</td>
              <td class="py-2">{{ if gt (len $owners) 0 }}{{ delimit $owners ", " }}{{ else }}â€”{{ end }}</td>
            </tr>
          {{ end }}
        </tbody>
      </table>
    </div>
    <p class="mt-2 text-xs text-neutral-500 dark:text-neutral-400">Count: {{ len $internationalSubsea }}</p>
  </section>

  <section>
    <h3 class="text-xl font-semibold">Terrestrial (Outside Norway)</h3>
    <p class="text-sm text-neutral-600 dark:text-neutral-300">Schematic cross-border terrestrial corridors and other non-subsea external connectivity (from <code>data/networks.json</code>).</p>

    <div class="mt-3 overflow-x-auto">
      <table class="min-w-full text-sm">
        <thead class="text-left">
          <tr class="border-b border-neutral-200 dark:border-neutral-700">
            <th class="py-2 pr-4">Connection</th>
            <th class="py-2 pr-4">Status</th>
            <th class="py-2 pr-4">Route</th>
            <th class="py-2">Notes</th>
          </tr>
        </thead>
        <tbody>
          {{ range sort $internationalTerrestrial "connection_name" "asc" }}
            {{ $id := .connection_id }}
            {{ $page := site.GetPage (printf "/networks/%s" $id) }}
            {{ $routeNames := (slice) }}
            {{ range (.endpoint_place_ids | default (slice)) }}
              {{ $pl := index $placeById . }}
              {{ if $pl }}
                {{ $routeNames = $routeNames | append ($pl.name | default .) }}
              {{ else }}
                {{ $routeNames = $routeNames | append . }}
              {{ end }}
            {{ end }}
            <tr class="border-b border-neutral-100 dark:border-neutral-800">
              <td class="py-2 pr-4 font-medium">
                {{ if $page }}
                  <a class="hover:underline" href="{{ $page.RelPermalink }}">{{ .connection_name }}</a>
                {{ else }}
                  {{ .connection_name }}
                {{ end }}
              </td>
              <td class="py-2 pr-4">{{ index $statusLabel (.status | default "active") | default (.status | default "active") }}</td>
              <td class="py-2 pr-4">{{ if gt (len $routeNames) 0 }}{{ delimit $routeNames " â†” " }}{{ else }}â€”{{ end }}</td>
              <td class="py-2">{{ .description | default "â€”" }}</td>
            </tr>
          {{ end }}
        </tbody>
      </table>
    </div>
    <p class="mt-2 text-xs text-neutral-500 dark:text-neutral-400">Count: {{ len $internationalTerrestrial }}</p>
  </section>

  <section>
    <h3 class="text-xl font-semibold">Domestic (Inside Norway)</h3>
    <p class="text-sm text-neutral-600 dark:text-neutral-300">Domestic systems we can reference from public sources (from <code>data/networks.json</code>).</p>

    <div class="mt-3 overflow-x-auto">
      <table class="min-w-full text-sm">
        <thead class="text-left">
          <tr class="border-b border-neutral-200 dark:border-neutral-700">
            <th class="py-2 pr-4">System</th>
            <th class="py-2 pr-4">Status</th>
            <th class="py-2 pr-4">Medium</th>
            <th class="py-2">Operators</th>
          </tr>
        </thead>
        <tbody>
          {{ range sort $domesticCables "connection_name" "asc" }}
            {{ $id := .connection_id }}
            {{ $page := site.GetPage (printf "/networks/%s" $id) }}
            {{ $opNames := (slice) }}
            {{ range (.operator_ids | default (slice)) }}
              {{ $oid := . }}
              {{ $op := index $operatorById $oid }}
              {{ $a := cond (and $op $op.actor_id) (index $actorById $op.actor_id) nil }}
              {{ $opNames = $opNames | append (cond $a ($a.actor_name | default $oid) (cond $op ($op.operator_name | default $oid) $oid)) }}
            {{ end }}
            <tr class="border-b border-neutral-100 dark:border-neutral-800">
              <td class="py-2 pr-4 font-medium">
                {{ if $page }}
                  <a class="hover:underline" href="{{ $page.RelPermalink }}">{{ .connection_name }}</a>
                {{ else }}
                  {{ .connection_name }}
                {{ end }}
              </td>
              <td class="py-2 pr-4">{{ index $statusLabel (.status | default "active") | default (.status | default "active") }}</td>
              <td class="py-2 pr-4">{{ .medium | default "â€”" }}</td>
              <td class="py-2">{{ if gt (len $opNames) 0 }}{{ delimit $opNames ", " }}{{ else }}â€”{{ end }}</td>
            </tr>
          {{ end }}
        </tbody>
      </table>
    </div>
    <p class="mt-2 text-xs text-neutral-500 dark:text-neutral-400">Count: {{ len $domesticCables }}</p>
  </section>

  <section>
    <h3 class="text-xl font-semibold">Arctic connectivity</h3>
    <p class="text-sm text-neutral-600 dark:text-neutral-300">A small subset highlighted for Arctic relevance (from <code>data/networks.json</code>).</p>
    <div class="mt-3 overflow-x-auto">
      <table class="min-w-full text-sm">
        <thead class="text-left">
          <tr class="border-b border-neutral-200 dark:border-neutral-700">
            <th class="py-2 pr-4">System</th>
            <th class="py-2 pr-4">Status</th>
            <th class="py-2">Notes</th>
          </tr>
        </thead>
        <tbody>
          {{ range sort $arcticCables "connection_name" "asc" }}
            {{ $id := .connection_id }}
            {{ $page := site.GetPage (printf "/networks/%s" $id) }}
            <tr class="border-b border-neutral-100 dark:border-neutral-800">
              <td class="py-2 pr-4 font-medium">
                {{ if $page }}
                  <a class="hover:underline" href="{{ $page.RelPermalink }}">{{ .connection_name }}</a>
                {{ else }}
                  {{ .connection_name }}
                {{ end }}
              </td>
              <td class="py-2 pr-4">{{ index $statusLabel (.status | default "active") | default (.status | default "active") }}</td>
              <td class="py-2">{{ .description | default "â€”" }}</td>
            </tr>
          {{ end }}
        </tbody>
      </table>
    </div>
  </section>

  <hr class="border-neutral-200 dark:border-neutral-700" />

  <section>
    <h2 class="text-2xl font-bold">Major Operators</h2>
    <p class="text-sm text-neutral-600 dark:text-neutral-300">Rendered from <code>networks.operators[]</code> and linked to systems where possible.</p>
    <div class="mt-3 overflow-x-auto">
      <table class="min-w-full text-sm">
        <thead class="text-left">
          <tr class="border-b border-neutral-200 dark:border-neutral-700">
            <th class="py-2 pr-4">Operator</th>
            <th class="py-2 pr-4">Type</th>
            <th class="py-2">Key infrastructure</th>
          </tr>
        </thead>
        <tbody>
          {{ range sort $operators "operator_name" "asc" }}
            {{ $actor := cond (and .actor_id (index $actorById .actor_id)) (index $actorById .actor_id) nil }}
            {{ $displayName := cond $actor ($actor.actor_name | default .operator_id) (.operator_name | default .operator_id) }}
            {{ $displayUrl := cond $actor ($actor.website | default "") (.website | default "") }}
            {{ $infra := (slice) }}
            {{ range (.connection_ids | default (slice)) }}
              {{ $cid := . }}
              {{ $c := first 1 (where $connections "connection_id" $cid) }}
              {{ $cable := cond (gt (len $c) 0) (index $c 0) nil }}
              {{ $cName := cond $cable ($cable.connection_name | default $cid) $cid }}
              {{ $p := site.GetPage (printf "/networks/%s" $cid) }}
              {{ if $p }}
                {{ $infra = $infra | append (printf "<a class=\"hover:underline\" href=\"%s\">%s</a>" $p.RelPermalink $cName) }}
              {{ else }}
                {{ $infra = $infra | append $cName }}
              {{ end }}
            {{ end }}
            <tr class="border-b border-neutral-100 dark:border-neutral-800">
              <td class="py-2 pr-4 font-medium">
                {{ if $displayUrl }}
                  <a class="hover:underline" href="{{ $displayUrl }}" target="_blank" rel="noreferrer">{{ $displayName }}</a>
                {{ else }}
                  {{ $displayName }}
                {{ end }}
              </td>
              <td class="py-2 pr-4">{{ index $ownershipLabel (.ownership_type | default "") | default (.ownership_type | default "â€”") }}</td>
              <td class="py-2">{{ if gt (len $infra) 0 }}{{ delimit $infra ", " | safeHTML }}{{ else }}â€”{{ end }}</td>
            </tr>
          {{ end }}
        </tbody>
      </table>
    </div>
  </section>
</div>


