{{/* Display bloc cards for the countries section */}}
{{ $blocs := site.Data.blocs.blocs.itemListElement | default (slice) }}

{{/* Build blocs lookup */}}
{{ $blocsById := dict }}
{{ range $blocs }}
  {{ $blocsById = merge $blocsById (dict .identifier .) }}
{{ end }}

{{/* Build bloc data with counts */}}
{{ $blocData := slice }}
{{ range $blocs }}
  {{ $bloc := . }}
  {{ $directMembers := .memberOf | default .members | default (slice) }}
  {{ $memberCount := len $directMembers }}

  {{/* Count inherited members */}}
  {{ $allMembers := $directMembers }}
  {{ range (.inheritsFrom | default (slice)) }}
    {{ $parent := index $blocsById . }}
    {{ if $parent }}
      {{ range ($parent.memberOf | default $parent.members | default (slice)) }}
        {{ if not (in $allMembers .) }}
          {{ $allMembers = $allMembers | append . }}
        {{ end }}
      {{ end }}
      {{ range ($parent.inheritsFrom | default (slice)) }}
        {{ $grandparent := index $blocsById . }}
        {{ if $grandparent }}
          {{ range ($grandparent.memberOf | default $grandparent.members | default (slice)) }}
            {{ if not (in $allMembers .) }}
              {{ $allMembers = $allMembers | append . }}
            {{ end }}
          {{ end }}
        {{ end }}
      {{ end }}
    {{ end }}
  {{ end }}

  {{ $totalMembers := len $allMembers }}

  {{/* Count datacenters */}}
  {{ $dcCount := 0 }}
  {{ range (site.Data.datacenters.datacenters | default (slice)) }}
    {{ range (.regions | default (slice)) }}
      {{ if in $allMembers .countryId }}
        {{ $dcCount = add $dcCount 1 }}
      {{ end }}
    {{ end }}
  {{ end }}

  {{ $blocData = $blocData | append (dict
    "identifier" $bloc.identifier
    "name" $bloc.name
    "flag" $bloc.flag
    "slug" ($bloc.slug | default $bloc.identifier)
    "riskLevel" $bloc.riskLevel
    "memberCount" $totalMembers
    "dcCount" $dcCount
  ) }}
{{ end }}

{{/* Sort by name */}}
{{ $blocData = sort $blocData "name" "asc" }}

<div class="not-prose mb-8 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-2">
  {{ range $blocData }}
  <a href="/countries/{{ .slug }}/" class="block p-2.5 rounded-lg border border-base-200 hover:border-primary/50 hover:bg-base-100 transition-all no-underline">
    <div class="flex items-center gap-2">
      <span class="text-lg flex-shrink-0">{{ .flag }}</span>
      <span class="text-sm font-medium text-base-content truncate">{{ .name }}</span>
    </div>
    <div class="text-xs text-neutral-500 dark:text-neutral-400 mt-1.5 space-y-0.5">
      <div>Members: {{ .memberCount }}</div>
      <div>Datacenters: {{ .dcCount }}</div>
    </div>
  </a>
  {{ end }}
</div>
