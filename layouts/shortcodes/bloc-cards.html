{{/* Display bloc cards for the countries section */}}
{{ $blocs := site.Data.jurisdictions.blocs | default (slice) }}

<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 not-prose mb-8">
  {{ range $blocs }}
  {{ $memberCount := len (.members | default (slice)) }}

  {{/* Count inherited members */}}
  {{ $blocsById := dict }}
  {{ range site.Data.jurisdictions.blocs }}
    {{ $blocsById = merge $blocsById (dict .identifier .) }}
  {{ end }}

  {{ $totalMembers := $memberCount }}
  {{ range (.inheritsFrom | default (slice)) }}
    {{ $parent := index $blocsById . }}
    {{ if $parent }}
      {{ $totalMembers = add $totalMembers (len ($parent.members | default (slice))) }}
      {{ range ($parent.inheritsFrom | default (slice)) }}
        {{ $grandparent := index $blocsById . }}
        {{ if $grandparent }}
          {{ $totalMembers = add $totalMembers (len ($grandparent.members | default (slice))) }}
        {{ end }}
      {{ end }}
    {{ end }}
  {{ end }}

  {{/* Count datacenters */}}
  {{ $allMembers := .members | default (slice) }}
  {{ range (.inheritsFrom | default (slice)) }}
    {{ $parent := index $blocsById . }}
    {{ if $parent }}
      {{ range ($parent.members | default (slice)) }}
        {{ $allMembers = $allMembers | append . }}
      {{ end }}
    {{ end }}
  {{ end }}

  {{ $dcCount := 0 }}
  {{ range (site.Data.datacenters.datacenters | default (slice)) }}
    {{ range (.regions | default (slice)) }}
      {{ if in $allMembers .countryId }}
        {{ $dcCount = add $dcCount 1 }}
      {{ end }}
    {{ end }}
  {{ end }}

  <a href="/countries/{{ .slug }}/" class="block p-4 rounded-lg border border-neutral-200 dark:border-neutral-700 hover:border-primary-500 dark:hover:border-primary-500 transition-colors bg-base-100">
    <div class="flex items-center gap-3 mb-2">
      <span class="text-3xl">{{ .flag }}</span>
      <div>
        <h3 class="font-semibold text-neutral-900 dark:text-neutral-100 text-lg">{{ .name }}</h3>
      </div>
    </div>
    <p class="text-sm text-neutral-600 dark:text-neutral-400 mb-3">{{ .abstract | default .description | truncate 100 }}</p>
    <div class="flex flex-wrap gap-2">
      {{ $riskColors := dict "low" "bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200" "moderate" "bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200" "elevated" "bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-200" "high" "bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200" }}
      <span class="inline-block px-2 py-0.5 text-xs rounded {{ index $riskColors .riskLevel | default "bg-neutral-100 text-neutral-800" }}">{{ .riskLevel | title }} Risk</span>
      <span class="inline-block px-2 py-0.5 text-xs rounded bg-neutral-100 dark:bg-neutral-800 text-neutral-600 dark:text-neutral-400">{{ $totalMembers }} countries</span>
      {{ if gt $dcCount 0 }}
      <span class="inline-block px-2 py-0.5 text-xs rounded bg-neutral-100 dark:bg-neutral-800 text-neutral-600 dark:text-neutral-400">{{ $dcCount }} DCs</span>
      {{ end }}
    </div>
  </a>
  {{ end }}
</div>
