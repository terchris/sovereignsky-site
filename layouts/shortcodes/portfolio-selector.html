{{/* Portfolio Selector - lets users check which software they use */}}

<div id="portfolio-selector" class="portfolio-selector">
  <p class="text-neutral-600 dark:text-neutral-400 mb-6">
    Select the software tools your organization uses. We'll calculate your portfolio's overall sovereignty risk.
  </p>

  <!-- Use Area Groups -->
  {{ range site.Data.software.use_areas }}
  {{ $areaId := .id }}
  {{ $areaProducts := where site.Data.software.products "use_areas" "intersect" (slice .id) }}
  {{ if $areaProducts }}
  <div class="use-area-group mb-6">
    <h3 class="text-lg font-semibold mb-3 flex items-center gap-2">
      <span>{{ .name }}</span>
      <span class="text-sm font-normal text-neutral-500">({{ len $areaProducts }})</span>
    </h3>

    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
      {{ range $areaProducts }}
      <label class="portfolio-item flex items-start gap-3 p-3 border border-neutral-200 dark:border-neutral-700 rounded-lg cursor-pointer hover:border-primary-500 transition-colors">
        <input type="checkbox"
               name="portfolio"
               value="{{ .id }}"
               data-score="{{ .sovereignty.score }}"
               data-level="{{ .sovereignty.level }}"
               data-name="{{ .name }}"
               class="mt-1 rounded border-neutral-300 text-primary-600 focus:ring-primary-500">
        <div class="flex-1 min-w-0">
          <div class="flex items-center gap-2">
            {{ partial "country-flag" .vendor.country }}
            <span class="font-medium truncate">{{ .name }}</span>
            {{ if .sovereignty.cloud_act }}
            <span class="bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200 text-xs px-1.5 py-0.5 rounded">CLOUD</span>
            {{ end }}
          </div>
          <div class="text-sm text-neutral-500 dark:text-neutral-400">
            {{ .vendor.name }}
          </div>
          <div class="mt-1">
            <span class="text-xs px-2 py-0.5 rounded
              {{ if eq .sovereignty.level "low" }}bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200
              {{ else if eq .sovereignty.level "moderate" }}bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200
              {{ else if eq .sovereignty.level "elevated" }}bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-200
              {{ else }}bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200{{ end }}">
              {{ .sovereignty.level_label }}
            </span>
          </div>
        </div>
      </label>
      {{ end }}
    </div>
  </div>
  {{ end }}
  {{ end }}

  <!-- Summary Panel -->
  <div id="portfolio-summary" class="sticky bottom-4 mt-8 p-4 bg-white dark:bg-neutral-800 border border-neutral-200 dark:border-neutral-700 rounded-lg shadow-lg">
    <div class="flex items-center justify-between flex-wrap gap-4">
      <div>
        <span class="text-sm text-neutral-500 dark:text-neutral-400">Selected:</span>
        <span id="selected-count" class="font-semibold">0</span> tools
        <span class="mx-2 text-neutral-300 dark:text-neutral-600">|</span>
        <span class="text-sm text-neutral-500 dark:text-neutral-400">Avg Risk Score:</span>
        <span id="avg-score" class="font-semibold">-</span>
      </div>
      <button id="view-results"
              class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
              disabled>
        View Portfolio Assessment â†’
      </button>
    </div>
  </div>
</div>

<script>
(function() {
  const checkboxes = document.querySelectorAll('#portfolio-selector input[type="checkbox"]');
  const countEl = document.getElementById('selected-count');
  const scoreEl = document.getElementById('avg-score');
  const viewBtn = document.getElementById('view-results');

  function updateSummary() {
    const selected = Array.from(checkboxes).filter(cb => cb.checked);
    const count = selected.length;

    countEl.textContent = count;
    viewBtn.disabled = count === 0;

    if (count > 0) {
      const totalScore = selected.reduce((sum, cb) => sum + parseFloat(cb.dataset.score), 0);
      const avgScore = (totalScore / count).toFixed(1);
      scoreEl.textContent = avgScore + '/5.0';

      // Save to localStorage
      const portfolio = selected.map(cb => ({
        id: cb.value,
        name: cb.dataset.name,
        score: parseFloat(cb.dataset.score),
        level: cb.dataset.level
      }));
      localStorage.setItem('ndsi-portfolio', JSON.stringify(portfolio));
    } else {
      scoreEl.textContent = '-';
      localStorage.removeItem('ndsi-portfolio');
    }
  }

  checkboxes.forEach(cb => {
    cb.addEventListener('change', updateSummary);
  });

  viewBtn.addEventListener('click', function() {
    window.location.href = '/ndsi/results/';
  });

  // Restore from localStorage
  const saved = localStorage.getItem('ndsi-portfolio');
  if (saved) {
    try {
      const portfolio = JSON.parse(saved);
      const ids = portfolio.map(p => p.id);
      checkboxes.forEach(cb => {
        if (ids.includes(cb.value)) {
          cb.checked = true;
        }
      });
      updateSummary();
    } catch (e) {
      console.error('Failed to restore portfolio:', e);
    }
  }
})();
</script>
