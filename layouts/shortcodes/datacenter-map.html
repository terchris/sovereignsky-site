{{/*
  Datacenter Map - Shows datacenter locations using ECharts scatter on map
  Usage: {{< datacenter-map >}}

  Reads from data/datacenters.json and data/regions.json
  Colors points by vendor jurisdiction (US=red, EU=green, etc.)
*/}}

{{ $datacenters := site.Data.datacenters }}
{{ $regions := site.Data.regions }}
{{ $jurisdictions := site.Data.jurisdictions }}

{{/* Build regions lookup by country_id */}}
{{ $regionsById := dict }}
{{ range $regions }}
  {{ $regionsById = merge $regionsById (dict .id .) }}
{{ end }}

{{/* Build datacenter points for the map */}}
{{ $mapPoints := slice }}

{{ range $datacenters.providers }}
  {{ $provider := . }}
  {{ $vendorCountry := index $regionsById .vendor_country_id }}
  {{ $vendorRisk := "unknown" }}
  {{ if $vendorCountry }}
    {{ $vendorRisk = $vendorCountry.risk_level }}
  {{ end }}

  {{ range .regions }}
    {{ $dcCountry := index $regionsById .country_id }}
    {{ $dcRisk := "unknown" }}
    {{ if $dcCountry }}
      {{ $dcRisk = $dcCountry.risk_level }}
    {{ end }}

    {{ $point := dict
      "provider_id" $provider.provider_id
      "provider_name" $provider.provider_name
      "vendor_country_id" $provider.vendor_country_id
      "vendor_risk" $vendorRisk
      "region_id" .region_id
      "region_name" .region_name
      "country_id" .country_id
      "city" .city
      "coordinates" .coordinates
      "dc_risk" $dcRisk
    }}
    {{ $mapPoints = $mapPoints | append $point }}
  {{ end }}
{{ end }}

{{/* NOTE: avoid ID collisions with automatic heading anchors (e.g. "## Datacenter Map" => id="datacenter-map") */}}
<div id="datacenter-map-chart" style="width: 100%; height: 600px; background: var(--tw-prose-pre-bg, #f5f5f5); border-radius: 8px;"></div>

<div id="dc-map-loading" class="text-center py-8">
  <p class="text-neutral-500">Loading map...</p>
</div>

<div id="dc-legend" class="mt-4 p-4 bg-neutral-100 dark:bg-neutral-800 rounded-lg">
  <h4 class="font-semibold mb-2">Vendor Jurisdiction</h4>
  <div class="flex flex-wrap gap-4 text-sm">
    <span><span class="inline-block w-3 h-3 rounded-full bg-red-500 mr-1"></span> US vendor (CLOUD Act applies)</span>
    <span><span class="inline-block w-3 h-3 rounded-full bg-green-500 mr-1"></span> EU/EEA vendor (sovereignty-friendly)</span>
    <span><span class="inline-block w-3 h-3 rounded-full bg-blue-500 mr-1"></span> Swiss vendor (adequate)</span>
  </div>
</div>

<div id="dc-details" class="mt-6 p-4 bg-neutral-100 dark:bg-neutral-800 rounded-lg" style="display: none;">
  <h3 id="dc-name" class="text-xl font-bold mb-2"></h3>
  <div id="dc-info"></div>
</div>

<script>
(function() {
  var chartDom = document.getElementById('datacenter-map-chart');
  var loadingDiv = document.getElementById('dc-map-loading');

  // Datacenter data from Hugo
  var dcData = {{ $mapPoints | jsonify | safeJS }};

  // Color mapping by vendor country risk
  var vendorColors = {
    'high': '#ef4444',      // US - red
    'elevated': '#f97316',  // UK, AU - orange
    'moderate': '#3b82f6',  // CH, CA - blue
    'low': '#22c55e',       // EU/EEA - green
    'unknown': '#9ca3af'    // gray
  };

  // Fetch world GeoJSON and initialize map
  fetch('/data/world.json')
    .then(function(response) {
      return response.json();
    })
    .then(function(worldJson) {
      echarts.registerMap('world', worldJson);
      loadingDiv.style.display = 'none';

      var myChart = echarts.init(chartDom, null, { renderer: 'svg' });
      var isDark = document.documentElement.classList.contains('dark');

      // If multiple datacenters are very close, apply small pixel offsets so markers don't overlap.
      // This keeps the underlying coordinates intact while improving readability.
      var offsetsByPointKey = {};
      (function computeMarkerOffsets() {
        var groups = {};
        var points = [];

        dcData.forEach(function(dc) {
          if (!dc.coordinates || dc.coordinates.length !== 2) return;
          var lat = dc.coordinates[0];
          var lng = dc.coordinates[1];
          if (typeof lat !== 'number' || typeof lng !== 'number') return;

          var city = (dc.city || '').trim();
          var country = (dc.country_id || '').trim();
          if (!city || !country) return;

          var key = country + '|' + city.toLowerCase();
          var pointKey = (dc.provider_id || '') + '|' + (dc.region_id || '');

          var p = { key: key, pointKey: pointKey, lat: lat, lng: lng };
          points.push(p);
          if (!groups[key]) groups[key] = [];
          groups[key].push(p);
        });

        // Degree threshold: if any two points in a city are closer than this, we "fan" them out.
        // ~0.25¬∞ latitude ~= 28km, enough to catch "same metro area" duplicates without affecting most cities.
        var epsilon = 0.25;
        var baseRadiusPx = 10;

        Object.keys(groups).forEach(function(gk) {
          var g = groups[gk];
          if (g.length < 2) return;

          // Check if any pair is close enough to justify offsets.
          var shouldOffset = false;
          for (var i = 0; i < g.length && !shouldOffset; i++) {
            for (var j = i + 1; j < g.length; j++) {
              var dLat = g[i].lat - g[j].lat;
              var dLng = g[i].lng - g[j].lng;
              var dist = Math.sqrt(dLat * dLat + dLng * dLng);
              if (dist < epsilon) {
                shouldOffset = true;
                break;
              }
            }
          }
          if (!shouldOffset) return;

          // Deterministic ordering so offsets don't "jump" between reloads.
          g.sort(function(a, b) {
            if (a.pointKey < b.pointKey) return -1;
            if (a.pointKey > b.pointKey) return 1;
            return 0;
          });

          var n = g.length;
          var radius = baseRadiusPx + Math.max(0, n - 2) * 2;
          for (var k = 0; k < n; k++) {
            var angle = (2 * Math.PI * k) / n;
            offsetsByPointKey[g[k].pointKey] = [
              Math.round(Math.cos(angle) * radius),
              Math.round(Math.sin(angle) * radius)
            ];
          }
        });
      })();

      // Group datacenters by vendor risk for series
      var seriesByRisk = {};
      dcData.forEach(function(dc) {
        var risk = dc.vendor_risk || 'unknown';
        if (!seriesByRisk[risk]) {
          seriesByRisk[risk] = [];
        }
        if (dc.coordinates && dc.coordinates.length === 2) {
          var pointKey = (dc.provider_id || '') + '|' + (dc.region_id || '');
          seriesByRisk[risk].push({
            name: dc.provider_name + ' - ' + dc.region_name,
            value: [dc.coordinates[1], dc.coordinates[0], 1], // [lng, lat, value]
            symbolOffset: offsetsByPointKey[pointKey] || [0, 0],
            provider_id: dc.provider_id,
            provider_name: dc.provider_name,
            vendor_country_id: dc.vendor_country_id,
            vendor_risk: dc.vendor_risk,
            region_id: dc.region_id,
            region_name: dc.region_name,
            country_id: dc.country_id,
            city: dc.city,
            dc_risk: dc.dc_risk
          });
        }
      });

      // Risk level labels
      var riskLabels = {
        'high': 'US Jurisdiction',
        'elevated': 'Elevated Risk',
        'moderate': 'Moderate Risk',
        'low': 'EU/EEA Jurisdiction',
        'unknown': 'Unknown'
      };

      // Build series for each risk level
      var series = [
        {
          name: 'World Map',
          type: 'map',
          map: 'world',
          roam: true,
          zoom: 1.5,
          center: [10, 45],
          scaleLimit: { min: 1, max: 10 },
          itemStyle: {
            areaColor: isDark ? '#404040' : '#e5e5e5',
            borderColor: isDark ? '#525252' : '#d4d4d4',
            borderWidth: 0.5
          },
          emphasis: {
            disabled: true
          },
          silent: true
        }
      ];

      // Add scatter series for each risk level
      ['high', 'elevated', 'moderate', 'low', 'unknown'].forEach(function(risk) {
        if (seriesByRisk[risk] && seriesByRisk[risk].length > 0) {
          series.push({
            name: riskLabels[risk],
            type: 'scatter',
            coordinateSystem: 'geo',
            data: seriesByRisk[risk],
            symbolSize: 8,
            itemStyle: {
              color: vendorColors[risk],
              borderColor: '#fff',
              borderWidth: 1
            },
            emphasis: {
              itemStyle: {
                borderColor: '#000',
                borderWidth: 2
              },
              scale: 1.5
            }
          });
        }
      });

      var option = {
        title: {
          text: 'Cloud Datacenter Locations',
          subtext: 'Colored by vendor jurisdiction ‚Ä¢ Click a point for details',
          left: 'center',
          top: 10,
          textStyle: {
            color: isDark ? '#e5e5e5' : '#333',
            fontSize: 18
          },
          subtextStyle: {
            color: isDark ? '#a3a3a3' : '#666',
            fontSize: 12
          }
        },
        tooltip: {
          trigger: 'item',
          formatter: function(params) {
            if (params.data && params.data.provider_name) {
              var d = params.data;
              var jurisdictionWarning = '';
              if (d.vendor_risk === 'high' && d.dc_risk === 'low') {
                jurisdictionWarning = '<br/><span style="color:#ef4444">‚ö†Ô∏è US jurisdiction applies!</span>';
              }
              return '<strong>' + d.provider_name + '</strong><br/>' +
                     d.region_name + '<br/>' +
                     'üìç ' + d.city + ', ' + d.country_id +
                     jurisdictionWarning;
            }
            return '';
          }
        },
        legend: {
          show: true,
          bottom: 20,
          left: 'center',
          textStyle: {
            color: isDark ? '#e5e5e5' : '#333'
          }
        },
        geo: {
          map: 'world',
          roam: true,
          zoom: 1.5,
          center: [10, 45],
          scaleLimit: { min: 1, max: 10 },
          itemStyle: {
            areaColor: isDark ? '#404040' : '#e5e5e5',
            borderColor: isDark ? '#525252' : '#d4d4d4',
            borderWidth: 0.5
          },
          emphasis: {
            itemStyle: {
              areaColor: isDark ? '#525252' : '#d4d4d4'
            }
          }
        },
        series: series.slice(1) // Remove the map series, use geo instead
      };

      myChart.setOption(option);

      // Click handler
      myChart.on('click', function(params) {
        if (params.data && params.data.provider_name) {
          var d = params.data;
          var detailsDiv = document.getElementById('dc-details');
          var dcName = document.getElementById('dc-name');
          var dcInfo = document.getElementById('dc-info');

          dcName.innerHTML = d.provider_name + ' - ' + d.region_name;

          var vendorBadgeClass = d.vendor_risk === 'high'
            ? 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200'
            : d.vendor_risk === 'low'
            ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200'
            : 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200';

          var html = '<div class="space-y-2">';
          html += '<p><strong>Location:</strong> ' + d.city + ', ' + d.country_id + '</p>';
          html += '<p><strong>Region ID:</strong> <code>' + d.region_id + '</code></p>';
          html += '<p><strong>Vendor HQ:</strong> ' + d.vendor_country_id + ' ';
          html += '<span class="inline-block px-2 py-1 rounded text-xs font-medium ' + vendorBadgeClass + '">';
          html += d.vendor_risk === 'high' ? '‚ö†Ô∏è US Jurisdiction' : d.vendor_risk === 'low' ? '‚úÖ EU/EEA' : 'üî∑ Other';
          html += '</span></p>';

          if (d.vendor_risk === 'high' && d.dc_risk === 'low') {
            html += '<div class="mt-4 p-3 bg-red-50 dark:bg-red-900/30 border-l-4 border-red-500 rounded">';
            html += '<p class="font-semibold text-red-700 dark:text-red-300">‚ö†Ô∏è Jurisdiction Exposure</p>';
            html += '<p class="text-sm mt-1">This datacenter is physically in the EU/EEA, but the vendor (' + d.provider_name + ') is a US company.</p>';
            html += '<p class="text-sm mt-1">US laws like the <strong>CLOUD Act</strong> can compel the vendor to hand over data regardless of where it is stored.</p>';
            html += '<p class="text-sm mt-2"><a href="/laws/usa/" class="text-red-600 dark:text-red-400 hover:underline">Learn about US surveillance laws ‚Üí</a></p>';
            html += '</div>';
          } else if (d.vendor_risk === 'low') {
            html += '<div class="mt-4 p-3 bg-green-50 dark:bg-green-900/30 border-l-4 border-green-500 rounded">';
            html += '<p class="font-semibold text-green-700 dark:text-green-300">‚úÖ Sovereignty-Friendly</p>';
            html += '<p class="text-sm mt-1">This vendor is based in the EU/EEA. No extraterritorial data access laws apply.</p>';
            html += '</div>';
          }

          html += '</div>';
          dcInfo.innerHTML = html;

          detailsDiv.style.display = 'block';
          detailsDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
      });

      // Responsive
      window.addEventListener('resize', function() {
        myChart.resize();
      });

      // Dark mode toggle
      var observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
          if (mutation.attributeName === 'class') {
            var isDark = document.documentElement.classList.contains('dark');
            myChart.setOption({
              title: {
                textStyle: { color: isDark ? '#e5e5e5' : '#333' },
                subtextStyle: { color: isDark ? '#a3a3a3' : '#666' }
              },
              legend: {
                textStyle: { color: isDark ? '#e5e5e5' : '#333' }
              },
              geo: {
                itemStyle: {
                  areaColor: isDark ? '#404040' : '#e5e5e5',
                  borderColor: isDark ? '#525252' : '#d4d4d4'
                }
              }
            });
          }
        });
      });
      observer.observe(document.documentElement, { attributes: true });
    })
    .catch(function(error) {
      console.error('Failed to load world map:', error);
      loadingDiv.innerHTML = '<p class="text-red-500">Failed to load map. Please refresh the page.</p>';
    });
})();
</script>
