{{/*
Datacenter Countries list
Usage: {{< datacenter-countries >}}

Renders country cards (flag + datacenter and provider counts).
Links to /datacenters/{country}/ pages.
*/}}

{{ $providers := site.Data.datacenters.datacenters | default (slice) }}

{{/* Count datacenter regions and providers by physical country */}}
{{ $dcCounts := dict }}
{{ $providersByCountry := dict }}
{{ range $providers }}
  {{ $providerName := .name }}
  {{ range (.regions | default (slice)) }}
    {{ $cid := .countryId | default "" }}
    {{ if $cid }}
      {{ $prev := index $dcCounts $cid | default 0 }}
      {{ $dcCounts = merge $dcCounts (dict $cid (add $prev 1)) }}
      {{/* Track unique providers per country */}}
      {{ $existingProviders := index $providersByCountry $cid | default (slice) }}
      {{ if not (in $existingProviders $providerName) }}
        {{ $providersByCountry = merge $providersByCountry (dict $cid ($existingProviders | append $providerName)) }}
      {{ end }}
    {{ end }}
  {{ end }}
{{ end }}

{{/* Convert dict -> slice for sorting */}}
{{ $items := slice }}
{{ range $cid, $count := $dcCounts }}
  {{ $region := partial "get-region-by-id.html" $cid }}
  {{ $name := $region.name | default $cid }}
  {{ $providerCount := len (index $providersByCountry $cid | default (slice)) }}
  {{ $items = $items | append (dict
    "id" $cid
    "dcCount" $count
    "providerCount" $providerCount
    "region" $region
    "name" $name
  ) }}
{{ end }}

{{/* Sort by name */}}
{{ $items = sort $items "name" "asc" }}

<div class="not-prose" style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 0.75rem;">
  {{ range $items }}
    {{ $region := .region }}
    {{ $flag := $region.flag | default "" }}
    {{ $slug := $region.slug | default "" }}

    <a href="/datacenters/{{ $slug }}/" class="block p-3 rounded-lg border border-neutral-200 dark:border-neutral-700 hover:border-primary-500 dark:hover:border-primary-500 transition-colors bg-white dark:bg-neutral-900 no-underline">
      <div class="flex items-center gap-2 mb-2">
        <span class="text-xl">{{ $flag }}</span>
        <span class="text-sm font-medium text-neutral-900 dark:text-neutral-100 truncate">{{ .name }}</span>
      </div>
      <div class="text-xs text-neutral-500 dark:text-neutral-400 space-y-0.5">
        <div>Datacenters: {{ .dcCount }}</div>
        <div>Providers: {{ .providerCount }}</div>
      </div>
    </a>
  {{ end }}
</div>
