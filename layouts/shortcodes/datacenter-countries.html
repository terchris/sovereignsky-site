{{/*
Datacenter Countries list
Usage: {{< datacenter-countries >}}

Renders country cards (flag + datacenter and provider counts).
Links to /datacenters/{country}/ pages.
*/}}

{{ $providers := site.Data.datacenters.datacenters | default (slice) }}

{{/* Count datacenter regions and providers by physical country */}}
{{ $dcCounts := dict }}
{{ $providersByCountry := dict }}
{{ range $providers }}
  {{ $providerName := .name }}
  {{ range (.regions | default (slice)) }}
    {{ $cid := .countryId | default "" }}
    {{ if $cid }}
      {{ $prev := index $dcCounts $cid | default 0 }}
      {{ $dcCounts = merge $dcCounts (dict $cid (add $prev 1)) }}
      {{/* Track unique providers per country */}}
      {{ $existingProviders := index $providersByCountry $cid | default (slice) }}
      {{ if not (in $existingProviders $providerName) }}
        {{ $providersByCountry = merge $providersByCountry (dict $cid ($existingProviders | append $providerName)) }}
      {{ end }}
    {{ end }}
  {{ end }}
{{ end }}

{{/* Convert dict -> slice for sorting */}}
{{ $items := slice }}
{{ range $cid, $count := $dcCounts }}
  {{ $region := partial "get-region-by-id.html" $cid }}
  {{ $name := $region.name | default $cid }}
  {{ $providerCount := len (index $providersByCountry $cid | default (slice)) }}
  {{ $items = $items | append (dict
    "id" $cid
    "dcCount" $count
    "providerCount" $providerCount
    "region" $region
    "name" $name
  ) }}
{{ end }}

{{/* Sort by name */}}
{{ $items = sort $items "name" "asc" }}

<div class="not-prose grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-2">
  {{ range $items }}
    {{ $region := .region }}
    {{ $flag := $region.flag | default "" }}
    {{ $slug := $region.slug | default "" }}

    <a href="/datacenters/{{ $slug }}/" class="block p-2.5 rounded-lg border border-base-200 hover:border-primary/50 hover:bg-base-100 transition-all no-underline">
      <div class="flex items-center gap-2">
        <span class="text-lg flex-shrink-0">{{ $flag }}</span>
        <span class="text-sm font-medium text-base-content truncate">{{ .name }}</span>
      </div>
      <div class="text-xs text-neutral-500 dark:text-neutral-400 mt-1.5 space-y-0.5">
        <div>Datacenters: {{ .dcCount }}</div>
        <div>Providers: {{ .providerCount }}</div>
      </div>
    </a>
  {{ end }}
</div>
