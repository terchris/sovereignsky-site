{{/*
  Jurisdiction Map - Shows laws by country using ECharts
  Usage: {{< jurisdiction-map >}}

  Reads from data/regions.json and data/jurisdictions.json
  Colors countries by risk_level field
*/}}

{{ $regions := site.Data.countries.countries.itemListElement | default site.Data.regions }}
{{ $jurisdictions := site.Data.blocs }}

{{/* Get risk level definitions */}}
{{ $riskLevels := $jurisdictions.riskLevels | default site.Data.blocs.riskLevels }}

{{/* Build country data for the map */}}
{{ $mapData := slice }}

{{/* Count datacenter regions by physical country (for tooltips + filters + list) */}}
{{ $dc := site.Data.datacenters }}
{{ $dcCounts := dict }}
{{ range ($dc.datacenters | default (slice)) }}
  {{ range (.regions | default (slice)) }}
    {{ $cid := .countryId | default "" }}
    {{ if $cid }}
      {{ $prev := index $dcCounts $cid | default 0 }}
      {{ $dcCounts = merge $dcCounts (dict $cid (add $prev 1)) }}
    {{ end }}
  {{ end }}
{{ end }}

{{/* Bloc lookup for tooltip labels */}}
{{ $blocsById := dict }}
{{ $blocsData := site.Data.blocs.blocs.itemListElement | default (slice) }}
{{ range $blocsData }}
  {{ $blocsById = merge $blocsById (dict .identifier .) }}
{{ end }}

{{ range $regions }}
  {{/* Map risk_level to numeric value for visualization */}}
  {{ $riskValue := 0 }}
  {{ $riskLabel := "Unknown" }}
  {{ $riskColor := "#9ca3af" }}

  {{ if eq .riskLevel "low" }}
    {{ $riskValue = 0 }}
    {{ $riskLabel = "Low Risk" }}
    {{ $riskColor = index $riskLevels "low" "mapColor" }}
  {{ else if eq .riskLevel "moderate" }}
    {{ $riskValue = 1 }}
    {{ $riskLabel = "Moderate Risk" }}
    {{ $riskColor = index $riskLevels "moderate" "mapColor" }}
  {{ else if eq .riskLevel "elevated" }}
    {{ $riskValue = 2 }}
    {{ $riskLabel = "Elevated Risk" }}
    {{ $riskColor = index $riskLevels "elevated" "mapColor" }}
  {{ else if eq .riskLevel "high" }}
    {{ $riskValue = 3 }}
    {{ $riskLabel = "High Risk" }}
    {{ $riskColor = index $riskLevels "high" "mapColor" }}
  {{ else if eq .riskLevel "sanctioned" }}
    {{ $riskValue = 4 }}
    {{ $riskLabel = "Sanctioned" }}
    {{ $riskColor = index $riskLevels "sanctioned" "mapColor" }}
  {{ end }}

  {{/* Map ISO 2-letter to ECharts GeoJSON country names */}}
  {{ $countryName := .name }}
  {{ if eq .identifier "US" }}{{ $countryName = "United States" }}{{ end }}
  {{ if eq .identifier "GB" }}{{ $countryName = "United Kingdom" }}{{ end }}
  {{ if eq .identifier "KR" }}{{ $countryName = "Korea" }}{{ end }}
  {{ if eq .identifier "RU" }}{{ $countryName = "Russia" }}{{ end }}
  {{ if eq .identifier "NZ" }}{{ $countryName = "New Zealand" }}{{ end }}

  {{/* Build membership list */}}
  {{ $memberships := slice }}
  {{ if .euMember }}{{ $memberships = $memberships | append "EU" }}{{ end }}
  {{ if .eeaMember }}{{ $memberships = $memberships | append "EEA" }}{{ end }}
  {{ if .adequacyDecision }}{{ $memberships = $memberships | append "Adequacy" }}{{ end }}

  {{ $dcCount := index $dcCounts .identifier | default 0 }}
  {{ $blocNames := slice }}
  {{ range (.blocs | default (slice)) }}
    {{ $b := index $blocsById . }}
    {{ if $b }}
      {{ $blocNames = $blocNames | append $b.name }}
    {{ end }}
  {{ end }}

  {{ $item := dict
      "name" $countryName
      "value" $riskValue
      "id" .identifier
      "slug" .slug
      "riskLabel" $riskLabel
      "riskColor" $riskColor
      "riskLevel" .riskLevel
      "laws" .nationalLaws
      "flag" .flag
      "originalName" .name
      "blocs" .blocs
      "blocNames" $blocNames
      "memberships" $memberships
      "datacenterCount" $dcCount
    }}
  {{ $mapData = $mapData | append $item }}
{{ end }}

{{/* Stats - count jurisdictions by risk level */}}
{{ $totalCountries := len $regions }}
{{ $totalBlocs := len $blocsData }}
{{ $lowRisk := 0 }}
{{ $elevatedRisk := 0 }}
{{ range $regions }}
  {{ if eq .riskLevel "low" }}{{ $lowRisk = add $lowRisk 1 }}{{ end }}
  {{ if or (eq .riskLevel "elevated") (eq .riskLevel "high") (eq .riskLevel "sanctioned") }}{{ $elevatedRisk = add $elevatedRisk 1 }}{{ end }}
{{ end }}

<div class="not-prose stats stats-vertical sm:stats-horizontal shadow-lg w-full mb-8 bg-base-100">
  <div class="stat">
    <div class="stat-figure text-primary">
      {{ partial "content-icon.html" (dict "name" "globe" "color" "primary" "size" "8") }}
    </div>
    <div class="stat-title">Countries Tracked</div>
    <div class="stat-value text-primary">{{ $totalCountries }}</div>
    <div class="stat-desc">Jurisdictions monitored</div>
  </div>
  <div class="stat">
    <div class="stat-figure text-accent">
      {{ partial "content-icon.html" (dict "name" "users" "color" "accent" "size" "8") }}
    </div>
    <div class="stat-title">Regional Blocs</div>
    <div class="stat-value text-accent">{{ $totalBlocs }}</div>
    <div class="stat-desc">Trade & legal frameworks</div>
  </div>
  <div class="stat">
    <div class="stat-figure text-success">
      {{ partial "content-icon.html" (dict "name" "check-circle" "color" "success" "size" "8") }}
    </div>
    <div class="stat-title">Low Risk</div>
    <div class="stat-value text-success">{{ $lowRisk }}</div>
    <div class="stat-desc">Safe jurisdictions</div>
  </div>
  <div class="stat">
    <div class="stat-figure text-error">
      {{ partial "content-icon.html" (dict "name" "alert-triangle" "color" "error" "size" "8") }}
    </div>
    <div class="stat-title">Elevated+ Risk</div>
    <div class="stat-value text-error">{{ $elevatedRisk }}</div>
    <div class="stat-desc">Require caution</div>
  </div>
</div>


{{/* Risk Level Filter */}}
<div class="not-prose flex flex-wrap items-center gap-2 mb-4">
  <span class="text-sm font-semibold opacity-70">Risk:</span>
  <div class="join" id="laws-risk-chips" data-filter-group="risk">
    <button class="join-item btn btn-sm btn-active" data-filter="risk" data-value="all">All</button>
    <button class="join-item btn btn-sm btn-ghost" data-filter="risk" data-value="low">‚úÖ Low</button>
    <button class="join-item btn btn-sm btn-ghost" data-filter="risk" data-value="moderate">‚ö†Ô∏è Moderate</button>
    <button class="join-item btn btn-sm btn-ghost" data-filter="risk" data-value="elevated">üî∂ Elevated</button>
    <button class="join-item btn btn-sm btn-ghost" data-filter="risk" data-value="high">üö® High</button>
    <button class="join-item btn btn-sm btn-ghost" data-filter="risk" data-value="sanctioned">‚õî Sanctioned</button>
  </div>
</div>

{{/* Bloc Filter */}}
<div class="not-prose flex flex-wrap items-center gap-2 mb-4">
  <span class="text-sm font-semibold opacity-70">Bloc:</span>
  <div class="join" id="laws-bloc-chips" data-filter-group="bloc">
    <button class="join-item btn btn-sm btn-active" data-filter="bloc" data-value="all">All</button>
    <button class="join-item btn btn-sm btn-ghost" data-filter="bloc" data-value="eu">üá™üá∫ EU</button>
    <button class="join-item btn btn-sm btn-ghost" data-filter="bloc" data-value="eea">üá™üá∫ EEA</button>
    <button class="join-item btn btn-sm btn-ghost" data-filter="bloc" data-value="five-eyes">üëÅÔ∏è Five Eyes</button>
    <button class="join-item btn btn-sm btn-ghost" data-filter="bloc" data-value="adequacy">‚úì Adequacy</button>
  </div>
</div>

{{/* Features Filter */}}
<div class="not-prose flex flex-wrap items-center gap-2 mb-6">
  <span class="text-sm font-semibold opacity-70">Features:</span>
  <div class="flex flex-wrap gap-2" data-filter-group="features">
    <button class="btn btn-sm btn-ghost gap-1" id="laws-has-dc" data-filter="datacenters" data-value="true">üè¢ Has Datacenters</button>
  </div>
  <button id="laws-map-reset" class="btn btn-sm btn-ghost ml-auto">Reset filters</button>
</div>

<div id="jurisdiction-map" class="not-prose mt-4" style="width: 100%; height: 520px; background: var(--tw-prose-pre-bg, #f5f5f5); border-radius: 12px;"></div>

<div id="map-loading" class="text-center py-8">
  <p class="text-neutral-500">Loading map...</p>
</div>


<script>
(function() {
  var chartDom = document.getElementById('jurisdiction-map');
  var loadingDiv = document.getElementById('map-loading');

  // Region data from Hugo
  var regionsData = {{ $mapData | jsonify | safeJS }};
  var blocsData = {{ $blocsData | jsonify | safeJS }};
  var riskLevels = {{ ($jurisdictions.riskLevels | default dict) | jsonify | safeJS }};

  // Risk level colors from jurisdictions.json
  var riskColors = {
    low: '{{ index $riskLevels "low" "mapColor" }}',
    moderate: '{{ index $riskLevels "moderate" "mapColor" }}',
    elevated: '{{ index $riskLevels "elevated" "mapColor" }}',
    high: '{{ index $riskLevels "high" "mapColor" }}',
    sanctioned: '{{ index $riskLevels "sanctioned" "mapColor" }}'
  };

  // Fetch world GeoJSON and initialize map (local copy to avoid CORS issues)
  fetch('/data/world.json')
    .then(function(response) {
      return response.json();
    })
    .then(function(worldJson) {
      // Register the map
      echarts.registerMap('world', worldJson);

      // Hide loading
      loadingDiv.style.display = 'none';

      // Initialize chart
      var myChart = echarts.init(chartDom, null, { renderer: 'svg' });

      // Create data array for ECharts
      var mapData = regionsData.map(function(item) {
        return {
          name: item.name,
          value: item.value,
          id: item.id,
          slug: item.slug,
          riskLabel: item.riskLabel,
          riskLevel: item.riskLevel || 'unknown',
          laws: item.laws || [],
          flag: item.flag,
          originalName: item.originalName,
          blocs: item.blocs || [],
          blocNames: item.blocNames || [],
          memberships: item.memberships || [],
          datacenterCount: item.datacenterCount || 0
        };
      });

      var isDark = document.documentElement.classList.contains('dark');

      var option = {
        title: { show: false },
        tooltip: {
          trigger: 'item',
          formatter: function(params) {
            if (params.data && params.data.value !== undefined) {
              var displayName = params.data.originalName || params.name;
              var laws = params.data.laws || [];
              var lawCount = laws.length;
              var blocNames = params.data.blocNames || [];
              var blocStr = blocNames.length > 0 ? '<br/>' + blocNames.join(' ‚Ä¢ ') : '';
              var dcCount = params.data.datacenterCount || 0;
              var dcStr = dcCount > 0 ? '<br/>üè¢ Datacenters: ' + dcCount : '';
              var lawStr = lawCount > 0 ? '<br/>‚ö†Ô∏è ' + lawCount + ' national law(s)' : '<br/>‚úÖ No concerning laws';
              return '<strong>' + (params.data.flag || '') + ' ' + displayName + '</strong><br/>' +
                     'Risk: <span style="font-weight:bold">' + params.data.riskLabel + '</span>' +
                     blocStr + dcStr + lawStr;
            }
            return params.name;
          }
        },
        visualMap: {
          show: false
        },
        series: [
          {
            name: 'Jurisdiction Risk',
            type: 'map',
            map: 'world',
            roam: true,
            zoom: 1.2,
            center: [10, 50],
            scaleLimit: {
              min: 1,
              max: 8
            },
            label: {
              show: false
            },
            emphasis: {
              label: {
                show: true,
                color: '#fff',
                fontSize: 10
              },
              itemStyle: {
                areaColor: '#3b82f6'
              }
            },
            itemStyle: {
              areaColor: isDark ? '#404040' : '#e5e5e5',
              borderColor: isDark ? '#525252' : '#d4d4d4',
              borderWidth: 0.5
            },
            select: {
              disabled: true
            },
            data: mapData
          }
        ]
      };

      myChart.setOption(option);

      // --- UI state ---
      var selectedRisk = 'all'; // single selection: 'all', 'low', 'moderate', etc.
      var selectedBloc = 'all'; // single selection: 'all', 'eu', 'eea', etc.
      var hasDatacentersOnly = false;
      var focusedIds = null; // null = no focus; [] = focused set
      var currentSort = 'datacenters';

      function blocById() {
        var m = {};
        (blocsData || []).forEach(function(b) { m[b.id] = b; });
        return m;
      }
      var blocsById = blocById();

      function setActiveButton(groupEl, value) {
        groupEl.querySelectorAll('button').forEach(function(b) {
          b.classList.remove('btn-active');
          b.classList.add('btn-ghost');
        });
        var target = groupEl.querySelector('button[data-value="' + value + '"]') || groupEl.querySelector('button[data-value="all"]');
        if (target) {
          target.classList.add('btn-active');
          target.classList.remove('btn-ghost');
        }
      }

      function setupFilterListeners() {
        // Risk filter buttons
        document.querySelectorAll('#laws-risk-chips button').forEach(function(btn) {
          btn.addEventListener('click', function() {
            selectedRisk = btn.dataset.value;
            focusedIds = null;
            setActiveButton(document.getElementById('laws-risk-chips'), selectedRisk);
            renderAll();
          });
        });

        // Bloc filter buttons
        document.querySelectorAll('#laws-bloc-chips button').forEach(function(btn) {
          btn.addEventListener('click', function() {
            selectedBloc = btn.dataset.value;
            focusedIds = null;
            setActiveButton(document.getElementById('laws-bloc-chips'), selectedBloc);
            renderAll();
          });
        });

        // Has Datacenters toggle
        var dcBtn = document.getElementById('laws-has-dc');
        if (dcBtn) {
          dcBtn.addEventListener('click', function() {
            hasDatacentersOnly = !hasDatacentersOnly;
            if (hasDatacentersOnly) {
              dcBtn.classList.add('btn-active');
              dcBtn.classList.remove('btn-ghost');
            } else {
              dcBtn.classList.remove('btn-active');
              dcBtn.classList.add('btn-ghost');
            }
            focusedIds = null;
            renderAll();
          });
        }
      }

      function updateFilterButtons() {
        setActiveButton(document.getElementById('laws-risk-chips'), selectedRisk);
        setActiveButton(document.getElementById('laws-bloc-chips'), selectedBloc);
        var dcBtn = document.getElementById('laws-has-dc');
        if (dcBtn) {
          if (hasDatacentersOnly) {
            dcBtn.classList.add('btn-active');
            dcBtn.classList.remove('btn-ghost');
          } else {
            dcBtn.classList.remove('btn-active');
            dcBtn.classList.add('btn-ghost');
          }
        }
      }

      function matchCountry(d) {
        if (!d) return false;
        if (selectedRisk !== 'all' && (d.riskLevel || 'unknown') !== selectedRisk) return false;
        if (selectedBloc !== 'all') {
          var blocs = d.blocs || [];
          if (blocs.indexOf(selectedBloc) === -1) return false;
        }
        if (hasDatacentersOnly && !(d.datacenterCount > 0)) return false;
        if (focusedIds && focusedIds.length > 0 && focusedIds.indexOf(d.id) === -1) return false;
        return true;
      }

      function updateMapStyles() {
        var data = mapData.map(function(d) {
          var m = matchCountry(d);
          return Object.assign({}, d, {
            itemStyle: { opacity: m ? 1 : 0.25 }
          });
        });
        // Only update the series data; don't replace-merge the series definition
        // (replacing can drop `type: 'map'`, `map: 'world'`, etc. and render blank).
        myChart.setOption({ series: [{ data: data }] });
      }

      function renderCountriesList() {
        var wrap = document.getElementById('laws-countries-list');
        if (!wrap) return;
        var items = mapData.slice().filter(matchCountry);

        var riskRank = { low: 0, moderate: 1, elevated: 2, high: 3, sanctioned: 4, unknown: 5 };
        if (currentSort === 'datacenters') {
          items.sort(function(a, b) {
            var dc = (b.datacenterCount||0) - (a.datacenterCount||0);
            if (dc !== 0) return dc;
            return (a.originalName||a.name).localeCompare(b.originalName||b.name);
          });
        } else if (currentSort === 'risk') {
          items.sort(function(a, b) {
            var ra = riskRank[a.riskLevel||'unknown'] ?? 99;
            var rb = riskRank[b.riskLevel||'unknown'] ?? 99;
            if (ra !== rb) return rb - ra; // high first
            return (a.originalName||a.name).localeCompare(b.originalName||b.name);
          });
        } else {
          items.sort(function(a, b) {
            return (a.originalName||a.name).localeCompare(b.originalName||b.name);
          });
        }

        wrap.innerHTML = '';
        items.forEach(function(d) {
          var label = (d.flag ? (d.flag + ' ') : '') + (d.originalName || d.name);
          var risk = d.riskLabel || 'Unknown';
          var dc = d.datacenterCount || 0;
          var text = label + ' ¬∑ ' + risk + (dc > 0 ? (' ¬∑ üè¢ ' + dc) : '');
          if (d.slug) {
            var a = document.createElement('a');
            a.className = 'inline-flex items-center gap-2 no-underline px-3 py-1 rounded-full border border-neutral-200 dark:border-neutral-700 bg-white dark:bg-neutral-900 hover:border-primary-400 dark:hover:border-primary-500 transition-colors text-sm';
            a.href = '/countries/' + d.slug + '/';
            a.title = (d.originalName || d.name) + ' ‚Ä¢ ' + risk + (dc > 0 ? (' ‚Ä¢ Datacenters: ' + dc) : '');
            a.textContent = text;
            wrap.appendChild(a);
          } else {
            var s = document.createElement('span');
            s.className = 'inline-flex items-center gap-2 px-3 py-1 rounded-full border border-neutral-200 dark:border-neutral-700 bg-white dark:bg-neutral-900 text-sm';
            s.textContent = text;
            wrap.appendChild(s);
          }
        });
      }

      function renderAll() {
        updateFilterButtons();
        updateMapStyles();
        renderCountriesList();
      }

      function resetAll() {
        selectedRisk = 'all';
        selectedBloc = 'all';
        hasDatacentersOnly = false;
        focusedIds = null;
        currentSort = 'datacenters';
        var q = document.getElementById('laws-map-search');
        if (q) q.value = '';
        var sug = document.getElementById('laws-map-suggestions');
        if (sug) { sug.style.display = 'none'; sug.innerHTML = ''; }
        renderAll();
      }

      // --- Search index (countries, blocs, laws) ---
      function normalize(s) {
        return (s || '').toString().toLowerCase().trim();
      }

      function uniq(arr) {
        var out = [];
        var seen = new Set();
        arr.forEach(function(x) {
          var k = normalize(x);
          if (!k) return;
          if (seen.has(k)) return;
          seen.add(k);
          out.push(x);
        });
        return out;
      }

      function buildBlocAllLawTexts() {
        var memo = {};
        function rec(id, stack) {
          if (memo[id]) return memo[id];
          stack = stack || new Set();
          if (stack.has(id)) return [];
          stack.add(id);
          var b = blocsById[id];
          var names = [];
          if (b && b.laws) {
            b.laws.forEach(function(l) {
              if (l && l.name) names.push(l.name);
              if (l && l.full_name) names.push(l.full_name);
            });
          }
          if (b && b.inheritsFrom) {
            b.inheritsFrom.forEach(function(parentId) {
              names = names.concat(rec(parentId, stack));
            });
          }
          memo[id] = uniq(names);
          return memo[id];
        }
        Object.keys(blocsById).forEach(function(id) { rec(id); });
        return memo;
      }

      var blocAllLawTexts = buildBlocAllLawTexts();

      // attach a searchable lawText per country (national + bloc/inherited)
      var countryById = {};
      mapData.forEach(function(c) {
        countryById[c.id] = c;
        var t = [];
        (c.laws || []).forEach(function(l) {
          if (l && l.name) t.push(l.name);
          if (l && l.full_name) t.push(l.full_name);
        });
        (c.blocs || []).forEach(function(bid) {
          var bt = blocAllLawTexts[bid] || [];
          t = t.concat(bt);
        });
        c._lawTexts = uniq(t);
        c._lawTextNorm = normalize(c._lawTexts.join(' | '));
      });

      // global law index: one entry per distinct law name (prefer short name)
      var lawIndex = (function() {
        var allNames = [];
        (blocsData || []).forEach(function(b) {
          (b.laws || []).forEach(function(l) { if (l && l.name) allNames.push(l.name); });
        });
        mapData.forEach(function(c) {
          (c.laws || []).forEach(function(l) { if (l && l.name) allNames.push(l.name); });
        });
        allNames = uniq(allNames);
        return allNames.map(function(name) {
          var key = normalize(name);
          var ids = mapData.filter(function(c) {
            return c._lawTextNorm.indexOf(key) !== -1;
          }).map(function(c) { return c.id; });
          return { type: 'law', label: '‚öñÔ∏è ' + name, name: name, ids: ids };
        }).filter(function(e) { return e.ids && e.ids.length > 0; });
      })();

      function buildSuggestions(query) {
        var qn = normalize(query);
        if (!qn || qn.length < 2) return [];
        var out = [];

        // countries
        mapData.forEach(function(c) {
          var name = normalize(c.originalName || c.name);
          var id = normalize(c.id);
          if (name.indexOf(qn) !== -1 || id.indexOf(qn) !== -1) {
            out.push({
              type: 'country',
              label: (c.flag ? (c.flag + ' ') : '') + (c.originalName || c.name) + ' (' + c.id + ')',
              ids: [c.id]
            });
          }
        });

        // blocs
        (blocsData || []).forEach(function(b) {
          var nm = normalize(b.name);
          var bid = normalize(b.id);
          if (nm.indexOf(qn) !== -1 || bid.indexOf(qn) !== -1) {
            out.push({
              type: 'bloc',
              label: (b.flag ? (b.flag + ' ') : '') + b.name + ' (bloc)',
              ids: b.members || []
            });
          }
        });

        // laws
        lawIndex.forEach(function(l) {
          if (normalize(l.name).indexOf(qn) !== -1) {
            out.push({ type: 'law', label: l.label, ids: l.ids, name: l.name });
          }
        });

        // rank: exact prefix first, then shorter labels
        out.sort(function(a, b) {
          var ap = normalize(a.label).indexOf(qn) === 0 ? 0 : 1;
          var bp = normalize(b.label).indexOf(qn) === 0 ? 0 : 1;
          if (ap !== bp) return ap - bp;
          return a.label.length - b.label.length;
        });

        // de-dupe labels
        var seen = new Set();
        var final = [];
        out.forEach(function(s) {
          var k = normalize(s.label);
          if (seen.has(k)) return;
          seen.add(k);
          final.push(s);
        });
        return final.slice(0, 10);
      }

      function showSuggestions(list) {
        var sug = document.getElementById('laws-map-suggestions');
        if (!sug) return;
        if (!list || list.length === 0) {
          sug.style.display = 'none';
          sug.innerHTML = '';
          return;
        }
        sug.style.display = 'block';
        sug.innerHTML = '';
        list.forEach(function(s, idx) {
          var btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'w-full text-left px-3 py-2 text-sm hover:bg-neutral-50 dark:hover:bg-neutral-800';
          btn.textContent = s.label;
          btn.addEventListener('click', function() {
            focusedIds = (s.ids || []).slice();
            renderAll();
            showSuggestions([]);
            // nudge zoom a bit for focus (no reliable centroid data in world.json)
            myChart.dispatchAction({ type: 'geoRoam', zoom: focusedIds.length <= 1 ? 2.0 : 1.4 });
            // show one tooltip as a hint
            if (focusedIds.length === 1) {
              var c = countryById[focusedIds[0]];
              if (c) myChart.dispatchAction({ type: 'showTip', seriesIndex: 0, name: c.name });
            }
          });
          sug.appendChild(btn);
          if (idx !== list.length - 1) {
            var div = document.createElement('div');
            div.className = 'h-px bg-neutral-200 dark:bg-neutral-700';
            sug.appendChild(div);
          }
        });
      }

      // --- click to navigate ---
      myChart.on('click', function(params) {
        if (params && params.data && params.data.slug) {
          window.location.href = '/countries/' + params.data.slug + '/';
        }
      });

      // controls wiring
      setupFilterListeners();
      renderAll();

      var searchInput = document.getElementById('laws-map-search');
      if (searchInput) {
        var last = '';
        searchInput.addEventListener('input', function() {
          var v = searchInput.value || '';
          if (v === last) return;
          last = v;
          showSuggestions(buildSuggestions(v));
        });
        searchInput.addEventListener('keydown', function(e) {
          if (e.key === 'Enter') {
            var s = buildSuggestions(searchInput.value || '');
            if (s && s.length > 0) {
              focusedIds = (s[0].ids || []).slice();
              renderAll();
              showSuggestions([]);
              myChart.dispatchAction({ type: 'geoRoam', zoom: focusedIds.length <= 1 ? 2.0 : 1.4 });
            }
          }
          if (e.key === 'Escape') {
            showSuggestions([]);
          }
        });
      }

      document.addEventListener('click', function(e) {
        var sug = document.getElementById('laws-map-suggestions');
        if (!sug) return;
        if (!sug.contains(e.target) && e.target !== searchInput) {
          showSuggestions([]);
        }
      });

      var resetBtn = document.getElementById('laws-map-reset');
      if (resetBtn) resetBtn.addEventListener('click', resetAll);

      document.querySelectorAll('.laws-country-sort').forEach(function(btn) {
        btn.addEventListener('click', function() {
          currentSort = btn.dataset.sort || 'datacenters';
          renderCountriesList();
        });
      });

      // Responsive resize
      window.addEventListener('resize', function() {
        myChart.resize();
      });

      // Handle dark mode toggle
      var observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
          if (mutation.attributeName === 'class') {
            var isDark = document.documentElement.classList.contains('dark');
            myChart.setOption({
              title: {
                textStyle: { color: isDark ? '#e5e5e5' : '#333' },
                subtextStyle: { color: isDark ? '#a3a3a3' : '#666' }
              },
              visualMap: {
                textStyle: { color: isDark ? '#e5e5e5' : '#333' }
              },
              series: [{
                itemStyle: {
                  areaColor: isDark ? '#404040' : '#e5e5e5',
                  borderColor: isDark ? '#525252' : '#d4d4d4'
                }
              }]
            });
          }
        });
      });
      observer.observe(document.documentElement, { attributes: true });
    })
    .catch(function(error) {
      console.error('Failed to load world map:', error);
      loadingDiv.innerHTML = '<p class="text-red-500">Failed to load map. Please refresh the page.</p>';
    });
})();
</script>
