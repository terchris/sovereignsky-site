{{ define "main" }}
{{/* Build lookup maps */}}
{{ $topicsLookup := dict }}
{{ range site.Data.topics.topics.itemListElement }}
  {{ $topicsLookup = merge $topicsLookup (dict .identifier .) }}
{{ end }}

{{ $topicLabels := dict }}
{{ range site.Data.topics.topics.itemListElement }}
  {{ $topicLabels = merge $topicLabels (dict .identifier .name) }}
{{ end }}

<article class="max-w-full">
  {{/* Section Header */}}
  {{ partial "section-header.html" (dict
      "title" .Title
      "description" .Description
      "icon" "book"
  ) }}

  {{/* Stats cards */}}
  {{ $total := len .Pages }}
  {{ $topicCounts := dict }}
  {{ range .Pages }}
    {{ range .Params.topics }}
      {{ $count := index $topicCounts . | default 0 }}
      {{ $topicCounts = merge $topicCounts (dict . (add $count 1)) }}
    {{ end }}
  {{ end }}
  {{/* Get all unique topics and build items for filter-pills */}}
  {{ $uniqueTopics := slice }}
  {{ range $topic, $count := $topicCounts }}
    {{ $uniqueTopics = $uniqueTopics | append $topic }}
  {{ end }}
  {{ $uniqueTopics = sort $uniqueTopics }}

  {{/* Build topic items for filter-pills partial */}}
  {{ $topicItems := slice }}
  {{ range $uniqueTopics }}
    {{ $label := index $topicLabels . | default (. | humanize | title) }}
    {{ $topicItems = $topicItems | append (dict "id" . "name" $label) }}
  {{ end }}

  <div class="stats stats-vertical sm:stats-horizontal shadow-lg w-full mb-8 bg-base-100">
    <div class="stat">
      <div class="stat-figure text-primary">
        {{ partial "data-icon.html" (dict "name" "book" "color" "primary" "size" "8") }}
      </div>
      <div class="stat-title">Publications</div>
      <div class="stat-value text-primary">{{ $total }}</div>
      <div class="stat-desc">Reports & papers</div>
    </div>
    <div class="stat">
      <div class="stat-figure text-accent">
        {{ partial "data-icon.html" (dict "name" "tag" "color" "accent" "size" "8") }}
      </div>
      <div class="stat-title">Topics Covered</div>
      <div class="stat-value text-accent">{{ len $uniqueTopics }}</div>
      <div class="stat-desc">Subject areas</div>
    </div>
  </div>

  {{/* Audience filter - reusable partial */}}
  {{ partial "audience-filter.html" . }}

  {{/* Topic filter - responsive pills that wrap on mobile */}}
  {{ partial "filter-pills.html" (dict
      "label" "Topic"
      "filterGroup" "topics"
      "items" $topicItems
      "allLabel" "All"
  ) }}

  {{/* Publication cards - compact layout */}}
  <div id="publications-grid" class="grid sm:grid-cols-2" style="gap: 1.5rem;">
    {{ range .Pages }}
    {{/* Get featured image from page bundle */}}
    {{ $featured := .Resources.GetMatch "featured*" }}
    {{ $topics := .Params.topics | default (slice) }}
    {{ $audiences := .Params.audience | default (slice) }}

    {{/* Build category label: "Type | Publisher" */}}
    {{ $typeLabel := "" }}
    {{ with .Params.publication_type }}
      {{ if eq . "book" }}{{ $typeLabel = "Book" }}
      {{ else if eq . "report" }}{{ $typeLabel = "Report" }}
      {{ else if eq . "paper" }}{{ $typeLabel = "Paper" }}
      {{ else if eq . "guide" }}{{ $typeLabel = "Guide" }}
      {{ else }}{{ $typeLabel = . | humanize | title }}{{ end }}
    {{ end }}

    {{ $publisher := "" }}
    {{ with .Params.publisher }}{{ $publisher = . }}{{ else }}{{ with .Params.institutions }}{{ $publisher = index . 0 }}{{ end }}{{ end }}

    {{/* Use compact card partial */}}
    <div class="publication-card" data-topics="{{ delimit $topics "," }}" data-audience="{{ delimit $audiences "," }}">
      {{ partial "card-compact.html" (dict
          "title" .Title
          "url" .RelPermalink
          "category" $typeLabel
          "subcategory" $publisher
          "thumbnail" $featured
          "year" .Params.year
          "icon" "book"
      ) }}
    </div>
    {{ end }}
  </div>

  {{/* No results message */}}
  <div id="no-results" class="hidden alert alert-warning my-4">
    <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>
    <span>No publications match the selected filters.</span>
  </div>

</article>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const filterButtons = document.querySelectorAll('[data-filter-group] button[data-filter]');
  const publicationCards = document.querySelectorAll('.publication-card');
  const noResults = document.getElementById('no-results');

  let activeFilters = {
    topics: 'all',
    audience: 'all'
  };

  function setActiveButton(filterGroup, filterValue) {
    const groupEl = document.querySelector(`[data-filter-group="${filterGroup}"]`);
    if (!groupEl) return;
    const btn = groupEl.querySelector(`button[data-filter="${filterValue}"]`);
    const fallback = groupEl.querySelector(`button[data-filter="all"]`);
    const target = btn || fallback;
    if (!target) return;

    // Update active state - supports both btn-active and btn-primary styles
    groupEl.querySelectorAll('button').forEach(b => {
      b.classList.remove('btn-active', 'btn-primary');
      b.classList.add('btn-ghost');
      if (!b.classList.contains('border')) {
        b.classList.add('border', 'border-base-300');
      }
    });
    target.classList.add('btn-primary');
    target.classList.remove('btn-ghost', 'border', 'border-base-300');

    activeFilters[filterGroup] = target.dataset.filter;
  }

  function updateURL() {
    const params = new URLSearchParams();
    if (activeFilters.topics && activeFilters.topics !== 'all') params.set('topic', activeFilters.topics);
    if (activeFilters.audience && activeFilters.audience !== 'all') params.set('audience', activeFilters.audience);
    const qs = params.toString();
    const newURL = qs ? `?${qs}` : window.location.pathname;
    history.replaceState(null, '', newURL);
  }

  function applyFilters() {
    let visibleCount = 0;

    publicationCards.forEach(card => {
      const cardTopics = card.dataset.topics || '';
      const cardAudience = card.dataset.audience || '';

      const matchesTopics = activeFilters.topics === 'all' || cardTopics.includes(activeFilters.topics);
      const matchesAudience = activeFilters.audience === 'all' || cardAudience.includes(activeFilters.audience);

      if (matchesTopics && matchesAudience) {
        card.style.display = '';
        visibleCount++;
      } else {
        card.style.display = 'none';
      }
    });

    if (visibleCount === 0) {
      noResults.classList.remove('hidden');
    } else {
      noResults.classList.add('hidden');
    }
  }

  // Initialize from URL
  const params = new URLSearchParams(window.location.search);
  const urlAudience = params.get('audience') || 'all';
  const urlTopic = params.get('topic') || params.get('topics') || 'all';

  setActiveButton('audience', urlAudience);
  setActiveButton('topics', urlTopic);
  applyFilters();

  filterButtons.forEach(btn => {
    btn.addEventListener('click', function() {
      const groupEl = this.closest('[data-filter-group]');
      const filterGroup = groupEl.dataset.filterGroup;
      const filterValue = this.dataset.filter;

      // Update active state - supports both btn-active and btn-primary styles
      groupEl.querySelectorAll('button').forEach(b => {
        b.classList.remove('btn-active', 'btn-primary');
        b.classList.add('btn-ghost');
        if (!b.classList.contains('border')) {
          b.classList.add('border', 'border-base-300');
        }
      });
      this.classList.add('btn-primary');
      this.classList.remove('btn-ghost', 'border', 'border-base-300');

      activeFilters[filterGroup] = filterValue;
      applyFilters();
      updateURL();
    });
  });
});
</script>
{{ end }}
