{{ define "main" }}
{{/* Build lookup maps */}}
{{ $topicsLookup := dict }}
{{ range site.Data.topics.topics.itemListElement }}
  {{ $topicsLookup = merge $topicsLookup (dict .identifier .) }}
{{ end }}

{{ $topicLabels := dict }}
{{ range site.Data.topics.topics.itemListElement }}
  {{ $topicLabels = merge $topicLabels (dict .identifier .name) }}
{{ end }}

<article class="max-w-full">
  {{/* Section Header */}}
  {{ partial "section-header.html" (dict
      "title" .Title
      "description" .Description
      "icon" "book"
  ) }}

  {{/* Stats cards */}}
  {{ $total := len .Pages }}
  {{ $topicCounts := dict }}
  {{ range .Pages }}
    {{ range .Params.topics }}
      {{ $count := index $topicCounts . | default 0 }}
      {{ $topicCounts = merge $topicCounts (dict . (add $count 1)) }}
    {{ end }}
  {{ end }}
  {{/* Get all unique topics */}}
  {{ $uniqueTopics := slice }}
  {{ range $topic, $count := $topicCounts }}
    {{ $uniqueTopics = $uniqueTopics | append $topic }}
  {{ end }}
  {{ $uniqueTopics = sort $uniqueTopics }}

  <div class="stats stats-vertical sm:stats-horizontal shadow-lg w-full mb-8 bg-base-100">
    <div class="stat">
      <div class="stat-figure text-primary">
        {{ partial "content-icon.html" (dict "name" "book" "color" "primary" "size" "8") }}
      </div>
      <div class="stat-title">Publications</div>
      <div class="stat-value text-primary">{{ $total }}</div>
      <div class="stat-desc">Reports & papers</div>
    </div>
    <div class="stat">
      <div class="stat-figure text-accent">
        {{ partial "content-icon.html" (dict "name" "tag" "color" "accent" "size" "8") }}
      </div>
      <div class="stat-title">Topics Covered</div>
      <div class="stat-value text-accent">{{ len $uniqueTopics }}</div>
      <div class="stat-desc">Subject areas</div>
    </div>
  </div>

  {{/* Audience filter - reusable partial */}}
  {{ partial "audience-filter.html" . }}

  {{/* Topic filter - reusable partial */}}
  {{ partial "topic-filter.html" (dict "topics" $uniqueTopics) }}

  {{/* Publication cards */}}
  <div id="publications-grid" class="grid gap-6 sm:grid-cols-2 lg:grid-cols-3">
    {{ range .Pages }}
    {{/* Get featured image from page bundle */}}
    {{ $featured := .Resources.GetMatch "featured*" }}
    {{ $topics := .Params.topics | default (slice) }}
    {{ $audiences := .Params.audience | default (slice) }}

    <article
      class="publication-card card bg-base-100 shadow-md hover:shadow-lg transition-all group border border-base-200"
      data-topics="{{ delimit $topics "," }}"
      data-audience="{{ delimit $audiences "," }}"
    >
      <a href="{{ .RelPermalink }}" class="block no-underline">
        {{/* Cover image */}}
        {{ if $featured }}
        {{ $img := $featured.Fill "600x300 webp" }}
        <figure class="h-48 overflow-hidden bg-base-200">
          <img src="{{ $img.RelPermalink }}" alt="{{ .Title }}" width="{{ $img.Width }}" height="{{ $img.Height }}" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300" loading="lazy" />
        </figure>
        {{ else }}
        {{/* Placeholder if no image */}}
        <figure class="h-48 overflow-hidden bg-gradient-to-br from-primary/10 to-secondary/10 flex items-center justify-center">
          <div class="text-primary/30">
            {{ partial "content-icon.html" (dict "name" "book" "size" "16" "class" "w-16 h-16") }}
          </div>
        </figure>
        {{ end }}

        <div class="card-body p-4">
          {{/* Publication type and year row */}}
          <div class="flex items-center justify-between gap-2 mb-2">
            {{/* Publication type badge */}}
            {{ with .Params.publication_type }}
            {{ $typeLabel := . }}
            {{ $typeClass := "badge-ghost" }}
            {{ if eq . "book" }}
              {{ $typeLabel = "Book" }}
              {{ $typeClass = "badge-primary" }}
            {{ else if eq . "report" }}
              {{ $typeLabel = "Report" }}
              {{ $typeClass = "badge-secondary" }}
            {{ else if eq . "paper" }}
              {{ $typeLabel = "Paper" }}
              {{ $typeClass = "badge-accent" }}
            {{ else if eq . "guide" }}
              {{ $typeLabel = "Guide" }}
              {{ $typeClass = "badge-info" }}
            {{ end }}
            <span class="badge badge-sm {{ $typeClass }}">{{ $typeLabel }}</span>
            {{ end }}

            {{/* Year */}}
            {{ with .Params.year }}
            <span class="text-sm font-medium text-neutral-500 dark:text-neutral-400">{{ . }}</span>
            {{ end }}
          </div>

          {{/* Title */}}
          <h2 class="card-title text-base leading-tight group-hover:text-primary transition-colors line-clamp-2">{{ .Title }}</h2>

          {{/* Description */}}
          {{ with .Description }}
          <p class="text-sm text-neutral-600 dark:text-neutral-400 line-clamp-2 mt-1">{{ . }}</p>
          {{ end }}

          {{/* Topics - colored badges like events page */}}
          {{ with $topics }}
          <div class="flex flex-wrap gap-1 mt-2">
            {{- $topicColors := dict "cybersecurity" "border-error text-error" "national-preparedness" "border-warning text-warning" "critical-infrastructure" "border-info text-info" "digital-sovereignty" "border-success text-success" "privacy" "border-secondary text-secondary" "digital-identity" "border-accent text-accent" -}}
            {{- range . }}
            {{- $label := index $topicLabels . | default (. | humanize | title) }}
            {{- $color := index $topicColors . | default "border-base-300" }}
            <span class="inline-flex items-center px-2 py-0.5 text-xs font-medium rounded-full border {{ $color }}">{{ $label }}</span>
            {{- end }}
          </div>
          {{ end }}

          {{/* Publisher/Institution */}}
          <div class="mt-auto pt-3 border-t border-base-200">
            <div class="flex items-center justify-between">
              {{/* Publisher or first institution */}}
              <span class="text-xs text-neutral-500 dark:text-neutral-500 truncate">
                {{ with .Params.publisher }}{{ . }}{{ else }}{{ with .Params.institutions }}{{ index . 0 }}{{ end }}{{ end }}
              </span>

              {{/* Credibility icons */}}
              <div class="flex items-center gap-1">
                {{ if .Params.open_access }}
                <span class="tooltip tooltip-left" data-tip="Open Access">
                  <svg class="w-4 h-4 text-success" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 11V7a4 4 0 118 0m-4 8v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2z" />
                  </svg>
                </span>
                {{ end }}
                {{ if .Params.peer_reviewed }}
                <span class="tooltip tooltip-left" data-tip="Peer Reviewed">
                  <svg class="w-4 h-4 text-info" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                </span>
                {{ end }}
              </div>
            </div>
          </div>
        </div>
      </a>
    </article>
    {{ end }}
  </div>

  {{/* No results message */}}
  <div id="no-results" class="hidden alert alert-warning my-4">
    <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>
    <span>No publications match the selected filters.</span>
  </div>

</article>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const filterButtons = document.querySelectorAll('[data-filter-group] button[data-filter]');
  const publicationCards = document.querySelectorAll('.publication-card');
  const noResults = document.getElementById('no-results');

  let activeFilters = {
    topics: 'all',
    audience: 'all'
  };

  function setActiveButton(filterGroup, filterValue) {
    const groupEl = document.querySelector(`[data-filter-group="${filterGroup}"]`);
    if (!groupEl) return;
    const btn = groupEl.querySelector(`button[data-filter="${filterValue}"]`);
    const fallback = groupEl.querySelector(`button[data-filter="all"]`);
    const target = btn || fallback;
    if (!target) return;

    // Update active state
    groupEl.querySelectorAll('button').forEach(b => {
      b.classList.remove('btn-active');
      b.classList.add('btn-ghost');
    });
    target.classList.add('btn-active');
    target.classList.remove('btn-ghost');

    activeFilters[filterGroup] = target.dataset.filter;
  }

  function updateURL() {
    const params = new URLSearchParams();
    if (activeFilters.topics && activeFilters.topics !== 'all') params.set('topic', activeFilters.topics);
    if (activeFilters.audience && activeFilters.audience !== 'all') params.set('audience', activeFilters.audience);
    const qs = params.toString();
    const newURL = qs ? `?${qs}` : window.location.pathname;
    history.replaceState(null, '', newURL);
  }

  function applyFilters() {
    let visibleCount = 0;

    publicationCards.forEach(card => {
      const cardTopics = card.dataset.topics || '';
      const cardAudience = card.dataset.audience || '';

      const matchesTopics = activeFilters.topics === 'all' || cardTopics.includes(activeFilters.topics);
      const matchesAudience = activeFilters.audience === 'all' || cardAudience.includes(activeFilters.audience);

      if (matchesTopics && matchesAudience) {
        card.style.display = '';
        visibleCount++;
      } else {
        card.style.display = 'none';
      }
    });

    if (visibleCount === 0) {
      noResults.classList.remove('hidden');
    } else {
      noResults.classList.add('hidden');
    }
  }

  // Initialize from URL
  const params = new URLSearchParams(window.location.search);
  const urlAudience = params.get('audience') || 'all';
  const urlTopic = params.get('topic') || params.get('topics') || 'all';

  setActiveButton('audience', urlAudience);
  setActiveButton('topics', urlTopic);
  applyFilters();

  filterButtons.forEach(btn => {
    btn.addEventListener('click', function() {
      const groupEl = this.closest('[data-filter-group]');
      const filterGroup = groupEl.dataset.filterGroup;
      const filterValue = this.dataset.filter;

      // Update active state
      groupEl.querySelectorAll('button').forEach(b => {
        b.classList.remove('btn-active');
        b.classList.add('btn-ghost');
      });
      this.classList.add('btn-active');
      this.classList.remove('btn-ghost');

      activeFilters[filterGroup] = filterValue;
      applyFilters();
      updateURL();
    });
  });
});
</script>
{{ end }}
