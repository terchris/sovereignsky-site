{{/*
Datacenter Provider Locations list (inline partial)
Usage: {{ partial "datacenter-provider-locations-inline.html" (dict "provider" $provider "regionsById" $regionsById) }}

Renders all datacenter locations for a provider, grouped by city.
Includes search functionality.
*/}}

{{ $provider := .provider | default dict }}
{{ $regionsById := .regionsById | default dict }}
{{ $providerRegions := $provider.regions | default (slice) }}

{{/* Build regions grouped by city */}}
{{ $regionsByCity := dict }}
{{ $cityOrder := slice }}
{{ $totalRegions := 0 }}
{{ range $providerRegions }}
  {{ $totalRegions = add $totalRegions 1 }}
  {{ $city := .city | default .regionName | default "Unknown" }}
  {{ $existing := index $regionsByCity $city | default (slice) }}
  {{ $regionsByCity = merge $regionsByCity (dict $city ($existing | append (dict
    "region" .
    "regionName" (.regionName | default .name | default $city)
    "countryId" .countryId
  ))) }}
  {{ if not (in $cityOrder $city) }}
    {{ $cityOrder = $cityOrder | append $city }}
  {{ end }}
{{ end }}
{{ $cityOrder = sort $cityOrder }}

{{ if gt $totalRegions 0 }}
{{/* Search input */}}
<div class="mb-4 not-prose">
  <input type="text"
         id="dc-provider-region-search"
         placeholder="Search regions, cities, countries..."
         class="w-full max-w-md px-4 py-2 text-sm border border-neutral-300 dark:border-neutral-600 rounded-lg bg-white dark:bg-neutral-800 text-neutral-900 dark:text-neutral-100 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent">
</div>

<div id="dc-provider-regions-container">
{{ range $cityOrder }}
  {{ $city := . }}
  {{ $items := index $regionsByCity $city }}
  {{ if $items }}
  <div class="dc-provider-city-group" data-city="{{ $city | lower }}">
    <h3 class="mt-6 mb-2 text-sm font-semibold text-neutral-700 dark:text-neutral-200">{{ $city }} <span class="font-normal text-neutral-400">({{ len $items }})</span></h3>
    <div class="flex flex-wrap gap-2">
      {{ range $items }}
      {{ $r := .region }}
      {{ $country := index $regionsById .countryId }}
      {{ $flag := "" }}
      {{ $countryName := .countryId }}
      {{ $risk := "unknown" }}
      {{ if $country }}
        {{ $flag = $country.flag }}
        {{ $countryName = $country.name }}
        {{ $risk = $country.riskLevel }}
      {{ end }}

      {{ $dot := "bg-neutral-400" }}
      {{ if eq $risk "low" }}{{ $dot = "bg-green-500" }}{{ end }}
      {{ if eq $risk "moderate" }}{{ $dot = "bg-yellow-500" }}{{ end }}
      {{ if eq $risk "elevated" }}{{ $dot = "bg-orange-500" }}{{ end }}
      {{ if eq $risk "high" }}{{ $dot = "bg-red-500" }}{{ end }}
      {{ if eq $risk "sanctioned" }}{{ $dot = "bg-red-700" }}{{ end }}

      <a class="dc-provider-region-chip inline-flex items-center gap-2 no-underline px-3 py-1 rounded-full border border-neutral-200 dark:border-neutral-700 bg-white dark:bg-neutral-900 hover:border-primary-400 dark:hover:border-primary-500 transition-colors text-sm"
        href="/datacenters/{{ .countryId | lower }}/"
        data-country="{{ $countryName | lower }}"
        data-region="{{ .regionName | lower }}"
        title="{{ $countryName }} • {{ .regionName }} • Risk: {{ $risk }}">
        <span class="inline-block w-2 h-2 rounded-full {{ $dot }}"></span>
        {{ if $flag }}<span>{{ $flag }}</span>{{ end }}
        <span class="font-medium">{{ $countryName }}</span>
        <span class="text-xs text-neutral-400 dark:text-neutral-500">{{ .regionName }}</span>
      </a>
      {{ end }}
    </div>
  </div>
  {{ end }}
{{ end }}
</div>

<p class="mt-4 text-sm text-neutral-500 dark:text-neutral-400" id="dc-provider-region-count">
  Showing <span id="dc-provider-visible-count">{{ $totalRegions }}</span> of {{ $totalRegions }} datacenter regions in {{ len $cityOrder }} cities
</p>

<script>
(function() {
  const searchInput = document.getElementById('dc-provider-region-search');
  const container = document.getElementById('dc-provider-regions-container');
  const countSpan = document.getElementById('dc-provider-visible-count');
  const totalCount = {{ $totalRegions }};

  if (!searchInput || !container) return;

  searchInput.addEventListener('input', function() {
    const query = this.value.toLowerCase().trim();
    let visibleCount = 0;

    container.querySelectorAll('.dc-provider-city-group').forEach(function(group) {
      const city = group.dataset.city;
      const chips = group.querySelectorAll('.dc-provider-region-chip');
      let groupVisible = false;

      chips.forEach(function(chip) {
        const country = chip.dataset.country;
        const region = chip.dataset.region;
        const matches = !query ||
                       city.includes(query) ||
                       country.includes(query) ||
                       region.includes(query);

        chip.style.display = matches ? '' : 'none';
        if (matches) {
          groupVisible = true;
          visibleCount++;
        }
      });

      group.style.display = groupVisible ? '' : 'none';
    });

    if (countSpan) {
      countSpan.textContent = visibleCount;
    }
  });
})();
</script>
{{ else }}
<p class="text-neutral-500 dark:text-neutral-400 text-sm italic">No datacenter locations found for this provider.</p>
{{ end }}
