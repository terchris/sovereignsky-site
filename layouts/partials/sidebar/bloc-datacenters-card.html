{{/* Datacenters Card - works for both countries and blocs */}}
{{/*
  Usage:
    Country: {{ partial "sidebar/bloc-datacenters-card.html" (dict "countryId" $countryId "countrySlug" $slug) }}
    Bloc:    {{ partial "sidebar/bloc-datacenters-card.html" (dict "allMembers" $allMembers) }}
*/}}

{{ $countryId := .countryId | default "" }}
{{ $countrySlug := .countrySlug | default "" }}
{{ $allMembers := .allMembers | default (slice) }}

{{/* If single country, create a one-item slice */}}
{{ if $countryId }}
  {{ $allMembers = slice $countryId }}
{{ end }}

{{ if gt (len $allMembers) 0 }}
  {{/* Count datacenters and providers across all member countries */}}
  {{ $datacenterCount := 0 }}
  {{ $providerCounts := dict }}

  {{ range (site.Data.datacenters.datacenters | default (slice)) }}
    {{ $providerName := .name }}
    {{ range (.regions | default (slice)) }}
      {{ $dcCountry := .countryId }}
      {{ if in $allMembers $dcCountry }}
        {{ $datacenterCount = add $datacenterCount 1 }}
        {{ $currentCount := index $providerCounts $providerName | default 0 }}
        {{ $providerCounts = merge $providerCounts (dict $providerName (add $currentCount 1)) }}
      {{ end }}
    {{ end }}
  {{ end }}

  {{ if gt $datacenterCount 0 }}
  <div class="card bg-base-100 shadow-sm border border-base-300">
    <div class="card-body p-4">
      <h3 class="card-title text-sm font-semibold flex items-center gap-2">
        {{ partial "content-icon.html" (dict "name" "server" "color" "secondary" "size" "4") }}
        Datacenters
      </h3>
      {{ if $countryId }}
      <p class="text-xs opacity-60 -mt-1">{{ $datacenterCount }} regions in country</p>
      {{ else }}
      <p class="text-xs opacity-60 -mt-1">{{ $datacenterCount }} regions across member countries</p>
      {{ end }}

      {{/* Build sorted provider list */}}
      {{ $sortedProviders := slice }}
      {{ range $name, $count := $providerCounts }}
        {{ $sortedProviders = $sortedProviders | append (dict "name" $name "count" $count) }}
      {{ end }}

      <div class="mt-2 space-y-1">
        {{ range first 5 (sort $sortedProviders "count" "desc") }}
        <div class="flex justify-between items-center text-sm">
          <a href="/datacenters/#{{ .name | urlize }}" class="hover:text-secondary no-underline">{{ .name }}</a>
          <span class="badge badge-sm badge-ghost">{{ .count }}</span>
        </div>
        {{ end }}
      </div>

      {{ if $countrySlug }}
      <a href="/datacenters/{{ $countrySlug }}/" class="btn btn-sm btn-outline btn-secondary mt-3 gap-2">
        View Datacenter Map
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"/>
        </svg>
      </a>
      {{ else }}
      <a href="/datacenters/" class="btn btn-sm btn-outline btn-secondary mt-3 gap-2">
        Browse All Datacenters
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"/>
        </svg>
      </a>
      {{ end }}
    </div>
  </div>
  {{ end }}
{{ end }}
