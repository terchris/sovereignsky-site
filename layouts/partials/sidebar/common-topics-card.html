{{/*
  Topics Card - displays topics with icons from topics.json

  Supports two modes:
  1. Page context: reads from .Params.topics (frontmatter)
  2. Persona context: reads from audience.json via persona_id
*/}}

{{/* Determine topics source */}}
{{ $topics := slice }}

{{/* First try page params */}}
{{ with .Params.topics }}
  {{ $topics = . }}
{{ end }}

{{/* If no topics in params, try persona data */}}
{{ if eq (len $topics) 0 }}
  {{ $personaId := .Params.persona_id | default (path.Base .File.Dir) }}
  {{ $audienceData := site.Data.audience.audience }}
  {{ range $audienceData.itemListElement }}
    {{ if eq .identifier $personaId }}
      {{ $topics = .topics | default (slice) }}
    {{ end }}
  {{ end }}
{{ end }}

{{ $topicsList := site.Data.topics.topics.itemListElement | default (slice) }}

{{/* Count content per topic */}}
{{ $topicCounts := dict }}
{{ range site.RegularPages }}
  {{ $pageTopics := .Params.topics | default (slice) }}
  {{ range $pageTopics }}
    {{ $count := index $topicCounts . | default 0 }}
    {{ $topicCounts = merge $topicCounts (dict . (add $count 1)) }}
  {{ end }}
{{ end }}

{{ if gt (len $topics) 0 }}
<div class="card bg-base-100 shadow-sm border border-base-300">
  <div class="card-body p-4">
    <h3 class="card-title text-sm font-semibold flex items-center gap-2">
      {{ partial "content-icon.html" (dict "name" "tag" "color" "secondary" "size" "4") }}
      Topics
    </h3>
    <ul class="mt-2 space-y-1">
      {{ range $topics }}
      {{ $topicId := . }}
      {{ $topic := dict }}
      {{ range $topicsList }}
        {{ if eq .identifier $topicId }}
          {{ $topic = . }}
        {{ end }}
      {{ end }}
      {{ $name := $topic.name | default ($topicId | humanize | title) }}
      {{ $iconPath := $topic.iconPath | default "" }}
      {{ $count := index $topicCounts $topicId | default 0 }}
      <li class="flex items-center gap-2 text-sm">
        {{ if gt $count 0 }}
        <a href="/topics/{{ $topicId }}/" class="flex items-center gap-2 hover:text-primary">
          {{ if $iconPath }}
          <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="{{ $iconPath }}"/>
          </svg>
          {{ end }}
          {{ $name }}
          <span class="badge badge-xs badge-ghost">{{ $count }}</span>
        </a>
        {{ else }}
        <span class="flex items-center gap-2 text-neutral-400">
          {{ if $iconPath }}
          <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="{{ $iconPath }}"/>
          </svg>
          {{ end }}
          {{ $name }}
        </span>
        {{ end }}
      </li>
      {{ end }}
    </ul>
  </div>
</div>
{{ end }}
