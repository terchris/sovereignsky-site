{{/* Bloc Laws Summary Card - shows laws by type for a bloc */}}
{{ $blocId := .blocId }}
{{ $bloc := .bloc }}
{{ $blocsById := .blocsById }}
{{ $page := .page }}

{{ if $blocId }}
  {{/* Build applicable bloc IDs (this bloc + inherited) */}}
  {{ $applicableBlocIds := slice $blocId }}
  {{ range ($bloc.inheritsFrom | default (slice)) }}
    {{ $applicableBlocIds = $applicableBlocIds | append . }}
    {{ $parent := index $blocsById . }}
    {{ if $parent }}
      {{ range ($parent.inheritsFrom | default (slice)) }}
        {{ $applicableBlocIds = $applicableBlocIds | append . }}
      {{ end }}
    {{ end }}
  {{ end }}

  {{/* Count laws by type */}}
  {{ $totalLaws := 0 }}
  {{ $byType := dict }}
  {{ $seenLaws := slice }}

  {{ range site.Data.laws.laws.itemListElement }}
    {{ $law := . }}
    {{ $lawId := .identifier }}
    {{ range .legislationJurisdiction }}
      {{ $applyTo := . }}
      {{ range $applicableBlocIds }}
        {{ if eq $applyTo . }}
          {{ $alreadyCounted := false }}
          {{ range $seenLaws }}
            {{ if eq . $lawId }}{{ $alreadyCounted = true }}{{ end }}
          {{ end }}
          {{ if not $alreadyCounted }}
            {{ $totalLaws = add $totalLaws 1 }}
            {{ $lawType := $law.category | default "other" }}
            {{ $currentCount := index $byType $lawType | default 0 }}
            {{ $byType = merge $byType (dict $lawType (add $currentCount 1)) }}
            {{ $seenLaws = $seenLaws | append $lawId }}
          {{ end }}
        {{ end }}
      {{ end }}
    {{ end }}
  {{ end }}

  {{ if gt $totalLaws 0 }}
  <div class="card bg-base-100 shadow-sm border border-base-300">
    <div class="card-body p-4">
      <h3 class="card-title text-sm font-semibold flex items-center gap-2">
        {{ partial "icon.html" (dict "name" "scale" "color" "primary" "size" "4") }}
        Laws by Type
      </h3>
      <p class="text-xs opacity-60 -mt-1">{{ $totalLaws }} applicable laws</p>
      <div class="mt-2 space-y-3">
        {{ range site.Data.laws.law_types.itemListElement }}
          {{ $type := .identifier }}
          {{ $count := index $byType $type }}
          {{ if $count }}
            <a href="#{{ $type }}-laws" class="block p-2 rounded-lg bg-base-200 hover:bg-base-300 transition-colors no-underline">
              <div class="flex justify-between items-center">
                <span class="font-medium text-sm">{{ .emoji }} {{ .shortName }}</span>
                <span class="badge badge-sm">{{ $count }}</span>
              </div>
              <p class="text-xs opacity-60 mt-1 leading-tight">{{ .description }}</p>
            </a>
          {{ end }}
        {{ end }}
      </div>
    </div>
  </div>
  {{ end }}
{{ end }}
