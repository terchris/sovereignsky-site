{{/* Universal Related Content for Sidebar
     Shows all related content based on matching tags:
     - Laws (from data/laws.json where law ID matches a tag, or applies to country_id)
     - Blog posts (with matching tags)
     - Publications (with matching tags)
     - Any other content types with matching tags

     Also supports:
     - country_id for datacenter/jurisdiction pages without tags
     - applies_to for law pages (finds content with matching country tags or law_id tag)
     - law_id for law pages (finds content with the law ID as a tag)

     Usage:
     - {{ partial "related-content-sidebar.html" . }}
     - {{ partial "related-content-sidebar.html" (dict "page" . "countryId" "NO") }}
*/}}

{{/* Support both direct page context and dict with page key */}}
{{ $currentPage := . }}
{{ $explicitCountryId := "" }}
{{/* Check if this is a dict with "page" key by checking for Permalink (pages have it, dicts don't) */}}
{{ if not .Permalink }}
  {{ $currentPage = .page }}
  {{ $explicitCountryId = .countryId | default "" }}
{{ end }}

{{ $pageTags := $currentPage.Params.tags | default (slice) }}
{{ $countryId := $explicitCountryId | default ($currentPage.Params.countryId | default $currentPage.Params.country_id | default "") }}
{{ $appliesTo := $currentPage.Params.applies_to | default (slice) }}
{{ $lawId := $currentPage.Params.law_id | default "" }}

{{/* Build a lookup of tag -> true for O(1) lookup */}}
{{/* Include: page tags, applies_to countries, and law_id */}}
{{ $tagLookup := dict }}
{{ range $pageTags }}
  {{ $tagLookup = merge $tagLookup (dict . true) }}
{{ end }}
{{ range $appliesTo }}
  {{ $tagLookup = merge $tagLookup (dict . true) }}
{{ end }}
{{ if $lawId }}
  {{ $tagLookup = merge $tagLookup (dict $lawId true) }}
{{ end }}

{{/* Find laws whose ID matches a tag OR applies to this country_id */}}
{{/* Exclude the current law page (if this is a law page) */}}
{{ $relatedLaws := slice }}
{{ range (site.Data.laws.laws.laws | default (slice)) }}
  {{ $law := . }}
  {{ $matched := false }}
  {{/* Skip if this is the current law page */}}
  {{ if and $lawId (eq .identifier $lawId) }}
    {{ $matched = false }}
  {{ else }}
    {{/* Match by tag */}}
    {{ if index $tagLookup .id }}
      {{ $matched = true }}
    {{ end }}
    {{/* Match by country_id in applies_to */}}
    {{ if and $countryId (not $matched) }}
      {{ range (.applies_to | default (slice)) }}
        {{ if eq . $countryId }}
          {{ $matched = true }}
        {{ end }}
      {{ end }}
    {{ end }}
  {{ end }}
  {{ if $matched }}
    {{ $relatedLaws = $relatedLaws | append $law }}
  {{ end }}
{{ end }}

{{/* Find all other pages with matching tags (excluding current page) */}}
{{/* Match if tagLookup has any entries (from tags, applies_to, or law_id) */}}
{{ $relatedPages := slice }}
{{ if gt (len $tagLookup) 0 }}
  {{ range site.RegularPages }}
    {{ if ne .Permalink $currentPage.Permalink }}
      {{ $page := . }}
      {{ $matched := false }}
      {{ range .Params.tags }}
        {{ if index $tagLookup . }}
          {{ $matched = true }}
        {{ end }}
      {{ end }}
      {{ if $matched }}
        {{ $relatedPages = $relatedPages | append $page }}
      {{ end }}
    {{ end }}
  {{ end }}
{{ end }}

{{/* Group pages by type for display */}}
{{ $blogPosts := slice }}
{{ $publications := slice }}
{{ $otherPages := slice }}
{{ range $relatedPages }}
  {{ if eq .Type "blog" }}
    {{ $blogPosts = $blogPosts | append . }}
  {{ else if eq .Type "publications" }}
    {{ $publications = $publications | append . }}
  {{ else }}
    {{ $otherPages = $otherPages | append . }}
  {{ end }}
{{ end }}

{{/* Only show section if we have any related content */}}
{{ $hasContent := or (gt (len $relatedLaws) 0) (gt (len $relatedPages) 0) }}
{{ if $hasContent }}
  {{/* Get content types from vocabulary */}}
  {{ $contentTypes := site.Data.hugo.ui_vocabulary.contentTypes | default (dict) }}
  {{ $icons := $contentTypes.icons | default (dict) }}
  {{ $colors := $contentTypes.colors | default (dict) }}

  <div class="card bg-base-100 shadow-sm border border-base-300">
    <div class="card-body p-4">
      <h3 class="card-title text-sm font-semibold flex items-center gap-2">
        {{ partial "data-icon.html" (dict "name" "link" "color" "info" "size" "4") }}
        Related
      </h3>
      <div class="space-y-1 mt-3">
        {{/* Laws */}}
        {{ $lawIcon := index $icons "law" | default "scale" }}
        {{ $lawColor := index $colors "law" | default "warning" }}
        {{ range $relatedLaws }}
        <a href="/laws/{{ .id }}/" class="flex items-center gap-3 p-2 rounded-lg hover:bg-base-200 transition-colors group">
          <div class="w-8 h-8 rounded-full bg-{{ $lawColor }}/10 flex items-center justify-center flex-shrink-0">
            {{ partial "data-icon.html" (dict "name" $lawIcon "color" $lawColor "size" "4") }}
          </div>
          <span class="text-sm group-hover:text-primary truncate">{{ .name }}{{ if .year }} <span class="opacity-60">({{ .year }})</span>{{ end }}</span>
        </a>
        {{ end }}

        {{/* Blog posts */}}
        {{ $blogIcon := index $icons "blog" | default "pencil" }}
        {{ $blogColor := index $colors "blog" | default "info" }}
        {{ range first 3 $blogPosts }}
        <a href="{{ .RelPermalink }}" class="flex items-center gap-3 p-2 rounded-lg hover:bg-base-200 transition-colors group">
          <div class="w-8 h-8 rounded-full bg-{{ $blogColor }}/10 flex items-center justify-center flex-shrink-0">
            {{ partial "data-icon.html" (dict "name" $blogIcon "color" $blogColor "size" "4") }}
          </div>
          <span class="text-sm group-hover:text-primary line-clamp-2">{{ .Title }}</span>
        </a>
        {{ end }}

        {{/* Publications */}}
        {{ $pubIcon := index $icons "publications" | default "book" }}
        {{ $pubColor := index $colors "publications" | default "primary" }}
        {{ range first 2 $publications }}
        <a href="{{ .RelPermalink }}" class="flex items-center gap-3 p-2 rounded-lg hover:bg-base-200 transition-colors group">
          <div class="w-8 h-8 rounded-full bg-{{ $pubColor }}/10 flex items-center justify-center flex-shrink-0">
            {{ partial "data-icon.html" (dict "name" $pubIcon "color" $pubColor "size" "4") }}
          </div>
          <span class="text-sm group-hover:text-primary line-clamp-2">{{ .Title }}</span>
        </a>
        {{ end }}

        {{/* Other content types */}}
        {{ range first 2 $otherPages }}
        {{ $pageType := .Type }}
        {{ $otherIcon := index $icons $pageType | default "document" }}
        {{ $otherColor := index $colors $pageType | default "secondary" }}
        <a href="{{ .RelPermalink }}" class="flex items-center gap-3 p-2 rounded-lg hover:bg-base-200 transition-colors group">
          <div class="w-8 h-8 rounded-full bg-{{ $otherColor }}/10 flex items-center justify-center flex-shrink-0">
            {{ partial "data-icon.html" (dict "name" $otherIcon "color" $otherColor "size" "4") }}
          </div>
          <span class="text-sm group-hover:text-primary line-clamp-2">{{ .Title }}</span>
        </a>
        {{ end }}
      </div>
    </div>
  </div>
{{ end }}
