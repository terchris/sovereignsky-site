{{/*
  Inline partial for jurisdiction laws - used by country.html layout
  Same logic as the jurisdiction-laws shortcode but callable from layouts

  Parameters:
    jurisdictionId: The country/bloc ID (e.g., "NO", "eu")
    country: The country object from regions.json (optional, for optimization)
*/}}

{{ $jurisdictionId := .jurisdictionId | default "" }}
{{ $country := .country | default dict }}
{{ $laws := site.Data.laws.laws | default (slice) }}
{{ $regions := site.Data.regions | default (slice) }}
{{ $blocs := site.Data.jurisdictions.blocs | default (slice) }}

{{/* Build list of all applicable jurisdiction IDs (including inherited) */}}
{{ $applicableIds := slice $jurisdictionId }}
{{ $inheritanceMap := dict }}

{{/* Get country blocs - use passed country or look it up */}}
{{ $countryBlocs := slice }}
{{ if $country }}
  {{ $countryBlocs = $country.blocs | default (slice) }}
{{ else }}
  {{ range $regions }}
    {{ if eq .id $jurisdictionId }}
      {{ $countryBlocs = .blocs | default (slice) }}
    {{ end }}
  {{ end }}
{{ end }}

{{/* Add bloc IDs and their inheritance */}}
{{ range $countryBlocs }}
  {{ $blocId := . }}
  {{ $applicableIds = $applicableIds | append $blocId }}
  {{/* Find this bloc and check for inherits_from */}}
  {{ range $blocs }}
    {{ if eq .id $blocId }}
      {{ $inheritedFrom := .inherits_from | default (slice) }}
      {{ range $inheritedFrom }}
        {{ $applicableIds = $applicableIds | append . }}
        {{ $inheritanceMap = merge $inheritanceMap (dict . $blocId) }}
      {{ end }}
    {{ end }}
  {{ end }}
{{ end }}

{{/* Also check if this jurisdiction is itself a bloc with inherits_from */}}
{{ range $blocs }}
  {{ if eq .id $jurisdictionId }}
    {{ $inheritedFrom := .inherits_from | default (slice) }}
    {{ range $inheritedFrom }}
      {{ $applicableIds = $applicableIds | append . }}
      {{ $inheritanceMap = merge $inheritanceMap (dict . $jurisdictionId) }}
    {{ end }}
  {{ end }}
{{ end }}

{{/* Filter laws that apply to any of the applicable jurisdictions */}}
{{ $jurisdictionLaws := slice }}
{{ $lawSources := dict }}
{{ range $laws }}
  {{ $law := . }}
  {{ $lawId := .id }}
  {{ range .applies_to }}
    {{ $applyTo := . }}
    {{ range $applicableIds }}
      {{ if eq $applyTo . }}
        {{/* Check if we already have this law */}}
        {{ $alreadyAdded := false }}
        {{ range $jurisdictionLaws }}
          {{ if eq .id $lawId }}
            {{ $alreadyAdded = true }}
          {{ end }}
        {{ end }}
        {{ if not $alreadyAdded }}
          {{ $jurisdictionLaws = $jurisdictionLaws | append $law }}
          {{ $lawSources = merge $lawSources (dict $lawId $applyTo) }}
        {{ end }}
      {{ end }}
    {{ end }}
  {{ end }}
{{ end }}

{{/* Group by law type */}}
{{ $byType := dict }}
{{ range $jurisdictionLaws }}
  {{ $type := .type | default "other" }}
  {{ $existing := index $byType $type | default (slice) }}
  {{ $byType = merge $byType (dict $type ($existing | append .)) }}
{{ end }}

{{/* Get law type vocabulary from centralized data */}}
{{ $lawTypes := site.Data.tag_vocabulary.lawTypes | default (dict) }}
{{ $typeOrder := $lawTypes.values | default (slice "privacy" "access" "surveillance" "localization" "security" "sector") }}
{{ $typeLabels := $lawTypes.labels | default (dict "privacy" "Privacy Laws" "access" "Access Laws" "surveillance" "Surveillance Laws" "localization" "Localization Laws" "security" "Security Laws" "sector" "Sector-Specific Laws") }}
{{ $typeEmojis := $lawTypes.emojis | default (dict "privacy" "üõ°Ô∏è" "access" "üîì" "surveillance" "üëÅÔ∏è" "localization" "üìç" "security" "üîí" "sector" "üìã") }}
{{ $typeDescriptions := $lawTypes.descriptions | default (dict "privacy" "Laws that protect individual data rights and privacy" "access" "Laws that enable government or law enforcement data access" "surveillance" "Laws that establish surveillance infrastructure or powers" "localization" "Laws that require data to be stored within jurisdiction" "security" "National security frameworks" "sector" "Laws regulating specific sectors") }}
{{ $typeBadgeClasses := $lawTypes.badgeClasses | default (dict "privacy" "badge-success" "access" "badge-warning" "surveillance" "badge-error" "localization" "badge-info" "security" "badge-secondary" "sector" "badge-ghost") }}

{{ if gt (len $jurisdictionLaws) 0 }}
<div class="not-prose">
  {{ range $typeOrder }}
    {{ $type := . }}
    {{ $lawsOfType := index $byType $type }}
    {{ if $lawsOfType }}
    <div class="mb-10" id="{{ $type }}-laws">
      {{/* Section header */}}
      <div class="flex items-center gap-3 mb-4">
        <span class="text-2xl">{{ index $typeEmojis $type }}</span>
        <div>
          <h3 class="text-xl font-bold text-base-content m-0">{{ index $typeLabels $type }}</h3>
          <p class="text-sm opacity-70 m-0">{{ index $typeDescriptions $type }}</p>
        </div>
      </div>

      {{/* Law cards */}}
      <div class="space-y-6">
        {{ range $lawsOfType }}
        {{/* Determine source of this law */}}
        {{ $lawSource := index $lawSources .id }}
        {{ $isNational := eq $lawSource $jurisdictionId }}
        {{ $sourceLabel := "" }}
        {{ $sourceBadgeClass := "badge-ghost" }}
        {{ if $isNational }}
          {{ $countryFlag := "" }}
          {{ range $regions }}
            {{ if eq .id $jurisdictionId }}
              {{ $countryFlag = .flag | default "" }}
            {{ end }}
          {{ end }}
          {{ if $countryFlag }}
            {{ $sourceLabel = printf "%s National" $countryFlag }}
          {{ else }}
            {{ $sourceLabel = "National" }}
          {{ end }}
          {{ $sourceBadgeClass = "badge-primary" }}
        {{ else }}
          {{ $sourceName := $lawSource }}
          {{ $sourceFlag := "" }}
          {{ range $blocs }}
            {{ if eq .id $lawSource }}
              {{ $sourceName = .name }}
              {{ $sourceFlag = .flag | default "" }}
            {{ end }}
          {{ end }}
          {{ if $sourceFlag }}
            {{ $sourceLabel = printf "via %s %s" $sourceFlag $sourceName }}
          {{ else }}
            {{ $sourceLabel = printf "via %s" $sourceName }}
          {{ end }}
        {{ end }}

        {{/* Card */}}
        <div class="card bg-base-100 shadow-md hover:shadow-lg transition-shadow border border-base-300">
          <div class="card-body p-6">
            {{/* Header row */}}
            <div class="flex items-start justify-between gap-4">
              <div class="flex-1">
                <div class="flex items-center gap-2 flex-wrap mb-1">
                  <h4 class="card-title text-lg m-0">
                    <a href="/laws/{{ .id }}/" class="link link-hover hover:text-primary">
                      {{ .name }} ({{ .year }})
                    </a>
                  </h4>
                  <div class="badge {{ $sourceBadgeClass }} badge-sm">{{ $sourceLabel }}</div>
                </div>
                <p class="text-sm opacity-60 m-0">{{ .full_name }}</p>
              </div>
              <a href="/laws/{{ .id }}/" class="btn btn-ghost btn-sm">
                Details
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                </svg>
              </a>
            </div>

            {{/* Summary */}}
            <p class="text-sm mt-2 mb-3">{{ .summary }}</p>

            {{/* Attributes */}}
            <div class="flex flex-wrap gap-2">
              {{/* Government Access */}}
              {{ $accessBadge := "badge-ghost" }}
              {{ if eq .government_access "broad" }}{{ $accessBadge = "badge-error" }}{{ end }}
              {{ if eq .government_access "targeted" }}{{ $accessBadge = "badge-warning" }}{{ end }}
              {{ if eq .government_access "limited" }}{{ $accessBadge = "badge-success" }}{{ end }}
              <div class="badge {{ $accessBadge }} gap-1">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                </svg>
                Gov: {{ .government_access }}
              </div>

              {{/* Data Protection */}}
              {{ if and .data_protection (ne .data_protection "none") }}
              {{ $protBadge := "badge-ghost" }}
              {{ if eq .data_protection "strong" }}{{ $protBadge = "badge-success" }}{{ end }}
              {{ if eq .data_protection "moderate" }}{{ $protBadge = "badge-warning" }}{{ end }}
              {{ if eq .data_protection "weak" }}{{ $protBadge = "badge-error" }}{{ end }}
              <div class="badge {{ $protBadge }} gap-1">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                </svg>
                Protection: {{ .data_protection }}
              </div>
              {{ end }}

              {{/* Boolean flags */}}
              {{ if .extraterritorial }}
              <div class="badge badge-secondary gap-1">
                üåç Extraterritorial
              </div>
              {{ end }}

              {{ if .requires_localization }}
              <div class="badge badge-info gap-1">
                üìç Localization Required
              </div>
              {{ end }}

              {{ if .requires_backdoor }}
              <div class="badge badge-error gap-1">
                üîë Backdoor Required
              </div>
              {{ end }}
            </div>
          </div>
        </div>
        {{ end }}
      </div>
    </div>
    {{ end }}
  {{ end }}
</div>
{{ else }}
<div class="alert">
  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-info shrink-0 w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
  <span>No laws found for this jurisdiction.</span>
</div>
{{ end }}
