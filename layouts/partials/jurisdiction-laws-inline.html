{{/*
  Inline partial for jurisdiction laws - used by country.html layout
  Same logic as the jurisdiction-laws shortcode but callable from layouts

  Parameters:
    jurisdictionId: The country/bloc ID (e.g., "NO", "eu")
    country: The country object from regions.json (optional, for optimization)
*/}}

{{ $jurisdictionId := .jurisdictionId | default "" }}
{{ $country := .country | default dict }}
{{ $laws := site.Data.laws.laws.itemListElement | default (slice) }}
{{ $regions := site.Data.countries.countries.itemListElement }}
{{ $blocs := site.Data.blocs.blocs.itemListElement | default (slice) }}

{{/* Build list of all applicable jurisdiction IDs (including inherited) */}}
{{ $applicableIds := slice $jurisdictionId }}
{{ $inheritanceMap := dict }}

{{/* Get country blocs - use passed country or look it up */}}
{{ $countryBlocs := slice }}
{{ if $country }}
  {{ $countryBlocs = $country.blocs | default (slice) }}
{{ else }}
  {{ range $regions }}
    {{ if eq .identifier $jurisdictionId }}
      {{ $countryBlocs = .blocs | default (slice) }}
    {{ end }}
  {{ end }}
{{ end }}

{{/* Add bloc IDs and their inheritance */}}
{{ range $countryBlocs }}
  {{ $blocId := . }}
  {{ $applicableIds = $applicableIds | append $blocId }}
  {{/* Find this bloc and check for inherits_from */}}
  {{ range $blocs }}
    {{ if eq .identifier $blocId }}
      {{ $inheritedFrom := .inheritsFrom | default (slice) }}
      {{ range $inheritedFrom }}
        {{ $applicableIds = $applicableIds | append . }}
        {{ $inheritanceMap = merge $inheritanceMap (dict . $blocId) }}
      {{ end }}
    {{ end }}
  {{ end }}
{{ end }}

{{/* Also check if this jurisdiction is itself a bloc with inherits_from */}}
{{ range $blocs }}
  {{ if eq .identifier $jurisdictionId }}
    {{ $inheritedFrom := .inheritsFrom | default (slice) }}
    {{ range $inheritedFrom }}
      {{ $applicableIds = $applicableIds | append . }}
      {{ $inheritanceMap = merge $inheritanceMap (dict . $jurisdictionId) }}
    {{ end }}
  {{ end }}
{{ end }}

{{/* Filter laws that apply to any of the applicable jurisdictions */}}
{{ $jurisdictionLaws := slice }}
{{ $lawSources := dict }}
{{ range $laws }}
  {{ $law := . }}
  {{ $lawId := .identifier }}
  {{ range .legislationJurisdiction }}
    {{ $applyTo := . }}
    {{ range $applicableIds }}
      {{ if eq $applyTo . }}
        {{/* Check if we already have this law */}}
        {{ $alreadyAdded := false }}
        {{ range $jurisdictionLaws }}
          {{ if eq .identifier $lawId }}
            {{ $alreadyAdded = true }}
          {{ end }}
        {{ end }}
        {{ if not $alreadyAdded }}
          {{ $jurisdictionLaws = $jurisdictionLaws | append $law }}
          {{ $lawSources = merge $lawSources (dict $lawId $applyTo) }}
        {{ end }}
      {{ end }}
    {{ end }}
  {{ end }}
{{ end }}

{{/* Group by law type (category in Schema.org format) */}}
{{ $byType := dict }}
{{ range $jurisdictionLaws }}
  {{ $type := .category | default "other" }}
  {{ $existing := index $byType $type | default (slice) }}
  {{ $byType = merge $byType (dict $type ($existing | append .)) }}
{{ end }}

{{/* Get law type vocabulary from law_types.json */}}
{{ $lawTypesData := site.Data.laws.law_types.itemListElement | default (slice) }}
{{ $typeOrder := slice }}
{{ $typeLabels := dict }}
{{ $typeEmojis := dict }}
{{ $typeDescriptions := dict }}
{{ $typeBadgeClasses := dict }}
{{ range $lawTypesData }}
  {{ $typeOrder = $typeOrder | append .identifier }}
  {{ $typeLabels = merge $typeLabels (dict .identifier .name) }}
  {{ $typeEmojis = merge $typeEmojis (dict .identifier .emoji) }}
  {{ $typeDescriptions = merge $typeDescriptions (dict .identifier .description) }}
  {{ $typeBadgeClasses = merge $typeBadgeClasses (dict .identifier .badgeClass) }}
{{ end }}

{{ if gt (len $jurisdictionLaws) 0 }}
<div class="not-prose">
  {{ range $typeOrder }}
    {{ $type := . }}
    {{ $lawsOfType := index $byType $type }}
    {{ if $lawsOfType }}
    <div class="mb-8" id="{{ $type }}-laws">
      {{/* Section header - compact */}}
      <div class="flex items-center gap-2 mb-3 pb-2 border-b border-base-200">
        <span class="text-xl">{{ index $typeEmojis $type }}</span>
        <h3 class="text-base font-semibold text-base-content m-0">{{ index $typeLabels $type }}</h3>
        <span class="text-xs text-neutral-500">({{ len $lawsOfType }})</span>
      </div>

      {{/* Law cards - compact grid */}}
      <div class="grid gap-2 sm:grid-cols-2">
        {{ range $lawsOfType }}
        {{/* Determine source of this law */}}
        {{ $lawSource := index $lawSources .identifier }}
        {{ $isNational := eq $lawSource $jurisdictionId }}
        {{ $sourceFlag := "" }}
        {{ if $isNational }}
          {{ range $regions }}
            {{ if eq .identifier $jurisdictionId }}
              {{ $sourceFlag = .flag | default "" }}
            {{ end }}
          {{ end }}
        {{ else }}
          {{ range $blocs }}
            {{ if eq .identifier $lawSource }}
              {{ $sourceFlag = .flag | default "" }}
            {{ end }}
          {{ end }}
        {{ end }}

        {{/* Compact card */}}
        <a href="/laws/{{ .identifier }}/" class="group flex items-center gap-3 p-3 rounded-lg border border-base-200 hover:border-primary/50 hover:bg-base-100 transition-all no-underline">
          {{/* Flag */}}
          {{ if $sourceFlag }}
          <span class="text-xl flex-shrink-0">{{ $sourceFlag }}</span>
          {{ else }}
          <div class="flex-shrink-0">
            {{ partial "content-icon.html" (dict "name" "scale" "size" "5" "class" "text-base-content/40") }}
          </div>
          {{ end }}

          {{/* Content */}}
          <div class="flex-1 min-w-0">
            {{/* Title */}}
            <div class="font-medium text-sm leading-snug group-hover:text-primary transition-colors line-clamp-1">
              {{ .name }}
            </div>

            {{/* Alternate name */}}
            {{ with .alternateName }}
            <div class="text-xs text-neutral-500 dark:text-neutral-400 line-clamp-1 mt-0.5">{{ . }}</div>
            {{ end }}
          </div>

          {{/* Year + key badges */}}
          <div class="flex items-center gap-1.5 flex-shrink-0">
            {{- if .extraterritorial }}<span class="text-xs" title="Extraterritorial">üåç</span>{{ end -}}
            {{- if .requiresLocalization }}<span class="text-xs" title="Localization Required">üìç</span>{{ end -}}
            {{- if .requiresBackdoor }}<span class="text-xs" title="Backdoor Required">üîë</span>{{ end -}}
            <span class="text-xs text-neutral-400">{{ .legislationDate }}</span>
          </div>
        </a>
        {{ end }}
      </div>
    </div>
    {{ end }}
  {{ end }}
</div>
{{ else }}
<div class="alert">
  {{ partial "content-icon.html" (dict "name" "info" "color" "info" "size" "6" "class" "shrink-0") }}
  <span>No laws found for this jurisdiction.</span>
</div>
{{ end }}
