{{/*
  Inline partial for jurisdiction laws - used by country.html layout
  Same logic as the jurisdiction-laws shortcode but callable from layouts

  Parameters:
    jurisdictionId: The country/bloc ID (e.g., "NO", "eu")
    country: The country object from regions.json (optional, for optimization)
*/}}

{{ $jurisdictionId := .jurisdictionId | default "" }}
{{ $country := .country | default dict }}
{{ $laws := site.Data.laws.laws.itemListElement | default (slice) }}
{{ $regions := site.Data.countries.countries.itemListElement }}
{{ $blocs := site.Data.blocs.blocs.itemListElement | default (slice) }}

{{/* Build list of all applicable jurisdiction IDs (including inherited) */}}
{{ $applicableIds := slice $jurisdictionId }}
{{ $inheritanceMap := dict }}

{{/* Get country blocs - use passed country or look it up */}}
{{ $countryBlocs := slice }}
{{ if $country }}
  {{ $countryBlocs = $country.blocs | default (slice) }}
{{ else }}
  {{ range $regions }}
    {{ if eq .identifier $jurisdictionId }}
      {{ $countryBlocs = .blocs | default (slice) }}
    {{ end }}
  {{ end }}
{{ end }}

{{/* Add bloc IDs and their inheritance */}}
{{ range $countryBlocs }}
  {{ $blocId := . }}
  {{ $applicableIds = $applicableIds | append $blocId }}
  {{/* Find this bloc and check for inherits_from */}}
  {{ range $blocs }}
    {{ if eq .identifier $blocId }}
      {{ $inheritedFrom := .inheritsFrom | default (slice) }}
      {{ range $inheritedFrom }}
        {{ $applicableIds = $applicableIds | append . }}
        {{ $inheritanceMap = merge $inheritanceMap (dict . $blocId) }}
      {{ end }}
    {{ end }}
  {{ end }}
{{ end }}

{{/* Also check if this jurisdiction is itself a bloc with inherits_from */}}
{{ range $blocs }}
  {{ if eq .identifier $jurisdictionId }}
    {{ $inheritedFrom := .inheritsFrom | default (slice) }}
    {{ range $inheritedFrom }}
      {{ $applicableIds = $applicableIds | append . }}
      {{ $inheritanceMap = merge $inheritanceMap (dict . $jurisdictionId) }}
    {{ end }}
  {{ end }}
{{ end }}

{{/* Filter laws that apply to any of the applicable jurisdictions */}}
{{ $jurisdictionLaws := slice }}
{{ $lawSources := dict }}
{{ range $laws }}
  {{ $law := . }}
  {{ $lawId := .identifier }}
  {{ range .legislationJurisdiction }}
    {{ $applyTo := . }}
    {{ range $applicableIds }}
      {{ if eq $applyTo . }}
        {{/* Check if we already have this law */}}
        {{ $alreadyAdded := false }}
        {{ range $jurisdictionLaws }}
          {{ if eq .identifier $lawId }}
            {{ $alreadyAdded = true }}
          {{ end }}
        {{ end }}
        {{ if not $alreadyAdded }}
          {{ $jurisdictionLaws = $jurisdictionLaws | append $law }}
          {{ $lawSources = merge $lawSources (dict $lawId $applyTo) }}
        {{ end }}
      {{ end }}
    {{ end }}
  {{ end }}
{{ end }}

{{/* Group by law type (category in Schema.org format) */}}
{{ $byType := dict }}
{{ range $jurisdictionLaws }}
  {{ $type := .category | default "other" }}
  {{ $existing := index $byType $type | default (slice) }}
  {{ $byType = merge $byType (dict $type ($existing | append .)) }}
{{ end }}

{{/* Get law type vocabulary from law_types.json */}}
{{ $lawTypesData := site.Data.laws.law_types.itemListElement | default (slice) }}
{{ $typeOrder := slice }}
{{ $typeLabels := dict }}
{{ $typeEmojis := dict }}
{{ $typeDescriptions := dict }}
{{ $typeBadgeClasses := dict }}
{{ range $lawTypesData }}
  {{ $typeOrder = $typeOrder | append .identifier }}
  {{ $typeLabels = merge $typeLabels (dict .identifier .name) }}
  {{ $typeEmojis = merge $typeEmojis (dict .identifier .emoji) }}
  {{ $typeDescriptions = merge $typeDescriptions (dict .identifier .description) }}
  {{ $typeBadgeClasses = merge $typeBadgeClasses (dict .identifier .badgeClass) }}
{{ end }}

{{ if gt (len $jurisdictionLaws) 0 }}
<div class="not-prose">
  {{ range $typeOrder }}
    {{ $type := . }}
    {{ $lawsOfType := index $byType $type }}
    {{ if $lawsOfType }}
    <div class="mb-10" id="{{ $type }}-laws">
      {{/* Section header */}}
      <div class="flex items-center gap-3 mb-4">
        <span class="text-2xl">{{ index $typeEmojis $type }}</span>
        <div>
          <h3 class="text-xl font-bold text-base-content m-0">{{ index $typeLabels $type }}</h3>
          <p class="text-sm opacity-70 m-0">{{ index $typeDescriptions $type }}</p>
        </div>
      </div>

      {{/* Law cards */}}
      <div class="space-y-6">
        {{ range $lawsOfType }}
        {{/* Determine source of this law */}}
        {{ $lawSource := index $lawSources .identifier }}
        {{ $isNational := eq $lawSource $jurisdictionId }}
        {{ $sourceLabel := "" }}
        {{ $sourceBadgeClass := "badge-ghost" }}
        {{ if $isNational }}
          {{ $countryFlag := "" }}
          {{ range $regions }}
            {{ if eq .identifier $jurisdictionId }}
              {{ $countryFlag = .flag | default "" }}
            {{ end }}
          {{ end }}
          {{ if $countryFlag }}
            {{ $sourceLabel = printf "%s National" $countryFlag }}
          {{ else }}
            {{ $sourceLabel = "National" }}
          {{ end }}
          {{ $sourceBadgeClass = "badge-primary" }}
        {{ else }}
          {{ $sourceName := $lawSource }}
          {{ $sourceFlag := "" }}
          {{ range $blocs }}
            {{ if eq .identifier $lawSource }}
              {{ $sourceName = .name }}
              {{ $sourceFlag = .flag | default "" }}
            {{ end }}
          {{ end }}
          {{ if $sourceFlag }}
            {{ $sourceLabel = printf "via %s %s" $sourceFlag $sourceName }}
          {{ else }}
            {{ $sourceLabel = printf "via %s" $sourceName }}
          {{ end }}
        {{ end }}

        {{/* Card */}}
        <div class="card bg-base-100 shadow-md hover:shadow-lg transition-shadow border border-base-300">
          <div class="card-body p-6">
            {{/* Header row */}}
            <div class="flex items-start justify-between gap-4">
              <div class="flex-1">
                <div class="flex items-center gap-2 flex-wrap mb-1">
                  <h4 class="card-title text-lg m-0">
                    <a href="/laws/{{ .identifier }}/" class="link link-hover hover:text-primary">
                      {{ .name }} ({{ .legislationDate }})
                    </a>
                  </h4>
                  <div class="badge {{ $sourceBadgeClass }} badge-sm">{{ $sourceLabel }}</div>
                </div>
                <p class="text-sm opacity-60 m-0">{{ .alternateName }}</p>
              </div>
              <a href="/laws/{{ .identifier }}/" class="btn btn-ghost btn-sm">
                Details
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                </svg>
              </a>
            </div>

            {{/* Summary */}}
            <p class="text-sm mt-2 mb-3">{{ .summary }}</p>

            {{/* Attributes */}}
            <div class="flex flex-wrap gap-2">
              {{/* Government Access */}}
              {{ $accessBadge := "badge-ghost" }}
              {{ if eq .governmentAccess "broad" }}{{ $accessBadge = "badge-error" }}{{ end }}
              {{ if eq .governmentAccess "targeted" }}{{ $accessBadge = "badge-warning" }}{{ end }}
              {{ if eq .governmentAccess "limited" }}{{ $accessBadge = "badge-success" }}{{ end }}
              <div class="badge {{ $accessBadge }} gap-1">
                {{ partial "content-icon.html" (dict "name" "eye" "size" "3") }}
                Gov: {{ .governmentAccess }}
              </div>

              {{/* Data Protection */}}
              {{ if and .dataProtection (ne .dataProtection "none") }}
              {{ $protBadge := "badge-ghost" }}
              {{ if eq .dataProtection "strong" }}{{ $protBadge = "badge-success" }}{{ end }}
              {{ if eq .dataProtection "moderate" }}{{ $protBadge = "badge-warning" }}{{ end }}
              {{ if eq .dataProtection "weak" }}{{ $protBadge = "badge-error" }}{{ end }}
              <div class="badge {{ $protBadge }} gap-1">
                {{ partial "content-icon.html" (dict "name" "shield" "size" "3") }}
                Protection: {{ .dataProtection }}
              </div>
              {{ end }}

              {{/* Boolean flags */}}
              {{ if .extraterritorial }}
              <div class="badge badge-secondary gap-1">
                üåç Extraterritorial
              </div>
              {{ end }}

              {{ if .requiresLocalization }}
              <div class="badge badge-info gap-1">
                üìç Localization Required
              </div>
              {{ end }}

              {{ if .requiresBackdoor }}
              <div class="badge badge-error gap-1">
                üîë Backdoor Required
              </div>
              {{ end }}
            </div>
          </div>
        </div>
        {{ end }}
      </div>
    </div>
    {{ end }}
  {{ end }}
</div>
{{ else }}
<div class="alert">
  {{ partial "content-icon.html" (dict "name" "info" "color" "info" "size" "6" "class" "shrink-0") }}
  <span>No laws found for this jurisdiction.</span>
</div>
{{ end }}
