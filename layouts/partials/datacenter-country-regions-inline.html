{{/*
Datacenter Country Regions list (inline partial)
Usage: {{ partial "datacenter-country-regions-inline.html" (dict "countryId" $countryId "regionsById" $regionsById) }}

Renders all datacenter regions in a country, grouped by city.
Similar card layout to provider locations page.
*/}}

{{ $countryId := .countryId }}
{{ $regionsById := .regionsById }}
{{ $allProviders := site.Data.datacenters.datacenters | default (slice) }}

{{/* Build regions grouped by city */}}
{{ $regionsByCity := dict }}
{{ $cityOrder := slice }}
{{ $totalRegions := 0 }}
{{ range $allProviders }}
  {{ $provider := . }}
  {{ range (.regions | default (slice)) }}
    {{ if eq .countryId $countryId }}
      {{ $totalRegions = add $totalRegions 1 }}
      {{ $city := .city | default "Unknown" }}
      {{ $existing := index $regionsByCity $city | default (slice) }}
      {{ $vendor := index $regionsById $provider.vendorCountryId }}
      {{ $flag := "" }}
      {{ $risk := "unknown" }}
      {{ if $vendor }}
        {{ $flag = $vendor.flag | default "" }}
        {{ $risk = $vendor.riskLevel | default "unknown" }}
      {{ end }}
      {{ $regionsByCity = merge $regionsByCity (dict $city ($existing | append (dict
        "name" (.name | default .regionName | default "Unknown")
        "provider" $provider
        "flag" $flag
        "risk" $risk
      ))) }}
      {{ if not (in $cityOrder $city) }}
        {{ $cityOrder = $cityOrder | append $city }}
      {{ end }}
    {{ end }}
  {{ end }}
{{ end }}
{{ $cityOrder = sort $cityOrder }}

{{ if gt $totalRegions 0 }}
{{/* Search input */}}
<div class="mb-4 not-prose">
  <input type="text"
         id="dc-region-search"
         placeholder="Search providers, datacenters, cities..."
         class="w-full max-w-md px-4 py-2 text-sm border border-base-300 rounded-lg bg-base-100 text-base-content focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
</div>

<div id="dc-regions-container" class="not-prose">
{{ range $cityOrder }}
  {{ $city := . }}
  {{ $regions := index $regionsByCity $city }}

  <div class="dc-city-group mb-6" data-city="{{ $city | lower }}">
    <div class="flex items-center gap-2 mb-3 pb-2 border-b border-base-200">
      <h3 class="text-base font-semibold text-base-content m-0">{{ $city }}</h3>
      <span class="text-xs text-neutral-500">({{ len $regions }} {{ if eq (len $regions) 1 }}datacenter{{ else }}datacenters{{ end }})</span>
    </div>
    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2">
      {{ range $regions }}
      {{ $dot := "bg-neutral-400" }}
      {{ if eq .risk "low" }}{{ $dot = "bg-green-500" }}{{ end }}
      {{ if eq .risk "moderate" }}{{ $dot = "bg-yellow-500" }}{{ end }}
      {{ if eq .risk "elevated" }}{{ $dot = "bg-orange-500" }}{{ end }}
      {{ if eq .risk "high" }}{{ $dot = "bg-red-500" }}{{ end }}
      {{ if eq .risk "sanctioned" }}{{ $dot = "bg-red-700" }}{{ end }}
      <a href="/datacenters/{{ .provider.identifier }}/"
         class="dc-region-card p-2.5 rounded-lg border border-base-200 bg-base-100 hover:border-primary/50 no-underline block"
         data-name="{{ .name | lower }}"
         data-provider="{{ .provider.name | lower }}">
        <div class="flex items-center gap-1.5">
          {{ with .flag }}<span class="text-sm">{{ . }}</span>{{ end }}
          <span class="inline-block w-2 h-2 rounded-full {{ $dot }}" title="Vendor risk: {{ .risk }}"></span>
          <span class="text-sm font-medium text-base-content truncate">{{ .provider.name }}</span>
        </div>
        <div class="text-xs text-neutral-500 dark:text-neutral-400 mt-0.5 truncate">{{ .name }}</div>
      </a>
      {{ end }}
    </div>
  </div>
{{ end }}
</div>

<p class="mt-4 text-sm text-neutral-500 dark:text-neutral-400" id="dc-region-count">
  Showing <span id="dc-visible-count">{{ $totalRegions }}</span> of {{ $totalRegions }} datacenters in {{ len $cityOrder }} cities
</p>

<script>
(function() {
  const searchInput = document.getElementById('dc-region-search');
  const container = document.getElementById('dc-regions-container');
  const countSpan = document.getElementById('dc-visible-count');
  const totalCount = {{ $totalRegions }};

  if (!searchInput || !container) return;

  searchInput.addEventListener('input', function() {
    const query = this.value.toLowerCase().trim();
    let visibleCount = 0;

    container.querySelectorAll('.dc-city-group').forEach(function(group) {
      const city = group.dataset.city;
      const cards = group.querySelectorAll('.dc-region-card');
      let groupVisible = false;

      cards.forEach(function(card) {
        const name = card.dataset.name;
        const provider = card.dataset.provider;
        const matches = !query ||
                       city.includes(query) ||
                       name.includes(query) ||
                       provider.includes(query);

        card.style.display = matches ? '' : 'none';
        if (matches) {
          groupVisible = true;
          visibleCount++;
        }
      });

      group.style.display = groupVisible ? '' : 'none';
    });

    if (countSpan) {
      countSpan.textContent = visibleCount;
    }
  });
})();
</script>
{{ end }}
