{{/*
  law-card.html - Shared law card component

  Used by:
    - /laws/ list page
    - Homepage laws-list section

  Parameters:
    law: The law object (from data or page params)
    regions: Region lookup dict (identifier -> region object)
    blocs: Bloc lookup dict (identifier -> bloc object)
    lawTypes: Law types lookup dict (identifier -> type object)
    includeDataAttrs: Include data-* attributes for JS filtering (optional, default false)
*/}}

{{ $law := .law }}
{{ $regions := .regions | default dict }}
{{ $blocs := .blocs | default dict }}
{{ $lawTypes := .lawTypes | default dict }}
{{ $includeDataAttrs := .includeDataAttrs | default false }}

{{/* Detect if this is a Hugo page object or data object */}}
{{ $isPage := $law.RelPermalink }}

{{/* Get law properties - handle both data and page params */}}
{{ $identifier := "" }}
{{ $jurisdictions := slice }}
{{ $category := "privacy" }}
{{ $name := "" }}
{{ $alternateName := "" }}
{{ $abstract := "" }}
{{ $description := "" }}
{{ $legislationDate := "" }}
{{ $extraterritorial := false }}
{{ $requiresLocalization := false }}
{{ $requiresBackdoor := false }}
{{ $governmentAccess := "" }}
{{ $permalink := "" }}

{{ if $isPage }}
  {{/* Hugo page object - access via .Params */}}
  {{ $identifier = $law.Params.identifier }}
  {{ $jurisdictions = $law.Params.legislationJurisdiction | default slice }}
  {{ $category = $law.Params.category | default "privacy" }}
  {{ $name = $law.Title }}
  {{ $alternateName = $law.Params.alternateName }}
  {{ $abstract = $law.Params.abstract }}
  {{ $description = $law.Description }}
  {{ $legislationDate = $law.Params.legislationDate }}
  {{ $extraterritorial = $law.Params.extraterritorial }}
  {{ $requiresLocalization = $law.Params.requiresLocalization }}
  {{ $requiresBackdoor = $law.Params.requiresBackdoor }}
  {{ $governmentAccess = $law.Params.governmentAccess }}
  {{ $permalink = $law.RelPermalink }}
{{ else }}
  {{/* Data object - access directly */}}
  {{ $identifier = $law.identifier }}
  {{ $jurisdictions = $law.legislationJurisdiction | default slice }}
  {{ $category = $law.category | default "privacy" }}
  {{ $name = $law.name }}
  {{ $alternateName = $law.alternateName }}
  {{ $abstract = $law.abstract }}
  {{ $description = $law.description }}
  {{ $legislationDate = $law.legislationDate }}
  {{ $extraterritorial = $law.extraterritorial }}
  {{ $requiresLocalization = $law.requiresLocalization }}
  {{ $requiresBackdoor = $law.requiresBackdoor }}
  {{ $governmentAccess = $law.governmentAccess }}
  {{ $permalink = printf "/laws/%s/" $law.identifier }}
{{ end }}

{{/* Get category info */}}
{{ $categoryInfo := index $lawTypes $category }}

<article class="law-card card bg-base-100 shadow-md hover:shadow-lg transition-all group border border-base-200 h-full"
  {{- if $includeDataAttrs }}
  data-identifier="{{ $identifier }}"
  data-category="{{ $category }}"
  data-jurisdictions="{{ delimit $jurisdictions "," }}"
  data-extraterritorial="{{ $extraterritorial | default false }}"
  data-localization="{{ $requiresLocalization | default false }}"
  data-backdoor="{{ $requiresBackdoor | default false }}"
  data-name="{{ $name }}"
  data-alternatename="{{ $alternateName | default "" }}"
  data-description="{{ $description | default "" }}"
  data-year="{{ $legislationDate | default "" }}"
  {{- end -}}
>
  <a href="{{ $permalink }}" class="block no-underline">
    <div class="card-body p-4">
      {{/* Title row with flag, name, icons, and year */}}
      <div class="flex items-start gap-2">
        {{/* Flag(s) */}}
        <div class="flex items-center gap-1 shrink-0 pt-0.5">
          {{- range $jurisdictions -}}
            {{- $jur := . -}}
            {{- $region := index $regions $jur -}}
            {{- $bloc := index $blocs $jur -}}
            {{- if $region -}}
              <span class="tooltip" data-tip="{{ $region.name }}"><span class="text-lg">{{ $region.flag }}</span></span>
            {{- else if $bloc -}}
              <span class="tooltip" data-tip="{{ $bloc.name }}"><span class="text-lg">{{ $bloc.flag }}</span></span>
            {{- end -}}
          {{- end -}}
        </div>
        {{/* Title */}}
        <div class="min-w-0 flex-1">
          <h3 class="card-title text-base leading-tight group-hover:text-primary transition-colors line-clamp-2 m-0">{{ $name }}</h3>
        </div>
        {{/* Icons and year */}}
        <div class="flex items-center gap-1 shrink-0 text-sm">
          {{ with $categoryInfo }}<span class="tooltip" data-tip="{{ .name }}">{{ .emoji }}</span>{{ end }}
          {{- if $extraterritorial }}<span class="tooltip" data-tip="Extraterritorial reach">üåç</span>{{ end -}}
          {{- if $requiresLocalization }}<span class="tooltip" data-tip="Requires data localization">üìç</span>{{ end -}}
          {{- if $requiresBackdoor }}<span class="tooltip" data-tip="Requires backdoor access">üîë</span>{{ end -}}
          {{- if and $governmentAccess (ne $governmentAccess "none") }}<span class="tooltip" data-tip="Government data access">üëÅÔ∏è</span>{{ end -}}
          {{ with $legislationDate }}<span class="opacity-60 ml-1">{{ . }}</span>{{ end }}
        </div>
      </div>

      {{/* Alternate name */}}
      {{ with $alternateName }}
      <p class="text-xs opacity-60 line-clamp-1 mt-1 mb-0">{{ . }}</p>
      {{ end }}

      {{/* Abstract/Description */}}
      {{ with $abstract }}
      <p class="text-sm text-neutral-600 dark:text-neutral-400 line-clamp-3 mt-2 mb-0">{{ . }}</p>
      {{ else }}
      {{ with $description }}
      <p class="text-sm text-neutral-600 dark:text-neutral-400 line-clamp-3 mt-2 mb-0">{{ . }}</p>
      {{ end }}
      {{ end }}
    </div>
  </a>
</article>
