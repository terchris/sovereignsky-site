{{- /*
  event-list.html
  Renders a list of events from /data/events/events.json
  
  Usage: 
    {{ partial "event-list.html" . }}
    {{ partial "event-list.html" (dict "filter" "cybersecurity" "limit" 3) }}
    {{ partial "event-list.html" (dict "audience" "developer") }}
    {{ partial "event-list.html" (dict "audience" "government") }}
    {{ partial "event-list.html" (dict "itRelevance" "high") }}
  
  Audience values (from personas.json): developer, technical, enterprise, government, humanitarian, defence
*/ -}}

{{- $events := site.Data.events.events.itemListElement -}}
{{- /* Build topic labels from topics.json */ -}}
{{- $topicLabels := dict -}}
{{- range site.Data.topics.topics.itemListElement -}}
  {{- $topicLabels = merge $topicLabels (dict .identifier .name) -}}
{{- end -}}
{{- /* Build audience labels from audience.json */ -}}
{{- $audienceLabels := dict -}}
{{- range site.Data.audience.audience.itemListElement -}}
  {{- $audienceLabels = merge $audienceLabels (dict .identifier .name) -}}
{{- end -}}
{{- $filter := .filter | default "" -}}
{{- $audience := .audience | default "" -}}
{{- $itRelevance := .itRelevance | default "" -}}
{{- $limit := .limit | default 0 -}}
{{- $showPast := .showPast | default false -}}
{{- $compact := .compact | default false -}}
{{- $now := now.Format "2006-01-02" -}}

{{- /* Filter events */ -}}
{{- $filtered := slice -}}
{{- range $events -}}
  {{- $include := true -}}
  
  {{- /* Filter by topic */ -}}
  {{- if $filter -}}
    {{- $include = false -}}
    {{- range .topics -}}
      {{- if eq . $filter -}}
        {{- $include = true -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}
  
  {{- /* Filter by audience */ -}}
  {{- if and $include $audience -}}
    {{- $include = false -}}
    {{- range .audience -}}
      {{- if eq . $audience -}}
        {{- $include = true -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}
  
  {{- /* Filter by IT relevance */ -}}
  {{- if and $include $itRelevance -}}
    {{- if ne .itRelevance $itRelevance -}}
      {{- $include = false -}}
    {{- end -}}
  {{- end -}}
  
  {{- /* Filter past events */ -}}
  {{- if and (not $showPast) (lt .startDate $now) -}}
    {{- $include = false -}}
  {{- end -}}
  
  {{- if $include -}}
    {{- $filtered = $filtered | append . -}}
  {{- end -}}
{{- end -}}

{{- /* Apply limit */ -}}
{{- if and $limit (gt (len $filtered) $limit) -}}
  {{- $filtered = first $limit $filtered -}}
{{- end -}}

{{- if $filtered -}}
<div class="event-list grid gap-4{{ if $compact }} event-list--compact{{ end }}">
  {{- range $filtered }}
  {{- $start := time .startDate -}}
  {{- $endDate := .endDate -}}
  <article class="event-card card card-side bg-base-100 shadow-md hover:shadow-lg transition-shadow border border-base-300{{ if .featured }} border-primary border-2{{ end }}" id="{{ .identifier }}" data-topics="{{ delimit .topics " " }}" data-audience="{{ delimit .audience " " }}" data-relevance="{{ .itRelevance }}">
    {{/* Date badge */}}
    <div class="flex items-center justify-center bg-primary text-primary-content p-4 min-w-[80px] rounded-l-box mr-2">
      <time datetime="{{ .startDate }}" class="text-center">
        {{- if $endDate -}}
          {{- $end := time $endDate -}}
          <div class="text-2xl font-bold leading-tight">{{ $start.Day }}-{{ $end.Day }}</div>
        {{- else -}}
          <div class="text-3xl font-bold leading-tight">{{ $start.Day }}</div>
        {{- end -}}
        <div class="text-sm uppercase tracking-wide opacity-90">{{ $start.Format "Jan" }}</div>
        <div class="text-xs opacity-75">{{ $start.Year }}</div>
      </time>
    </div>

    <div class="card-body py-4 pl-8 pr-4 gap-2">
      {{/* Title */}}
      <h3 class="card-title text-lg">
        <a href="/events/{{ .identifier }}/" class="link link-hover hover:text-primary">{{ .name }}</a>
      </h3>

      {{/* Description */}}
      {{- if not $compact }}
      <p class="text-sm opacity-70 line-clamp-2">{{ .description }}</p>
      {{- end }}

      {{/* Meta info */}}
      <div class="flex flex-wrap items-center gap-3 text-sm opacity-70">
        {{- with .location }}
        {{- if (reflect.IsMap .) -}}
          {{- $city := .city | default "" -}}
          {{- $name := .name | default "" -}}
          {{- if or $city $name -}}
          <span class="flex items-center gap-1">
            {{ partial "data-icon.html" (dict "name" "location" "size" "4") }}
            {{- if $city -}}{{ $city }}{{- if and $name (ne $name $city) -}}, {{ $name }}{{- end -}}{{- else -}}{{ $name }}{{- end -}}
          </span>
          {{- end -}}
        {{- else -}}
          {{- if . -}}
          <span class="flex items-center gap-1">
            {{ partial "data-icon.html" (dict "name" "location" "size" "4") }}
            {{ . }}
          </span>
          {{- end -}}
        {{- end }}
        {{- end }}

        {{- with .organizer }}
        {{- $orgName := "" -}}
        {{- $orgURL := "" -}}
        {{- if (reflect.IsMap .) -}}
          {{- $orgName = .name | default "" -}}
          {{- $orgURL = .url | default "" -}}
        {{- else -}}
          {{- $orgName = . | default "" -}}
        {{- end -}}
        {{- if and $orgName (ne $orgName "TBA") }}
        <span class="flex items-center gap-1">
          {{ partial "data-icon.html" (dict "name" "users" "size" "4") }}
          {{- if $orgURL -}}
          <a href="{{ $orgURL }}" rel="noopener" target="_blank" class="link link-hover">{{ $orgName }}</a>
          {{- else -}}
          {{ $orgName }}
          {{- end -}}
        </span>
        {{- end }}
        {{- end }}
      </div>

      {{/* Topics */}}
      {{- if not $compact }}
      {{- with .topics }}
      <div class="flex flex-wrap gap-1 mt-1">
        {{- $topicColors := dict "cybersecurity" "border-error text-error" "national-preparedness" "border-warning text-warning" "critical-infrastructure" "border-info text-info" "digital-sovereignty" "border-success text-success" -}}
        {{- range . }}
        {{- $label := index $topicLabels . | default (. | humanize | title) }}
        {{- $color := index $topicColors . | default "border-base-300" }}
        <span class="inline-flex items-center px-2 py-0.5 text-xs font-medium rounded-full border {{ $color }}">{{ $label }}</span>
        {{- end }}
      </div>
      {{- end }}

      {{- with .audience }}
      <div class="text-xs opacity-50 mt-1">
        {{- range $i, $a := . }}{{- if $i }} Â· {{ end }}{{- $label := index $audienceLabels $a | default ($a | humanize | title) }}{{ $label }}{{- end }}
      </div>
      {{- end }}
      {{- end }}
    </div>
  </article>
  {{- end }}
</div>
{{- else -}}
<div class="alert alert-info">
  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
  <span>No upcoming events{{ with $filter }} tagged "{{ . }}"{{ end }}.</span>
</div>
{{- end -}}
