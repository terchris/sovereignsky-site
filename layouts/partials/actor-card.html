{{/*
  Actor Card Partial

  Usage: {{ partial "actor-card.html" (dict "actor" $actor "connections" $connections "role" "owner") }}

  Parameters:
    - actor: Actor object from networks-actors.json
    - connections: slice of connection objects this actor is related to
    - role: "owner" or "operator" (optional, for display)
    - currentConnectionId: current page connection_id to highlight (optional)
*/}}

{{ $actor := .actor }}
{{ $connections := .connections | default (slice) }}
{{ $role := .role | default "" }}
{{ $currentConnectionId := .currentConnectionId | default "" }}

{{ $countryId := $actor.country_id | default "" }}

{{/* Flag emoji lookup - common countries */}}
{{ $flags := dict
  "NO" "ðŸ‡³ðŸ‡´"
  "US" "ðŸ‡ºðŸ‡¸"
  "GB" "ðŸ‡¬ðŸ‡§"
  "IE" "ðŸ‡®ðŸ‡ª"
  "DK" "ðŸ‡©ðŸ‡°"
  "SE" "ðŸ‡¸ðŸ‡ª"
  "FI" "ðŸ‡«ðŸ‡®"
  "DE" "ðŸ‡©ðŸ‡ª"
  "NL" "ðŸ‡³ðŸ‡±"
  "FR" "ðŸ‡«ðŸ‡·"
  "IS" "ðŸ‡®ðŸ‡¸"
}}
{{ $flag := index $flags $countryId | default "" }}

{{/* Actor type labels */}}
{{ $typeLabels := dict
  "infrastructure_operator" "Infrastructure"
  "network_operator" "Network Operator"
  "telecom_operator" "Telecom"
  "datacenter_operator" "Datacenter"
  "state_owned_enterprise" "State-owned"
  "project_company" "Project Company"
  "subsea_operator" "Subsea Operator"
  "consortium" "Consortium"
  "tech_company" "Tech Company"
  "system_supplier" "System Supplier"
  "cable_manufacturer" "Cable Manufacturer"
  "installation_contractor" "Contractor"
}}
{{ $typeLabel := index $typeLabels ($actor.actor_type | default "") | default $actor.actor_type }}

{{/* Get jurisdiction page if exists */}}
{{ $jurisdictionPage := site.GetPage (printf "/jurisdictions/%s" (lower $countryId)) }}

{{/* Get region name */}}
{{ $regions := site.Data.regions | default (slice) }}
{{ $countryName := $countryId }}
{{ range $regions }}
  {{ if eq .id $countryId }}
    {{ $countryName = .name }}
  {{ end }}
{{ end }}

{{ $currentRole := "" }}
{{ range $connections }}
  {{ if eq .connection_id $currentConnectionId }}
    {{ $currentRole = delimit .roles " & " }}
  {{ end }}
{{ end }}

<div class="card bg-base-100 shadow-md hover:shadow-lg transition-shadow border border-base-300">
  <div class="card-body p-4">
    {{/* Header with flag and name */}}
    <div class="flex items-center gap-3">
      {{ if $flag }}
      <div class="text-3xl">{{ $flag }}</div>
      {{ end }}
      <div class="flex-1 min-w-0">
        <h4 class="card-title text-base leading-tight">
          {{ $actor.actor_name }}
        </h4>
        <div class="flex flex-wrap gap-1 mt-1">
          {{ if $currentRole }}
          <span class="badge badge-primary badge-sm">{{ $currentRole }}</span>
          {{ end }}
          {{ if $typeLabel }}
          <span class="badge badge-ghost badge-sm">{{ $typeLabel }}</span>
          {{ end }}
        </div>
      </div>
    </div>

    {{/* Details */}}
    <div class="text-sm space-y-2 mt-3">
      {{/* Jurisdiction */}}
      {{ if $countryId }}
      <div class="flex items-center gap-2">
        <svg class="w-4 h-4 opacity-50 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 21v-4m0 0V5a2 2 0 012-2h6.5l1 1H21l-3 6 3 6h-8.5l-1-1H5a2 2 0 00-2 2zm9-13.5V9"/>
        </svg>
        <span class="opacity-70">Jurisdiction:</span>
        {{ if $jurisdictionPage }}
          <a href="{{ $jurisdictionPage.RelPermalink }}" class="link link-primary">{{ $countryName }}</a>
        {{ else }}
          <span>{{ $countryName }}</span>
        {{ end }}
      </div>
      {{ end }}

      {{/* Website */}}
      {{ with $actor.website }}
      <div class="flex items-center gap-2">
        <svg class="w-4 h-4 opacity-50 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/>
        </svg>
        <a href="{{ . }}" target="_blank" rel="noopener noreferrer" class="link link-primary truncate">
          {{ replaceRE "^https?://(www\\.)?" "" . | replaceRE "/.*$" "" }}
        </a>
      </div>
      {{ end }}
    </div>

    {{/* Networks */}}
    {{ if gt (len $connections) 0 }}
    <div class="divider my-2"></div>
    <div>
      <p class="text-xs font-semibold uppercase tracking-wide opacity-60 mb-2">Networks</p>
      <ul class="space-y-1">
        {{ range $connections }}
          {{ $isCurrent := eq .connection_id $currentConnectionId }}
          {{ $page := site.GetPage (printf "/networks/%s" .connection_id) }}
          <li class="text-sm flex items-center gap-2">
            {{ if $isCurrent }}
            <span class="badge badge-xs badge-primary"></span>
            {{ else }}
            <span class="badge badge-xs badge-ghost"></span>
            {{ end }}
            {{ if and $page (not $isCurrent) }}
              <a href="{{ $page.RelPermalink }}" class="link link-hover">{{ .connection_name }}</a>
            {{ else }}
              <span class="{{ if $isCurrent }}font-semibold text-primary{{ end }}">{{ .connection_name }}</span>
            {{ end }}
            {{ if .roles }}
              <span class="opacity-50 text-xs">({{ delimit .roles ", " }})</span>
            {{ end }}
          </li>
        {{ end }}
      </ul>
    </div>
    {{ end }}

    {{/* Notes */}}
    {{ with $actor.notes }}
    <p class="mt-2 text-xs italic opacity-60">{{ . }}</p>
    {{ end }}
  </div>
</div>
