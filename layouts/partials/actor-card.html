{{/*
  Actor Card Partial

  Usage: {{ partial "actor-card.html" (dict "actor" $actor "connections" $connections "role" "owner") }}

  Parameters:
    - actor: Actor object from networks-actors.json
    - connections: slice of connection objects this actor is related to
    - role: "owner" or "operator" (optional, for display)
    - currentConnectionId: current page identifier to highlight (optional)
*/}}

{{ $actor := .actor }}
{{ $connections := .connections | default (slice) }}
{{ $role := .role | default "" }}
{{ $currentConnectionId := .currentConnectionId | default "" }}

{{ $countryId := $actor.countryId | default "" }}

{{/* Flag emoji from regions.json */}}
{{ $flag := "" }}
{{ if $countryId }}
  {{ $flag = partial "get-country-flag.html" $countryId }}
{{ end }}

{{/* Actor type labels */}}
{{ $typeLabels := dict
  "infrastructure_operator" "Infrastructure"
  "network_operator" "Network Operator"
  "telecom_operator" "Telecom"
  "datacenter_operator" "Datacenter"
  "state_owned_enterprise" "State-owned"
  "project_company" "Project Company"
  "subsea_operator" "Subsea Operator"
  "consortium" "Consortium"
  "tech_company" "Tech Company"
  "system_supplier" "System Supplier"
  "cable_manufacturer" "Cable Manufacturer"
  "installation_contractor" "Contractor"
}}
{{ $typeLabel := index $typeLabels ($actor.type | default "") | default $actor.type }}

{{/* Get jurisdiction page if exists */}}
{{ $jurisdictionPage := site.GetPage (printf "/countries/%s" (lower $countryId)) }}

{{/* Get region name */}}
{{ $countries := site.Data.countries.countries.itemListElement | default (slice) }}
{{ $countryName := $countryId }}
{{ range $countries }}
  {{ if eq .identifier $countryId }}
    {{ $countryName = .name }}
  {{ end }}
{{ end }}

{{ $currentRole := "" }}
{{ range $connections }}
  {{ if eq .identifier $currentConnectionId }}
    {{ $currentRole = delimit .roles " & " }}
  {{ end }}
{{ end }}

<div class="card bg-base-100 shadow-md hover:shadow-lg transition-shadow border border-base-300">
  <div class="card-body p-4">
    {{/* Header with flag and name */}}
    <div class="flex items-center gap-3">
      {{ if $flag }}
      <div class="text-3xl">{{ $flag }}</div>
      {{ end }}
      <div class="flex-1 min-w-0">
        <h4 class="card-title text-base leading-tight">
          {{ $actor.name }}
        </h4>
        <div class="flex flex-wrap gap-1 mt-1">
          {{ if $currentRole }}
          <span class="badge badge-primary badge-sm">{{ $currentRole }}</span>
          {{ end }}
          {{ if $typeLabel }}
          <span class="badge badge-ghost badge-sm">{{ $typeLabel }}</span>
          {{ end }}
        </div>
      </div>
    </div>

    {{/* Details */}}
    <div class="text-sm space-y-2 mt-3">
      {{/* Jurisdiction */}}
      {{ if $countryId }}
      <div class="flex items-center gap-2">
        {{ partial "content-icon.html" (dict "name" "flag" "size" "4" "class" "opacity-50 shrink-0") }}
        <span class="opacity-70">Jurisdiction:</span>
        {{ if $jurisdictionPage }}
          <a href="{{ $jurisdictionPage.RelPermalink }}" class="link link-primary">{{ $countryName }}</a>
        {{ else }}
          <span>{{ $countryName }}</span>
        {{ end }}
      </div>
      {{ end }}

      {{/* Website */}}
      {{ with $actor.url }}
      <div class="flex items-center gap-2">
        {{ partial "content-icon.html" (dict "name" "link" "size" "4" "class" "opacity-50 shrink-0") }}
        <a href="{{ . }}" target="_blank" rel="noopener noreferrer" class="link link-primary truncate">
          {{ replaceRE "^https?://(www\\.)?" "" . | replaceRE "/.*$" "" }}
        </a>
      </div>
      {{ end }}
    </div>

    {{/* Networks */}}
    {{ if gt (len $connections) 0 }}
    <div class="divider my-2"></div>
    <div>
      <p class="text-xs font-semibold uppercase tracking-wide opacity-60 mb-2">Networks</p>
      <ul class="space-y-1">
        {{ range $connections }}
          {{ $isCurrent := eq .identifier $currentConnectionId }}
          {{ $page := site.GetPage (printf "/networks/%s" .identifier) }}
          <li class="text-sm flex items-center gap-2">
            {{ if $isCurrent }}
            <span class="badge badge-xs badge-primary"></span>
            {{ else }}
            <span class="badge badge-xs badge-ghost"></span>
            {{ end }}
            {{ if and $page (not $isCurrent) }}
              <a href="{{ $page.RelPermalink }}" class="link link-hover">{{ .name }}</a>
            {{ else }}
              <span class="{{ if $isCurrent }}font-semibold text-primary{{ end }}">{{ .name }}</span>
            {{ end }}
            {{ if .roles }}
              <span class="opacity-50 text-xs">({{ delimit .roles ", " }})</span>
            {{ end }}
          </li>
        {{ end }}
      </ul>
    </div>
    {{ end }}

    {{/* Notes */}}
    {{ with $actor.notes }}
    <p class="mt-2 text-xs italic opacity-60">{{ . }}</p>
    {{ end }}
  </div>
</div>
