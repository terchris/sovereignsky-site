{{/*
  common-single-page.html - Unified base template for detail pages

  Usage:
    {{ partial "common-single-page.html" (dict
        "page" .
        "icon" "scale"
        "section" "Laws"
        "sectionUrl" "/laws/"
        "headerDescription" .Params.alternateName
        "externalUrl" .Params.sourceUrl
        "externalLabel" "Official text"
        "sidebarCards" (slice
            "sidebar/laws-details-card.html"
            "sidebar/laws-appliesto.html"
            "sidebar/common-audience-card.html"
        )
        "showToc" true
    ) }}

  Parameters:
    page: The page context (required)
    icon: Icon name for header (optional)
    flag: Emoji flag for header (optional, takes precedence over icon)
    section: Section name for breadcrumb (required)
    sectionUrl: URL for section breadcrumb (required)
    headerDescription: Description shown in header (optional)
    externalUrl: External link URL (optional)
    externalLabel: External link button text (default: "Read original")
    sidebarCards: Slice of sidebar cards. Each item can be:
                  - A string (partial path): rendered with page context
                  - A dict with "partial" key and optional "params": rendered with custom params
    showToc: Whether to show table of contents (default: true)
    showAbstract: Whether to show abstract section (default: true)
    showSummary: Whether to show summary section (default: true)
    showFeaturedImage: Whether to show featured image (default: true)
    showQuote: Whether to show quote block (default: true)
    showBackLink: Whether to show back link (default: true)
    backLinkUrl: Custom back link URL (default: sectionUrl)
    backLinkText: Custom back link text (default: "Back to all {section}")
    beforeContent: Partial path to render before abstract (e.g., for maps)
    afterContent: Partial path to render after main content
    contentPartial: Partial path to replace entire content area (overrides default)
    pageData: Dict of custom data to pass to content partials
*/}}

{{ $page := .page }}
{{ $icon := .icon | default "" }}
{{ $flag := .flag | default "" }}
{{ $section := .section | default "Content" }}
{{ $sectionUrl := .sectionUrl | default "/" }}
{{ $headerDescription := .headerDescription | default "" }}
{{ $externalUrl := .externalUrl | default "" }}
{{ $externalLabel := .externalLabel | default "Read original" }}
{{ $sidebarCards := .sidebarCards | default (slice) }}
{{ $showToc := .showToc | default true }}
{{ $showAbstract := .showAbstract | default true }}
{{ $showSummary := .showSummary | default true }}
{{ $showFeaturedImage := .showFeaturedImage | default true }}
{{ $showQuote := .showQuote | default true }}
{{ $showBackLink := .showBackLink | default true }}
{{ $backLinkUrl := .backLinkUrl | default $sectionUrl }}
{{ $backLinkText := .backLinkText | default (printf "‚Üê Back to all %s" ($section | lower)) }}
{{ $beforeContent := .beforeContent | default "" }}
{{ $afterContent := .afterContent | default "" }}
{{ $contentPartial := .contentPartial | default "" }}
{{ $pageData := .pageData | default (dict) }}
{{ $showFloatingToc := .showFloatingToc | default true }}

{{/* Build context for content partials */}}
{{ $contentContext := dict "page" $page "data" $pageData }}

{{/* Hero settings from frontmatter */}}
{{ $showHero := $page.Params.showHero | default false }}
{{ $heroStyle := $page.Params.heroStyle | default "basic" }}

<article class="max-w-full">
  {{/* Big Hero Image (Blowfish-style, full width above header) */}}
  {{ if and $showHero (eq $heroStyle "big") }}
    {{ partial "hero/big.html" $page }}
  {{ end }}

  {{/* Detail Header with breadcrumbs */}}
  {{ partial "common-detail-header.html" (dict
      "title" $page.Title
      "description" $headerDescription
      "icon" $icon
      "flag" $flag
      "breadcrumbs" (slice
          (dict "title" $section "url" $sectionUrl)
      )
  ) }}

  {{/* Featured Image - only show if NOT using big hero */}}
  {{ if and $showFeaturedImage (not (and $showHero (eq $heroStyle "big"))) }}
  {{ $featured := $page.Resources.GetMatch "featured*" }}
  {{ with $featured }}
  {{ $img := .Fit "800x400 webp" }}
  <figure class="mb-8">
    <img src="{{ $img.RelPermalink }}" alt="{{ $page.Title }}" width="{{ $img.Width }}" height="{{ $img.Height }}" class="w-full max-w-3xl rounded-lg shadow-md" loading="lazy">
  </figure>
  {{ end }}
  {{ end }}

  {{/* Two-column layout */}}
  <section class="flex flex-col max-w-full mt-0 lg:flex-row">

    {{/* Right Sidebar */}}
    {{ partial "sidebar/common-sidebar.html" $page }}

        {{/* External link button */}}
        {{ if $externalUrl }}
        <a class="btn btn-primary btn-outline w-full gap-2"
           href="{{ $externalUrl }}"
           target="_blank"
           rel="noopener noreferrer">
          {{ partial "content-icon.html" (dict "name" "external" "size" "4") }}
          {{ $externalLabel }}
        </a>
        {{ end }}

        {{/* Section-specific sidebar cards */}}
        {{/* Each card can be either:
             - A string (partial path): rendered with $page
             - A dict with "partial" and optional "params": rendered with params or $page
        */}}
        {{ range $sidebarCards }}
          {{ if reflect.IsMap . }}
            {{ $params := .params | default $page }}
            {{ partial .partial $params }}
          {{ else }}
            {{ partial . $page }}
          {{ end }}
        {{ end }}

    {{ partial "sidebar/common-sidebar-end.html" $page }}

    {{/* Main Content */}}
    <div class="min-w-0 flex-1">
      <div class="article-content prose dark:prose-invert max-w-none mb-20">

        {{/* Use custom content partial if provided, otherwise default layout */}}
        {{ if $contentPartial }}
          {{ partial $contentPartial $contentContext }}
        {{ else }}

          {{/* Before content partial (e.g., maps) */}}
          {{ if $beforeContent }}
            {{ partial $beforeContent $contentContext }}
          {{ end }}

          {{/* Abstract */}}
          {{ if $showAbstract }}
            {{ partial "common-content-section.html" (dict "title" "Abstract" "content" $page.Params.abstract) }}
          {{ end }}

          {{/* Summary */}}
          {{ if $showSummary }}
            {{ partial "common-content-section.html" (dict "title" "Summary" "content" $page.Params.summary "border" true) }}
          {{ end }}

          {{/* Inline Table of Contents (collapsed by default) */}}
          {{ if $showToc }}
            {{ partial "inline-toc.html" $page }}
          {{ end }}

          {{/* Main article content */}}
          {{ $page.Content }}

          {{/* After content partial (e.g., related sections, inline lists) */}}
          {{ if $afterContent }}
            {{ partial $afterContent $contentContext }}
          {{ end }}

          {{/* Quote from original if provided */}}
          {{ if $showQuote }}
          {{ with $page.Params.quote }}
          <blockquote class="border-l-4 border-primary-500 pl-4 my-8 italic text-neutral-600 dark:text-neutral-400">
            {{ . | markdownify }}
            {{ with $page.Params.quote_attribution }}
            <footer class="mt-2 text-sm not-italic">‚Äî {{ . }}</footer>
            {{ end }}
          </blockquote>
          {{ end }}
          {{ end }}

        {{ end }}

        {{/* Back link */}}
        {{ if $showBackLink }}
        <hr class="mt-8">
        <p>
          <a href="{{ $backLinkUrl }}">{{ $backLinkText }}</a>
        </p>
        {{ end }}
      </div>
    </div>

  </section>

  {{/* Floating TOC for mobile (skip if content partial handles its own) */}}
  {{ if $showFloatingToc }}
  {{ $tocSections := slice }}
  {{ if and $showToc (in $page.TableOfContents "<ul") }}
    {{ $tocSections = $tocSections | append (dict "id" "toc" "title" "Contents" "icon" "üìë") }}
  {{ end }}
  {{ $tocSections = $tocSections | append (dict "id" "sidebar" "title" "Details" "icon" "üìã") }}
  {{ partial "floating-toc.html" (dict "sections" $tocSections) }}
  {{ end }}
</article>
