{{/*
  Inline partial for risk assessment - used by provider.html layout
  Reads vendor data from page params (frontmatter).
  Still needs regions.json for bloc memberships.

  Parameters:
    Page: The page object to read params from
*/}}

{{ $page := .Page }}

{{ $providerId := $page.Params.provider_id | default "" }}
{{ $hqId := $page.Params.vendor_country_id | default "" }}
{{ $hqName := $page.Params.vendor_country_name | default $hqId }}
{{ $hqFlag := $page.Params.vendor_country_flag | default "" }}
{{ $hqRisk := $page.Params.vendor_risk | default "unknown" }}
{{ $hqSlug := $page.Params.vendor_country_slug | default "" }}

{{/* Get risk label from riskLevels */}}
{{ $riskLevels := (site.Data.blocs.riskLevels | default dict) }}
{{ $riskLabel := $hqRisk }}
{{ with index $riskLevels $hqRisk }}
  {{ if .label }}{{ $riskLabel = .label }}{{ end }}
{{ end }}

{{ $riskEmoji := "" }}
{{ if eq $hqRisk "low" }}{{ $riskEmoji = "‚úÖ" }}{{ end }}
{{ if eq $hqRisk "moderate" }}{{ $riskEmoji = "‚ö†Ô∏è" }}{{ end }}
{{ if eq $hqRisk "elevated" }}{{ $riskEmoji = "üî∂" }}{{ end }}
{{ if eq $hqRisk "high" }}{{ $riskEmoji = "üö®" }}{{ end }}
{{ if eq $hqRisk "sanctioned" }}{{ $riskEmoji = "‚õî" }}{{ end }}

{{/* Get bloc memberships from countries.json */}}
{{ $countriesById := dict }}
{{ range (site.Data.countries.countries.itemListElement | default (slice)) }}
  {{ $countriesById = merge $countriesById (dict .identifier .) }}
{{ end }}
{{ $hq := index $countriesById $hqId }}

{{ $blocsById := dict }}
{{ range (site.Data.blocs.blocs.itemListElement | default (slice)) }}
  {{ $blocsById = merge $blocsById (dict .identifier .) }}
{{ end }}
{{ $blocNames := slice }}
{{ if $hq }}
  {{ range ($hq.blocs | default (slice)) }}
    {{ $b := index $blocsById . }}
    {{ if $b }}
      {{ $blocNames = $blocNames | append $b.name }}
    {{ end }}
  {{ end }}
{{ end }}

{{ if $providerId }}
<div class="not-prose mt-3 max-w-prose rounded-xl border border-neutral-200 dark:border-neutral-700 bg-white dark:bg-neutral-900 p-4">
  <div class="flex flex-wrap items-center gap-3">
    <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full border border-neutral-200 dark:border-neutral-700 bg-white dark:bg-neutral-900 text-sm">
      <span class="font-medium">Risk</span>
      <span class="text-neutral-500 dark:text-neutral-400">{{ if $riskEmoji }}{{ $riskEmoji }}{{ end }} {{ $riskLabel }}</span>
    </span>
    <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full border border-neutral-200 dark:border-neutral-700 bg-white dark:bg-neutral-900 text-sm">
      <span class="font-medium">Blocs</span>
      <span class="text-neutral-500 dark:text-neutral-400">
        {{ if gt (len $blocNames) 0 }}{{ delimit $blocNames ", " }}{{ else }}‚Äî{{ end }}
      </span>
    </span>
    {{ if and $hqSlug (ne $hqSlug "") }}
      <a class="inline-flex items-center gap-2 px-3 py-1 rounded-full border border-neutral-200 dark:border-neutral-700 bg-white dark:bg-neutral-900 hover:border-primary-400 dark:hover:border-primary-500 transition-colors text-sm no-underline"
         href="/countries/{{ $hqSlug }}/">
        <span class="font-medium">Jurisdiction</span>
        <span class="text-neutral-500 dark:text-neutral-400">{{ if $hqFlag }}{{ $hqFlag }}{{ end }} {{ $hqName | default $hqId }}</span>
        <span class="text-neutral-500 dark:text-neutral-400">‚Üó</span>
      </a>
    {{ end }}
  </div>
</div>
{{ end }}
