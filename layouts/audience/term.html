{{ define "main" }}
{{/* Get audience info from audience.json */}}
{{ $term := .Data.Term }}
{{ $audienceData := site.Data.audience.audience }}
{{ $audiences := $audienceData.itemListElement | default (slice) }}
{{ $audience := dict }}
{{ range $audiences }}
  {{ if eq .identifier $term }}
    {{ $audience = . }}
  {{ end }}
{{ end }}

{{ $name := $audience.name | default ($term | humanize | title) }}
{{ $desc := $audience.description | default "" }}
{{ $abstract := $audience.abstract | default "" }}
{{ $icon := $audience.icon | default "user" }}

{{/* Get persona page for featured image */}}
{{ $personaPage := site.GetPage (printf "/personas/%s" $term) }}
{{ $featured := false }}
{{ with $personaPage }}
  {{ $featured = .Resources.GetMatch "featured*" }}
{{ end }}

{{/* Get all pages for this audience term */}}
{{ $allPages := .Pages }}

{{/* Content type config: icon, color, label */}}
{{ $typeConfig := dict
  "blog" (dict "icon" "pencil" "color" "info" "label" "Article")
  "events" (dict "icon" "calendar" "color" "error" "label" "Event")
  "publications" (dict "icon" "book" "color" "secondary" "label" "Publication")
  "laws" (dict "icon" "scale" "color" "warning" "label" "Law")
  "software" (dict "icon" "computer" "color" "primary" "label" "Software")
  "networks" (dict "icon" "globe" "color" "accent" "label" "Network")
  "datacenters" (dict "icon" "server" "color" "neutral" "label" "Datacenter")
}}

{{/* Law types lookup */}}
{{ $lawTypes := dict }}
{{ range site.Data.laws.law_types.itemListElement }}
  {{ $lawTypes = merge $lawTypes (dict .identifier .) }}
{{ end }}

{{/* Count by type for stats */}}
{{ $typeCounts := dict }}
{{ range $allPages }}
  {{ $section := .Section }}
  {{ $count := index $typeCounts $section | default 0 }}
  {{ $typeCounts = merge $typeCounts (dict $section (add $count 1)) }}
{{ end }}

<article class="max-w-full">
  {{/* Hero Header */}}
  <header class="mb-8">
    {{/* Breadcrumb */}}
    <nav class="text-sm breadcrumbs mb-4">
      <ul>
        <li><a href="/">Home</a></li>
        <li><a href="/audience/">Audiences</a></li>
        <li>{{ $name }}</li>
      </ul>
    </nav>

    <div class="flex flex-col lg:flex-row gap-6 items-start">
      {{/* Icon/Image */}}
      <div class="flex-shrink-0">
        {{ if $featured }}
        {{ $img := $featured.Fill "80x80 webp" }}
        <div class="w-20 h-20 rounded-xl overflow-hidden shadow-lg">
          <img src="{{ $img.RelPermalink }}" alt="{{ $name }}" width="{{ $img.Width }}" height="{{ $img.Height }}" class="w-full h-full object-cover" loading="lazy" />
        </div>
        {{ else }}
        <div class="w-20 h-20 rounded-xl bg-gradient-to-br from-primary/20 to-secondary/20 flex items-center justify-center shadow-lg">
          <div class="text-primary">
            {{ partial "icon.html" (dict "name" $icon "size" "10" "class" "w-10 h-10") }}
          </div>
        </div>
        {{ end }}
      </div>

      {{/* Title and description */}}
      <div class="flex-1">
        <h1 class="text-3xl lg:text-4xl font-bold mb-2">{{ $name }}</h1>
        {{ if $desc }}
        <p class="text-lg text-neutral-600 dark:text-neutral-400 mb-3">{{ $desc }}</p>
        {{ end }}

        {{/* Stats badges */}}
        <div class="flex flex-wrap gap-2">
          <span class="badge badge-lg badge-primary gap-1">
            {{ len $allPages }} items
          </span>
          {{ range $section, $count := $typeCounts }}
            {{ $config := index $typeConfig $section }}
            {{ if $config }}
            <span class="badge badge-lg badge-outline gap-1">
              {{ partial "icon.html" (dict "name" $config.icon "size" "4") }}
              {{ $count }} {{ if eq $count 1 }}{{ $config.label }}{{ else }}{{ $config.label }}s{{ end }}
            </span>
            {{ end }}
          {{ end }}
        </div>
      </div>

      {{/* Link to persona page */}}
      {{ with $personaPage }}
      <div class="flex-shrink-0">
        <a href="{{ .RelPermalink }}" class="btn btn-outline btn-primary btn-sm gap-2">
          {{ partial "icon.html" (dict "name" "user" "size" "4") }}
          Curated View
        </a>
      </div>
      {{ end }}
    </div>

    {{/* Abstract */}}
    {{ if $abstract }}
    <div class="mt-6 p-4 bg-base-200 rounded-lg border-l-4 border-primary">
      <p class="text-neutral-700 dark:text-neutral-300 italic">{{ $abstract }}</p>
    </div>
    {{ end }}
  </header>

  {{/* Unified Content Grid */}}
  {{ if gt (len $allPages) 0 }}
  <section>
    <div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
      {{ range sort $allPages "Date" "desc" }}
        {{ $page := . }}
        {{ $section := .Section }}
        {{ $config := index $typeConfig $section | default (dict "icon" "document" "color" "neutral" "label" ($section | humanize | title)) }}
        {{ $pageFeatured := .Resources.GetMatch "featured*" }}

        <a href="{{ .RelPermalink }}" class="card card-compact bg-base-100 border border-base-300 hover:border-primary hover:shadow-md transition-all group">
          {{/* Card Image or Placeholder */}}
          {{ if $pageFeatured }}
          {{ $img := $pageFeatured.Fill "400x180 webp" }}
          <figure class="h-36 overflow-hidden relative">
            <img src="{{ $img.RelPermalink }}" alt="{{ .Title }}" width="{{ $img.Width }}" height="{{ $img.Height }}" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300" loading="lazy" />
            {{/* Type badge overlay */}}
            <div class="absolute top-2 left-2">
              <span class="badge badge-{{ $config.color }} gap-1 shadow">
                {{ partial "icon.html" (dict "name" $config.icon "size" "3") }}
                {{ $config.label }}
              </span>
            </div>
          </figure>
          {{ else }}
          {{/* Placeholder with icon */}}
          <figure class="h-36 overflow-hidden bg-gradient-to-br from-{{ $config.color }}/10 to-{{ $config.color }}/5 flex items-center justify-center relative">
            <div class="text-{{ $config.color }}/30">
              {{ partial "icon.html" (dict "name" $config.icon "size" "16" "class" "w-16 h-16") }}
            </div>
            {{/* Type badge overlay */}}
            <div class="absolute top-2 left-2">
              <span class="badge badge-{{ $config.color }} gap-1 shadow">
                {{ partial "icon.html" (dict "name" $config.icon "size" "3") }}
                {{ $config.label }}
              </span>
            </div>
          </figure>
          {{ end }}

          <div class="card-body p-4">
            {{/* Title */}}
            <h3 class="card-title text-sm line-clamp-2 group-hover:text-primary transition-colors">{{ .Title }}</h3>

            {{/* Meta info based on content type */}}
            <div class="text-xs text-neutral-500 flex items-center gap-2">
              {{ if eq $section "events" }}
                {{/* Event: show date and location */}}
                {{ $eventDate := .Date }}
                <span>{{ $eventDate.Format "Jan 2, 2006" }}</span>
                {{ with .Params.locationCity }}
                <span class="flex items-center gap-1">
                  {{ partial "icon.html" (dict "name" "location" "size" "3") }}
                  {{ . }}
                </span>
                {{ end }}
              {{ else if eq $section "laws" }}
                {{/* Law: show alternate name and year */}}
                {{ with .Params.alternateName }}
                <span class="line-clamp-1">{{ . }}</span>
                {{ end }}
                {{ with .Params.legislationDate }}
                <span>({{ . }})</span>
                {{ end }}
              {{ else if eq $section "blog" }}
                {{/* Blog: show date and reading time */}}
                <span>{{ .Date.Format "Jan 2, 2006" }}</span>
                <span>{{ .ReadingTime }} min read</span>
              {{ else }}
                {{/* Default: show date */}}
                {{ with .Date }}
                <span>{{ .Format "Jan 2, 2006" }}</span>
                {{ end }}
              {{ end }}
            </div>

            {{/* Description preview */}}
            {{ with .Description }}
            <p class="text-xs text-neutral-600 dark:text-neutral-400 line-clamp-2 mt-1">{{ . }}</p>
            {{ end }}

            {{/* Law type badge */}}
            {{ if eq $section "laws" }}
              {{ $lawType := index $lawTypes (.Params.category | default "") }}
              {{ with $lawType }}
              <div class="mt-2">
                <span class="badge badge-sm badge-outline">{{ .emoji }} {{ .name }}</span>
              </div>
              {{ end }}
            {{ end }}
          </div>
        </a>
      {{ end }}
    </div>
  </section>
  {{ else }}
  <div class="alert alert-info">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
    <span>No content tagged for {{ $name }} yet.</span>
  </div>
  {{ end }}

  {{/* Back link */}}
  <footer class="mt-12 pt-8 border-t border-base-300">
    <div class="flex flex-wrap gap-4">
      <a href="/audience/" class="btn btn-ghost gap-2">
        &larr; All Audiences
      </a>
      {{ with $personaPage }}
      <a href="{{ .RelPermalink }}" class="btn btn-outline btn-primary gap-2">
        {{ partial "icon.html" (dict "name" "user" "size" "4") }}
        {{ $name }} Curated Page
      </a>
      {{ end }}
    </div>
  </footer>
</article>
{{ end }}
