{{ define "main" }}
{{/* Get audiences from audience.json */}}
{{ $audienceData := site.Data.audience.audience }}
{{ $audiences := $audienceData.itemListElement | default (slice) }}

{{/* Get persona pages for images */}}
{{ $personaPages := dict }}
{{ range where site.RegularPages "Section" "personas" }}
  {{ $personaPages = merge $personaPages (dict (path.Base .File.Dir) .) }}
{{ end }}

{{/* Count content per audience */}}
{{ $contentCounts := dict }}
{{ range $audiences }}
  {{ $id := .identifier }}
  {{ $count := 0 }}
  {{/* Count all pages with this audience */}}
  {{ range site.RegularPages }}
    {{ $pageAudience := .Params.audience | default (slice) }}
    {{ if in $pageAudience $id }}
      {{ $count = add $count 1 }}
    {{ end }}
  {{ end }}
  {{ $contentCounts = merge $contentCounts (dict $id $count) }}
{{ end }}

<article class="max-w-full">
  {{/* Section Header */}}
  {{ partial "section-header.html" (dict
      "title" "Content by Audience"
      "description" "Browse all content organized by target audience. Each audience page shows all blogs, events, publications, and laws relevant to that group."
      "icon" "users"
  ) }}

  {{/* Stats */}}
  {{ $totalAudiences := len $audiences }}
  {{ $totalContent := 0 }}
  {{ range $audiences }}
    {{ $totalContent = add $totalContent (index $contentCounts .identifier | default 0) }}
  {{ end }}

  <div class="stats stats-vertical sm:stats-horizontal shadow-lg w-full mb-8 bg-base-100">
    <div class="stat">
      <div class="stat-figure text-primary">
        {{ partial "content-icon.html" (dict "name" "users" "color" "primary" "size" "8") }}
      </div>
      <div class="stat-title">Audiences</div>
      <div class="stat-value text-primary">{{ $totalAudiences }}</div>
      <div class="stat-desc">Target groups</div>
    </div>
    <div class="stat">
      <div class="stat-figure text-secondary">
        {{ partial "content-icon.html" (dict "name" "document" "color" "secondary" "size" "8") }}
      </div>
      <div class="stat-title">Tagged Content</div>
      <div class="stat-value text-secondary">{{ $totalContent }}</div>
      <div class="stat-desc">Across all audiences</div>
    </div>
  </div>

  {{/* Info alert */}}
  <div class="alert alert-info mb-8">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
    <div>
      <p class="font-medium">Looking for curated content?</p>
      <p class="text-sm">Visit <a href="/personas/" class="link">Personas</a> for editorial overviews with handpicked recommendations for each audience.</p>
    </div>
  </div>

  {{/* Audience Cards Grid */}}
  <section class="mt-8">
    {{ if gt (len $audiences) 0 }}
    <div class="grid gap-6 sm:grid-cols-2 lg:grid-cols-3">
      {{ range $audiences }}
        {{ $p := . }}
        {{ $term := $p.identifier | default "" }}
        {{ $name := $p.name | default ($term | humanize | title) }}
        {{ $desc := $p.description | default "" }}
        {{ $icon := $p.icon | default "user" }}
        {{ $count := index $contentCounts $term | default 0 }}

        {{/* Get the persona page and its featured image */}}
        {{ $personaPage := index $personaPages $term }}
        {{ $featured := false }}
        {{ with $personaPage }}
          {{ $featured = .Resources.GetMatch "featured*" }}
        {{ end }}

        <a href="/audience/{{ $term }}/" class="card bg-base-100 shadow-md hover:shadow-lg transition-all group border border-base-200 hover:border-primary">
          {{/* Card Image */}}
          {{ if $featured }}
          <figure class="h-40 overflow-hidden bg-base-200">
            <img src="{{ $featured.RelPermalink }}" alt="{{ $name }}" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300" />
          </figure>
          {{ else }}
          {{/* Placeholder gradient with icon */}}
          <figure class="h-40 overflow-hidden bg-gradient-to-br from-primary/10 via-secondary/10 to-accent/10 flex items-center justify-center">
            <div class="text-primary/30 group-hover:text-primary/50 transition-colors" style="width: 4rem; height: 4rem;">
              {{ partial "content-icon.html" (dict "name" $icon "class" "w-full h-full") }}
            </div>
          </figure>
          {{ end }}

          <div class="card-body p-4">
            {{/* Title with icon */}}
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-2">
                <div class="text-primary">
                  {{ partial "content-icon.html" (dict "name" $icon "size" "5") }}
                </div>
                <h2 class="card-title text-base group-hover:text-primary transition-colors m-0">{{ $name }}</h2>
              </div>
              <span class="badge badge-primary badge-sm">{{ $count }}</span>
            </div>

            {{/* Description */}}
            {{ if $desc }}
            <p class="text-sm text-neutral-600 dark:text-neutral-400 line-clamp-2 mt-2 mb-0">{{ $desc }}</p>
            {{ end }}

            {{/* View all link */}}
            <div class="card-actions justify-end mt-2">
              <span class="text-xs text-primary group-hover:underline">View all content &rarr;</span>
            </div>
          </div>
        </a>
      {{ end }}
    </div>
    {{ else }}
    <p class="text-neutral-600 dark:text-neutral-400">No audiences found.</p>
    {{ end }}
  </section>
</article>
{{ end }}
