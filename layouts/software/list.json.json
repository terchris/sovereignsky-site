{{- $products := slice -}}
{{- range .Pages -}}
{{- $product := index (where site.Data.products.products.products "id" .Params.software_id) 0 -}}
{{- if $product -}}
{{- $vendor := index (where site.Data.products.vendors.vendors "id" $product.vendor_id) 0 -}}
{{- $useAreaNames := slice -}}
{{- range $product.use_areas -}}
  {{- $area := index (where site.Data.products.useAreas "id" .) 0 -}}
  {{- if $area -}}
    {{- $useAreaNames = $useAreaNames | append $area.name -}}
  {{- end -}}
{{- end -}}
{{- $item := dict
  "id" $product.id
  "slug" $product.slug
  "name" $product.name
  "description" $product.description
  "vendor_id" $product.vendor_id
  "vendor_name" $vendor.name
  "vendor_country" $vendor.country
  "vendor_country_name" ($vendor.country_name | default $vendor.country)
  "risk_level" $product.risk_level
  "jurisdiction_exposure" $product.hosting.jurisdiction_exposure
  "data_residency" $product.hosting.data_residency
  "self_hosted" $product.hosting.self_hosted
  "open_source" $product.open_source
  "use_areas" $product.use_areas
  "use_area_names" $useAreaNames
  "url" .RelPermalink
-}}
{{- $products = $products | append $item -}}
{{- end -}}
{{- end -}}
{{- $products | jsonify -}}
