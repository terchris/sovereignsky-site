{{ define "main" }}
<article class="max-w-full">
  {{/* Section Header */}}
  {{ partial "section-header.html" (dict
      "title" .Title
      "description" .Description
      "icon" "calendar"
  ) }}

  {{/* Stats row */}}
  {{- $events := site.Data.events.events -}}
  {{- $now := now.Format "2006-01-02" -}}
  {{- $upcomingCount := 0 -}}
  {{- $thisMonthCount := 0 -}}
  {{- $thisMonth := now.Format "2006-01" -}}
  {{- range $events -}}
    {{- if ge .startDate $now -}}
      {{- $upcomingCount = add $upcomingCount 1 -}}
      {{- if hasPrefix .startDate $thisMonth -}}
        {{- $thisMonthCount = add $thisMonthCount 1 -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}

  <div class="stats stats-vertical sm:stats-horizontal shadow-lg w-full mb-8 bg-base-100">
    <div class="stat">
      <div class="stat-figure text-primary">
        {{ partial "content-icon.html" (dict "name" "calendar" "color" "primary" "size" "8") }}
      </div>
      <div class="stat-title">Upcoming Events</div>
      <div class="stat-value text-primary">{{ $upcomingCount }}</div>
      <div class="stat-desc">In 2026</div>
    </div>
    <div class="stat">
      <div class="stat-figure text-secondary">
        {{ partial "content-icon.html" (dict "name" "clock" "color" "secondary" "size" "8") }}
      </div>
      <div class="stat-title">This Month</div>
      <div class="stat-value text-secondary">{{ $thisMonthCount }}</div>
      <div class="stat-desc">{{ now.Format "January 2006" }}</div>
    </div>
    <div class="stat">
      <div class="stat-figure text-accent">
        {{ partial "content-icon.html" (dict "name" "location" "color" "accent" "size" "8") }}
      </div>
      <div class="stat-title">Focus</div>
      <div class="stat-value text-accent text-2xl">Norway</div>
      <div class="stat-desc">Digital sovereignty</div>
    </div>
  </div>

  {{/* Audience filter - from audience.json */}}
  {{ $audienceData := site.Data.audience.audience }}
  <div class="mb-6">
    <div class="text-sm font-semibold opacity-70 mb-3">Filter by Audience:</div>
    <div class="flex flex-wrap gap-2" data-filter-group="audience">
      <button class="btn btn-sm btn-active gap-1" data-filter="all">
        {{ partial "content-icon.html" (dict "name" "users" "size" "4") }}
        All
      </button>
      {{- range $audienceData.itemListElement }}
      <button class="btn btn-sm btn-ghost gap-1" data-filter="{{ .identifier }}">
        {{ partial "content-icon.html" (dict "name" .icon "size" "4") }}
        {{ .name }}
      </button>
      {{- end }}
    </div>
  </div>

  {{/* Topic filter - from data/topics/topics.json */}}
  {{ $topicsData := site.Data.topics.topics }}
  {{ $topicLabels := dict }}
  {{ range $topicsData.itemListElement }}
    {{ $topicLabels = merge $topicLabels (dict .identifier .name) }}
  {{ end }}
  <div class="flex flex-wrap items-center gap-2 mb-6">
    <span class="text-sm font-semibold opacity-70">Topic:</span>
    <div class="join" data-filter-group="tags">
      <button class="join-item btn btn-sm btn-active" data-filter="all">All</button>
      {{- range $topicsData.filterValues }}
      <button class="join-item btn btn-sm" data-filter="{{ . }}">{{ index $topicLabels . | default (. | humanize | title) }}</button>
      {{- end }}
    </div>
  </div>

  {{/* Event list */}}
  <div class="events-content mb-8">
    {{ .Content }}
  </div>

  {{/* Legend */}}
  <div class="alert shadow-lg">
    {{ partial "content-icon.html" (dict "name" "info" "color" "info" "size" "6") }}
    <div>
      <h3 class="font-bold">About these events</h3>
      <p class="text-sm">Curated by SovereignSky for digital sovereignty, cybersecurity, and national preparedness. Not affiliated with organizers unless noted.</p>
    </div>
    <a href="https://github.com/terchris/sovereignsky-site/issues/new" target="_blank" rel="noopener" class="btn btn-sm btn-primary">Suggest Event</a>
  </div>
</article>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const filterButtons = document.querySelectorAll('[data-filter-group] button[data-filter]');
  const eventCards = document.querySelectorAll('.event-card');

  let activeFilters = {
    tags: 'all',
    audience: 'all'
  };

  function setActiveButton(filterGroup, filterValue) {
    const groupEl = document.querySelector(`[data-filter-group="${filterGroup}"]`);
    if (!groupEl) return;
    const btn = groupEl.querySelector(`button[data-filter="${filterValue}"]`);
    const fallback = groupEl.querySelector(`button[data-filter="all"]`);
    const target = btn || fallback;
    if (!target) return;

    // Update active state
    groupEl.querySelectorAll('button').forEach(b => {
      b.classList.remove('btn-active');
      b.classList.add('btn-ghost');
    });
    target.classList.add('btn-active');
    target.classList.remove('btn-ghost');

    // Update state
    activeFilters[filterGroup] = target.dataset.filter;
  }

  function updateURL() {
    const params = new URLSearchParams();
    if (activeFilters.tags && activeFilters.tags !== 'all') params.set('tag', activeFilters.tags);
    if (activeFilters.audience && activeFilters.audience !== 'all') params.set('audience', activeFilters.audience);
    const qs = params.toString();
    const newURL = qs ? `?${qs}` : window.location.pathname;
    history.replaceState(null, '', newURL);
  }

  function applyFilters() {
    eventCards.forEach(card => {
      const cardTags = card.dataset.tags || '';
      const cardAudience = card.dataset.audience || '';

      const matchesTags = activeFilters.tags === 'all' || cardTags.includes(activeFilters.tags);
      const matchesAudience = activeFilters.audience === 'all' || cardAudience.includes(activeFilters.audience);

      if (matchesTags && matchesAudience) {
        card.style.display = '';
      } else {
        card.style.display = 'none';
      }
    });

    // Show empty message if no results
    const visibleCards = document.querySelectorAll('.event-card:not([style*="display: none"])');
    let emptyMsg = document.querySelector('.events-empty-filtered');

    if (visibleCards.length === 0) {
      if (!emptyMsg) {
        emptyMsg = document.createElement('div');
        emptyMsg.className = 'events-empty-filtered alert alert-warning my-4';
        emptyMsg.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg><span>No events match the selected filters.</span>';
        const listEl = document.querySelector('.event-list');
        if (listEl) listEl.appendChild(emptyMsg);
      }
    } else if (emptyMsg) {
      emptyMsg.remove();
    }
  }

  // Initialize from URL
  const params = new URLSearchParams(window.location.search);
  const urlAudience = params.get('audience') || 'all';
  const urlTag = params.get('tag') || params.get('tags') || 'all';
  setActiveButton('audience', urlAudience);
  setActiveButton('tags', urlTag);
  applyFilters();

  filterButtons.forEach(btn => {
    btn.addEventListener('click', function() {
      const groupEl = this.closest('[data-filter-group]');
      const filterGroup = groupEl.dataset.filterGroup;
      const filterValue = this.dataset.filter;

      // Update active state in this group
      groupEl.querySelectorAll('button').forEach(b => {
        b.classList.remove('btn-active');
        b.classList.add('btn-ghost');
      });
      this.classList.add('btn-active');
      this.classList.remove('btn-ghost');

      // Update filter state
      activeFilters[filterGroup] = filterValue;

      applyFilters();
      updateURL();
    });
  });
});
</script>
{{ end }}
