{{ define "main" }}
<div class="not-prose">
  {{/* Hero header */}}
  <div class="bg-gradient-to-r from-primary to-secondary text-primary-content rounded-box p-8 mb-8">
    <h1 class="text-4xl font-bold mb-2">{{ .Title }}</h1>
    {{ with .Description }}
    <p class="text-lg opacity-90">{{ . }}</p>
    {{ end }}
  </div>

  {{/* Stats row */}}
  {{- $events := site.Data.events.events -}}
  {{- $now := now.Format "2006-01-02" -}}
  {{- $upcomingCount := 0 -}}
  {{- $thisMonthCount := 0 -}}
  {{- $thisMonth := now.Format "2006-01" -}}
  {{- range $events -}}
    {{- if ge .startDate $now -}}
      {{- $upcomingCount = add $upcomingCount 1 -}}
      {{- if hasPrefix .startDate $thisMonth -}}
        {{- $thisMonthCount = add $thisMonthCount 1 -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}

  <div class="stats stats-vertical sm:stats-horizontal shadow-lg w-full mb-8 bg-base-100">
    <div class="stat">
      <div class="stat-figure text-primary">
        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
        </svg>
      </div>
      <div class="stat-title">Upcoming Events</div>
      <div class="stat-value text-primary">{{ $upcomingCount }}</div>
      <div class="stat-desc">In 2026</div>
    </div>
    <div class="stat">
      <div class="stat-figure text-secondary">
        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
      </div>
      <div class="stat-title">This Month</div>
      <div class="stat-value text-secondary">{{ $thisMonthCount }}</div>
      <div class="stat-desc">{{ now.Format "January 2006" }}</div>
    </div>
    <div class="stat">
      <div class="stat-figure text-accent">
        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
        </svg>
      </div>
      <div class="stat-title">Focus</div>
      <div class="stat-value text-accent text-2xl">Norway</div>
      <div class="stat-desc">Digital sovereignty</div>
    </div>
  </div>

  {{/* Filter bar */}}
  <div class="card bg-base-100 shadow-md mb-8">
    <div class="card-body p-4">
      <div class="flex flex-col lg:flex-row gap-4">
        <div class="flex flex-wrap items-center gap-2">
          <span class="text-sm font-semibold opacity-70">Topic:</span>
          <div class="join" data-filter-group="tags">
            <button class="join-item btn btn-sm btn-active" data-filter="all">All</button>
            <button class="join-item btn btn-sm" data-filter="cybersecurity">Cybersecurity</button>
            <button class="join-item btn btn-sm" data-filter="preparedness">Preparedness</button>
            <button class="join-item btn btn-sm" data-filter="critical-infrastructure">Infrastructure</button>
            <button class="join-item btn btn-sm" data-filter="sovereignty">Sovereignty</button>
          </div>
        </div>

        <div class="divider lg:divider-horizontal m-0"></div>

        <div class="flex flex-wrap items-center gap-2">
          <span class="text-sm font-semibold opacity-70">Audience:</span>
          <div class="join" data-filter-group="audience">
            <button class="join-item btn btn-sm btn-active" data-filter="all">All</button>
            <button class="join-item btn btn-sm" data-filter="government">Public Sector</button>
            <button class="join-item btn btn-sm" data-filter="defence">Defence</button>
            <button class="join-item btn btn-sm" data-filter="enterprise">Enterprise</button>
            <button class="join-item btn btn-sm" data-filter="technical">IT & Ops</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  {{/* Event list */}}
  <div class="events-content mb-8">
    {{ .Content }}
  </div>

  {{/* Legend */}}
  <div class="alert shadow-lg">
    <svg class="w-6 h-6 stroke-info" fill="none" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
    </svg>
    <div>
      <h3 class="font-bold">About these events</h3>
      <p class="text-sm">Curated by SovereignSky for digital sovereignty, cybersecurity, and national preparedness. Not affiliated with organizers unless noted.</p>
    </div>
    <a href="https://github.com/terchris/sovereignsky-site/issues/new" target="_blank" rel="noopener" class="btn btn-sm btn-primary">Suggest Event</a>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const filterButtons = document.querySelectorAll('.join-item.btn[data-filter]');
  const eventCards = document.querySelectorAll('.event-card');

  let activeFilters = {
    tags: 'all',
    audience: 'all'
  };

  function setActiveButton(filterGroup, filterValue) {
    const groupEl = document.querySelector(`[data-filter-group="${filterGroup}"]`);
    if (!groupEl) return;
    const btn = groupEl.querySelector(`button[data-filter="${filterValue}"]`);
    const fallback = groupEl.querySelector(`button[data-filter="all"]`);
    const target = btn || fallback;
    if (!target) return;

    // Update active state
    groupEl.querySelectorAll('button').forEach(b => b.classList.remove('btn-active'));
    target.classList.add('btn-active');

    // Update state
    activeFilters[filterGroup] = target.dataset.filter;
  }

  function updateURL() {
    const params = new URLSearchParams();
    if (activeFilters.tags && activeFilters.tags !== 'all') params.set('tag', activeFilters.tags);
    if (activeFilters.audience && activeFilters.audience !== 'all') params.set('audience', activeFilters.audience);
    const qs = params.toString();
    const newURL = qs ? `?${qs}` : window.location.pathname;
    history.replaceState(null, '', newURL);
  }

  function applyFilters() {
    eventCards.forEach(card => {
      const cardTags = card.dataset.tags || '';
      const cardAudience = card.dataset.audience || '';

      const matchesTags = activeFilters.tags === 'all' || cardTags.includes(activeFilters.tags);
      const matchesAudience = activeFilters.audience === 'all' || cardAudience.includes(activeFilters.audience);

      if (matchesTags && matchesAudience) {
        card.style.display = '';
      } else {
        card.style.display = 'none';
      }
    });

    // Show empty message if no results
    const visibleCards = document.querySelectorAll('.event-card:not([style*="display: none"])');
    let emptyMsg = document.querySelector('.events-empty-filtered');

    if (visibleCards.length === 0) {
      if (!emptyMsg) {
        emptyMsg = document.createElement('div');
        emptyMsg.className = 'events-empty-filtered alert alert-warning my-4';
        emptyMsg.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg><span>No events match the selected filters.</span>';
        const listEl = document.querySelector('.event-list');
        if (listEl) listEl.appendChild(emptyMsg);
      }
    } else if (emptyMsg) {
      emptyMsg.remove();
    }
  }

  // Initialize from URL
  const params = new URLSearchParams(window.location.search);
  const urlAudience = params.get('audience') || 'all';
  const urlTag = params.get('tag') || params.get('tags') || 'all';
  setActiveButton('audience', urlAudience);
  setActiveButton('tags', urlTag);
  applyFilters();

  filterButtons.forEach(btn => {
    btn.addEventListener('click', function() {
      const filterGroup = this.closest('[data-filter-group]').dataset.filterGroup;
      const filterValue = this.dataset.filter;

      // Update active state in this group
      this.closest('.join').querySelectorAll('button').forEach(b => {
        b.classList.remove('btn-active');
      });
      this.classList.add('btn-active');

      // Update filter state
      activeFilters[filterGroup] = filterValue;

      applyFilters();
      updateURL();
    });
  });
});
</script>
{{ end }}
