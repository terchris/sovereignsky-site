{{ define "main" }}
{{ .Scratch.Set "scope" "single" }}

{{/* Get persona data from JSON based on page's persona_id param or slug */}}
{{ $personaId := .Params.persona_id | default (path.Base .File.Dir) }}
{{ $audienceData := site.Data.audience.audience }}
{{ $audiences := $audienceData.itemListElement | default (slice) }}
{{ $persona := dict }}
{{ range $audiences }}
  {{ if eq .identifier $personaId }}
    {{ $persona = . }}
  {{ end }}
{{ end }}

{{ $term := $persona.identifier | default $personaId }}
{{ $personaName := $persona.name | default ($term | humanize | title) }}
{{ $personaShortDesc := .Params.summary | default $persona.description | default "" }}
{{ $personaDesc := .Params.abstract | default $persona.abstract | default "" }}
{{ $personaIcon := $persona.icon | default "user" }}
{{ $personaTopics := $persona.topics | default (slice) }}

{{/* Build audience vocab for checking if this persona is used in events */}}
{{ $audienceVocab := slice }}
{{ range $audiences }}
  {{ $audienceVocab = $audienceVocab | append .identifier }}
{{ end }}
{{ $isAudience := in $audienceVocab $term }}

{{/* Get related blog posts - by audiences match OR by topic/tag match */}}
{{ $blogPages := where site.RegularPages "Section" "blog" }}
{{ $relatedPosts := slice }}
{{ range $blogPages }}
  {{ $post := . }}
  {{ $match := false }}
  {{ range ($post.Params.audience | default (slice)) }}
    {{ if eq . $term }}{{ $match = true }}{{ end }}
  {{ end }}
  {{ if not $match }}
    {{ $postTopics := $post.Params.topics | default (slice) }}
    {{ $postTags := $post.Params.tags | default (slice) }}
    {{ range $postTopics }}
      {{ if in $personaTopics . }}{{ $match = true }}{{ end }}
    {{ end }}
    {{ range $postTags }}
      {{ if in $personaTopics . }}{{ $match = true }}{{ end }}
    {{ end }}
  {{ end }}
  {{ if $match }}
    {{ $relatedPosts = $relatedPosts | append $post }}
  {{ end }}
{{ end }}
{{ $relatedPosts = sort $relatedPosts "Date" "desc" | first 6 }}

{{/* Get related publications - by audience match OR by topic match */}}
{{ $relatedPubs := slice }}
{{ $pubsSection := where site.RegularPages "Section" "publications" }}
{{ range $pubsSection }}
  {{ $pub := . }}
  {{ $match := false }}
  {{ range ($pub.Params.audience | default (slice)) }}
    {{ if eq . $term }}{{ $match = true }}{{ end }}
  {{ end }}
  {{ if not $match }}
    {{ $pubTopics := $pub.Params.topics | default (slice) }}
    {{ range $pubTopics }}
      {{ if in $personaTopics . }}{{ $match = true }}{{ end }}
    {{ end }}
  {{ end }}
  {{ if $match }}
    {{ $relatedPubs = $relatedPubs | append $pub }}
  {{ end }}
{{ end }}
{{ $relatedPubs = sort $relatedPubs "Date" "desc" | first 6 }}

{{/* Get related laws - by audience (persona) match */}}
{{ $lawsSection := where site.RegularPages "Section" "laws" }}
{{ $relatedLaws := slice }}
{{ range $lawsSection }}
  {{ $law := . }}
  {{ range ($law.Params.audience | default (slice)) }}
    {{ if eq . $term }}
      {{ $relatedLaws = $relatedLaws | append $law }}
    {{ end }}
  {{ end }}
{{ end }}
{{ $relatedLaws = $relatedLaws | first 8 }}

{{/* Build events URL */}}
{{ $eventsURL := "/events/" }}
{{ if $isAudience }}{{ $eventsURL = printf "/events/?audience=%s" $term }}{{ end }}

{{/* Get featured image */}}
{{ $featured := .Resources.GetMatch "featured*" }}

{{/* Build pageData for content partial */}}
{{ $pageData := dict
    "personaName" $personaName
    "personaDesc" $personaDesc
    "personaIcon" $personaIcon
    "featured" $featured
    "relatedPosts" $relatedPosts
    "relatedLaws" $relatedLaws
    "relatedPubs" $relatedPubs
    "isAudience" $isAudience
    "term" $term
    "eventsURL" $eventsURL
}}

{{ partial "common-single-page.html" (dict
    "page" .
    "icon" $personaIcon
    "section" "Personas"
    "sectionUrl" "/personas/"
    "headerDescription" $personaShortDesc
    "showAbstract" false
    "showSummary" false
    "showFeaturedImage" false
    "showQuote" false
    "showToc" false
    "contentPartial" "content/personas-content.html"
    "pageData" $pageData
    "sidebarCards" (slice
        "sidebar/personas-quick-links-card.html"
        "sidebar/personas-curation-card.html"
        "sidebar/common-topics-card.html"
        "sidebar/common-law-types-card.html"
    )
) }}

{{ end }}
