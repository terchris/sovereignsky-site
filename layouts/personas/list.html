{{ define "main" }}
{{ $personas := site.Data.personas.personas.itemListElement | default (slice) }}
{{ $vocab := site.Data.tag_vocabulary }}
{{ $audienceVocab := $vocab.audience.values | default (slice) }}
{{ $audienceLabels := $vocab.audience.labels | default (dict) }}

{{/* Build a map of persona pages for image lookup */}}
{{ $personaPages := dict }}
{{ range .Pages }}
  {{ $personaPages = merge $personaPages (dict (path.Base .File.Dir) .) }}
{{ end }}

<article class="max-w-full">
  {{/* Section Header */}}
  {{ partial "section-header.html" (dict
      "title" .Title
      "description" .Description
      "icon" "users"
  ) }}

  {{/* Section Content */}}
  <section class="max-w-full mt-6 prose dark:prose-invert prose-table:w-full prose-img:max-w-full [&>*]:max-w-none">
    {{ .Content }}
  </section>

  {{/* Persona Cards Grid */}}
  <section class="mt-8">
    {{ if gt (len $personas) 0 }}
    <div class="grid gap-6 sm:grid-cols-2 lg:grid-cols-3">
      {{ range $personas }}
        {{ $p := . }}
        {{ $term := $p.audienceType | default "" }}
        {{/* Skip "all" persona - not useful to display */}}
        {{ if eq $term "all" }}{{ continue }}{{ end }}
        {{ $name := $p.name | default ($term | humanize | title) }}
        {{ $desc := $p.disambiguatingDescription | default "" }}
        {{ $icon := $p.icon | default "user" }}
        {{ $isAudience := in $audienceVocab $term }}

        {{/* Get the persona page and its featured image */}}
        {{ $personaPage := index $personaPages $term }}
        {{ $featured := false }}
        {{ with $personaPage }}
          {{ $featured = .Resources.GetMatch "featured*" }}
        {{ end }}

        {{/* Count relevant content for this persona */}}
        {{ $fc := $p.filterCriteria | default (dict) }}
        {{ $preferTags := $fc.preferTags | default (slice) }}
        {{ $preferCats := $fc.preferCategories | default (slice) }}

        <a href="/personas/{{ $term }}/" class="card bg-base-100 shadow-md hover:shadow-lg transition-all group border border-base-200 hover:border-primary">
          {{/* Card Image */}}
          {{ if $featured }}
          <figure class="h-40 overflow-hidden bg-base-200">
            <img src="{{ $featured.RelPermalink }}" alt="{{ $name }}" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300" />
          </figure>
          {{ else }}
          {{/* Placeholder gradient with icon */}}
          <figure class="h-40 overflow-hidden bg-gradient-to-br from-primary/10 via-secondary/10 to-accent/10 flex items-center justify-center">
            <div class="text-primary/30 group-hover:text-primary/50 transition-colors" style="width: 4rem; height: 4rem;">
              {{ partial "content-icon.html" (dict "name" $icon "class" "w-full h-full") }}
            </div>
          </figure>
          {{ end }}

          <div class="card-body p-4">
            {{/* Title with icon */}}
            <div class="flex items-center gap-2">
              <div class="text-primary">
                {{ partial "content-icon.html" (dict "name" $icon "size" "5") }}
              </div>
              <h2 class="card-title text-base group-hover:text-primary transition-colors m-0">{{ $name }}</h2>
            </div>

            {{/* Description */}}
            {{ if $desc }}
            <p class="text-sm text-neutral-600 dark:text-neutral-400 line-clamp-2 mt-2 mb-0">{{ $desc }}</p>
            {{ end }}

            {{/* Tags preview */}}
            <div class="mt-3 flex flex-wrap gap-1">
              {{ if $isAudience }}
              <span class="badge badge-xs badge-primary">Events</span>
              {{ end }}
              {{ if gt (len $preferCats) 0 }}
              <span class="badge badge-xs badge-secondary">Software</span>
              {{ end }}
              <span class="badge badge-xs badge-accent">Laws</span>
            </div>
          </div>
        </a>
      {{ end }}
    </div>
    {{ else }}
    <p class="text-neutral-600 dark:text-neutral-400">No personas found.</p>
    {{ end }}
  </section>
</article>
{{ end }}
