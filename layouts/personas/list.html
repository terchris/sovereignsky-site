{{ define "main" }}
{{/* Get audiences from audience.json */}}
{{ $audienceData := site.Data.audience.audience }}
{{ $audiences := $audienceData.itemListElement | default (slice) }}
{{/* Build audience values and labels from data */}}
{{ $audienceVocab := slice }}
{{ $audienceLabels := dict }}
{{ range $audiences }}
  {{ $audienceVocab = $audienceVocab | append .identifier }}
  {{ $audienceLabels = merge $audienceLabels (dict .identifier .name) }}
{{ end }}

{{/* Build a map of persona pages for image lookup */}}
{{ $personaPages := dict }}
{{ range .Pages }}
  {{ $personaPages = merge $personaPages (dict (path.Base .File.Dir) .) }}
{{ end }}

<article class="max-w-full">
  {{/* Section Header */}}
  {{ partial "section-header.html" (dict
      "title" .Title
      "description" .Description
      "icon" "users"
  ) }}

  {{/* Section Content */}}
  <section class="max-w-full mt-6 prose dark:prose-invert prose-table:w-full prose-img:max-w-full [&>*]:max-w-none">
    {{ .Content }}
  </section>

  {{/* Audience Cards Grid */}}
  <section class="mt-8">
    {{ if gt (len $audiences) 0 }}
    <div class="grid sm:grid-cols-2 lg:grid-cols-3" style="gap: 1.5rem;">
      {{ range $audiences }}
        {{ $p := . }}
        {{ $term := $p.identifier | default "" }}
        {{ $name := $p.name | default ($term | humanize | title) }}
        {{ $desc := $p.description | default "" }}
        {{ $iconPath := $p.iconPath | default "" }}
        {{ $isAudience := in $audienceVocab $term }}

        {{/* Get the persona page and its featured image */}}
        {{ $personaPage := index $personaPages $term }}
        {{ $featured := false }}
        {{ with $personaPage }}
          {{ $featured = .Resources.GetMatch "featured*" }}
        {{ end }}

        {{/* Count relevant content for this persona */}}
        {{ $fc := $p.filterCriteria | default (dict) }}
        {{ $preferTags := $fc.preferTags | default (slice) }}
        {{ $preferCats := $fc.preferCategories | default (slice) }}

        <a href="/personas/{{ $term }}/" class="card bg-base-100 shadow-md hover:shadow-lg transition-all group border border-base-200 hover:border-primary">
          {{/* Card Image */}}
          {{ if $featured }}
          {{ $img := $featured.Fill "400x200 webp" }}
          <figure class="h-40 overflow-hidden bg-base-200">
            <img src="{{ $img.RelPermalink }}" alt="{{ $name }}" width="{{ $img.Width }}" height="{{ $img.Height }}" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300" loading="lazy" />
          </figure>
          {{ else }}
          {{/* Placeholder gradient with icon */}}
          <figure class="h-40 overflow-hidden bg-gradient-to-br from-primary/10 via-secondary/10 to-accent/10 flex items-center justify-center">
            <div class="text-primary/30 group-hover:text-primary/50 transition-colors" style="width: 4rem; height: 4rem;">
              {{ if $iconPath }}
              <svg class="w-full h-full" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="{{ $iconPath }}"/>
              </svg>
              {{ end }}
            </div>
          </figure>
          {{ end }}

          <div class="card-body p-4">
            {{/* Title with icon */}}
            <div class="flex items-center gap-2">
              {{ if $iconPath }}
              <div class="text-primary">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="{{ $iconPath }}"/>
                </svg>
              </div>
              {{ end }}
              <h2 class="card-title text-base group-hover:text-primary transition-colors m-0">{{ $name }}</h2>
            </div>

            {{/* Description */}}
            {{ if $desc }}
            <p class="text-sm text-neutral-600 dark:text-neutral-400 line-clamp-2 mt-2 mb-0">{{ $desc }}</p>
            {{ end }}

          </div>
        </a>
      {{ end }}
    </div>
    {{ else }}
    <p class="text-neutral-600 dark:text-neutral-400">No audiences found.</p>
    {{ end }}
  </section>
</article>
{{ end }}
