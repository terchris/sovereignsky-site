{{ define "main" }}
{{/* Build lookup maps */}}
{{ $lawTypes := dict }}
{{ range site.Data.laws.law_types.itemListElement }}
  {{ $lawTypes = merge $lawTypes (dict .identifier .) }}
{{ end }}

{{/* Build region lookup from countries data */}}
{{ $regionLookup := dict }}
{{ range (site.Data.countries.countries.itemListElement) }}
  {{ $regionLookup = merge $regionLookup (dict .identifier .) }}
{{ end }}

{{/* Build bloc lookup from blocs data */}}
{{ $blocLookup := dict }}
{{ range (site.Data.blocs.blocs.itemListElement) }}
  {{ $blocLookup = merge $blocLookup (dict .identifier .) }}
{{ end }}

{{/* Collect unique jurisdictions from all laws */}}
{{ $jurisdictionSet := slice }}
{{ range site.Data.laws.laws.itemListElement }}
  {{ range .legislationJurisdiction }}
    {{ if not (in $jurisdictionSet .) }}
      {{ $jurisdictionSet = $jurisdictionSet | append . }}
    {{ end }}
  {{ end }}
{{ end }}

{{/* Build jurisdiction filter items (blocs first, then countries) */}}
{{ $blocFilters := slice }}
{{ $countryFilters := slice }}
{{ range $jurisdictionSet }}
  {{ $id := . }}
  {{ $bloc := index $blocLookup $id }}
  {{ $country := index $regionLookup $id }}
  {{ if $bloc }}
    {{ $blocFilters = $blocFilters | append (dict "id" $id "name" $bloc.name "flag" $bloc.flag "isBloc" true) }}
  {{ else if $country }}
    {{ $countryFilters = $countryFilters | append (dict "id" $id "name" $country.name "flag" $country.flag "isBloc" false) }}
  {{ end }}
{{ end }}
{{ $blocFilters = sort $blocFilters "name" "asc" }}
{{ $countryFilters = sort $countryFilters "name" "asc" }}

{{/* Category badge colors using DaisyUI */}}
{{ $categoryBadge := dict
  "privacy" "badge-success"
  "access" "badge-warning"
  "surveillance" "badge-error"
  "localization" "badge-info"
  "security" "badge-secondary"
  "sector" "badge-ghost"
}}

{{/* Count laws per category */}}
{{ $lawsPerCategory := dict }}
{{ range site.Data.laws.laws.itemListElement }}
  {{ $cat := .category | default "other" }}
  {{ $prev := index $lawsPerCategory $cat | default 0 }}
  {{ $lawsPerCategory = merge $lawsPerCategory (dict $cat (add $prev 1)) }}
{{ end }}

{{/* Count laws per jurisdiction */}}
{{ $lawsPerJurisdiction := dict }}
{{ range site.Data.laws.laws.itemListElement }}
  {{ range .legislationJurisdiction }}
    {{ $prev := index $lawsPerJurisdiction . | default 0 }}
    {{ $lawsPerJurisdiction = merge $lawsPerJurisdiction (dict . (add $prev 1)) }}
  {{ end }}
{{ end }}

{{/* Count laws per feature */}}
{{ $lawsExtraterritorial := 0 }}
{{ $lawsLocalization := 0 }}
{{ $lawsBackdoor := 0 }}
{{ range site.Data.laws.laws.itemListElement }}
  {{ if .extraterritorial }}{{ $lawsExtraterritorial = add $lawsExtraterritorial 1 }}{{ end }}
  {{ if .requiresLocalization }}{{ $lawsLocalization = add $lawsLocalization 1 }}{{ end }}
  {{ if .requiresBackdoor }}{{ $lawsBackdoor = add $lawsBackdoor 1 }}{{ end }}
{{ end }}

<div class="max-w-full" id="laws-app">

  {{/* Section Header */}}
  {{ partial "section-header.html" (dict
      "title" .Title
      "description" .Description
      "icon" "scale"
  ) }}

  {{/* Stats cards */}}
  {{ $total := len .Pages }}
  {{ $extraterritorial := 0 }}
  {{ $govAccess := 0 }}
  {{ range .Pages }}
    {{ if .Params.extraterritorial }}{{ $extraterritorial = add $extraterritorial 1 }}{{ end }}
    {{ if and .Params.governmentAccess (ne .Params.governmentAccess "none") }}{{ $govAccess = add $govAccess 1 }}{{ end }}
  {{ end }}

  <div class="stats stats-vertical sm:stats-horizontal shadow-lg w-full mb-8 bg-base-100">
    <div class="stat">
      <div class="stat-figure text-primary">
        {{ partial "data-icon.html" (dict "name" "scale" "color" "primary" "size" "8") }}
      </div>
      <div class="stat-title">Laws Documented</div>
      <div class="stat-value text-primary">{{ $total }}</div>
      <div class="stat-desc">Legal frameworks</div>
    </div>
    <div class="stat">
      <div class="stat-figure text-error">
        {{ partial "data-icon.html" (dict "name" "globe" "color" "error" "size" "8") }}
      </div>
      <div class="stat-title">Extraterritorial Reach</div>
      <div class="stat-value text-error">{{ $extraterritorial }}</div>
      <div class="stat-desc">Cross-border scope</div>
    </div>
    <div class="stat">
      <div class="stat-figure text-warning">
        {{ partial "data-icon.html" (dict "name" "eye" "color" "warning" "size" "8") }}
      </div>
      <div class="stat-title">Government Access</div>
      <div class="stat-value text-warning">{{ $govAccess }}</div>
      <div class="stat-desc">Data access powers</div>
    </div>
  </div>

  {{/* Search Box */}}
  <div class="mb-6">
    <label class="input input-bordered flex items-center gap-2 w-full">
      <svg class="h-5 w-5 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
      </svg>
      <input type="text" id="laws-search" class="grow" placeholder="Search laws by name, jurisdiction, or description..." />
    </label>
  </div>

  {{/* Filters */}}
  <details class="collapse collapse-arrow bg-base-100 border border-base-300 mb-4">
    <summary class="collapse-title text-sm font-semibold py-3 min-h-0">Filters</summary>
    <div class="collapse-content">
      <div class="space-y-4 pt-2">
        {{/* Category */}}
        <div data-filter-group="category">
          <div class="flex flex-wrap items-center gap-2 mb-2">
            <span class="text-xs font-medium opacity-60">Category:</span>
            <button class="btn btn-sm btn-active" data-filter="category" data-value="all">All</button>
          </div>
          <div class="flex flex-wrap gap-1">
            {{- range site.Data.laws.law_types.itemListElement -}}
            {{ $count := index $lawsPerCategory .identifier | default 0 }}
            {{ if gt $count 0 }}
            <button class="btn btn-sm btn-ghost" data-filter="category" data-value="{{ .identifier }}">{{ .emoji }} {{ .name }} <span class="badge badge-sm">{{ $count }}</span></button>
            {{ else }}
            <button class="btn btn-sm btn-ghost btn-disabled opacity-40" disabled>{{ .emoji }} {{ .name }} <span class="badge badge-sm">0</span></button>
            {{ end }}
            {{- end -}}
          </div>
        </div>

        {{/* Jurisdiction */}}
        <div data-filter-group="jurisdiction">
          <div class="flex flex-wrap items-center gap-2 mb-2">
            <span class="text-xs font-medium opacity-60">Jurisdiction:</span>
            <button class="btn btn-sm btn-active" data-filter="jurisdiction" data-value="all">All</button>
          </div>
          {{- if gt (len $blocFilters) 0 -}}
          <div class="mb-2">
            <div class="text-xs opacity-50 mb-1">Blocs</div>
            <div class="flex flex-wrap gap-1">
              {{- range $blocFilters -}}
              {{ $count := index $lawsPerJurisdiction .id | default 0 }}
              {{ if gt $count 0 }}
              <button class="btn btn-sm btn-ghost" data-filter="jurisdiction" data-value="{{ .id }}">{{ .flag }} {{ .name }} <span class="badge badge-sm">{{ $count }}</span></button>
              {{ else }}
              <button class="btn btn-sm btn-ghost btn-disabled opacity-40" disabled>{{ .flag }} {{ .name }} <span class="badge badge-sm">0</span></button>
              {{ end }}
              {{- end -}}
            </div>
          </div>
          {{- end -}}
          {{- if gt (len $countryFilters) 0 -}}
          <div>
            <div class="text-xs opacity-50 mb-1">Countries</div>
            <div class="flex flex-wrap gap-1">
              {{- range $countryFilters -}}
              {{ $count := index $lawsPerJurisdiction .id | default 0 }}
              {{ if gt $count 0 }}
              <button class="btn btn-sm btn-ghost" data-filter="jurisdiction" data-value="{{ .id }}">{{ .flag }} {{ .name }} <span class="badge badge-sm">{{ $count }}</span></button>
              {{ else }}
              <button class="btn btn-sm btn-ghost btn-disabled opacity-40" disabled>{{ .flag }} {{ .name }} <span class="badge badge-sm">0</span></button>
              {{ end }}
              {{- end -}}
            </div>
          </div>
          {{- end -}}
        </div>

        {{/* Features */}}
        <div data-filter-group="features">
          <div class="text-xs font-medium opacity-60 mb-2">Features</div>
          <div class="flex flex-wrap gap-1">
            {{ if gt $lawsExtraterritorial 0 }}
            <button class="btn btn-sm btn-ghost gap-1" data-filter="extraterritorial" data-value="true">üåç Extraterritorial <span class="badge badge-sm">{{ $lawsExtraterritorial }}</span></button>
            {{ else }}
            <button class="btn btn-sm btn-ghost btn-disabled opacity-40 gap-1" disabled>üåç Extraterritorial <span class="badge badge-sm">0</span></button>
            {{ end }}
            {{ if gt $lawsLocalization 0 }}
            <button class="btn btn-sm btn-ghost gap-1" data-filter="localization" data-value="true">üìç Localization <span class="badge badge-sm">{{ $lawsLocalization }}</span></button>
            {{ else }}
            <button class="btn btn-sm btn-ghost btn-disabled opacity-40 gap-1" disabled>üìç Localization <span class="badge badge-sm">0</span></button>
            {{ end }}
            {{ if gt $lawsBackdoor 0 }}
            <button class="btn btn-sm btn-ghost gap-1" data-filter="backdoor" data-value="true">üîë Backdoor <span class="badge badge-sm">{{ $lawsBackdoor }}</span></button>
            {{ else }}
            <button class="btn btn-sm btn-ghost btn-disabled opacity-40 gap-1" disabled>üîë Backdoor <span class="badge badge-sm">0</span></button>
            {{ end }}
          </div>
        </div>
      </div>
    </div>
  </details>


  {{/* Active filters display */}}
  <div id="active-filters" class="hidden alert mb-4">
    <span class="text-sm opacity-70">Active filters:</span>
    <div id="filter-tags" class="flex flex-wrap gap-1"></div>
    <button id="clear-filters" class="btn btn-sm btn-ghost">Clear all</button>
  </div>

  {{/* Results count */}}
  <div class="flex justify-between items-center mb-4">
    <div class="text-sm opacity-70">
      Showing <span id="showing-count">{{ $total }}</span> of <span id="total-count">{{ $total }}</span> laws
    </div>
  </div>

  {{/* Laws Grid */}}
  <div id="laws-grid" class="grid sm:grid-cols-2" style="gap: 1.5rem;">
    {{ range .Pages }}
      {{ $category := .Params.category | default "privacy" }}
      {{ $categoryInfo := index $lawTypes $category }}
      {{ $badgeClass := index $categoryBadge $category | default "badge-ghost" }}
      {{ $jurisdictions := .Params.legislationJurisdiction | default (slice) }}

      <article
        class="law-card card bg-base-100 shadow-md hover:shadow-lg transition-all group border border-base-200 h-full"
        data-identifier="{{ .Params.identifier }}"
        data-category="{{ $category }}"
        data-jurisdictions="{{ delimit $jurisdictions "," }}"
        data-extraterritorial="{{ .Params.extraterritorial | default false }}"
        data-localization="{{ .Params.requiresLocalization | default false }}"
        data-backdoor="{{ .Params.requiresBackdoor | default false }}"
        data-name="{{ .Title }}"
        data-alternatename="{{ .Params.alternateName | default "" }}"
        data-description="{{ .Params.description | default "" }}"
        data-year="{{ .Params.legislationDate | default "" }}"
      >
        <a href="{{ .RelPermalink }}" class="block no-underline">
          <div class="card-body p-4">
            {{/* Title row with flag, name, icons, and year */}}
            <div class="flex items-start gap-2">
              {{/* Flag */}}
              <div class="flex items-center gap-1 shrink-0 pt-0.5">
                {{- range $jurisdictions -}}
                  {{- $region := index $regionLookup . -}}
                  {{- $bloc := index $blocLookup . -}}
                  {{- if $region -}}
                    <span class="tooltip" data-tip="{{ $region.name }}"><span class="text-lg">{{ $region.flag }}</span></span>
                  {{- else if $bloc -}}
                    <span class="tooltip" data-tip="{{ $bloc.name }}"><span class="text-lg">{{ $bloc.flag }}</span></span>
                  {{- end -}}
                {{- end -}}
              </div>
              {{/* Title */}}
              <div class="min-w-0 flex-1">
                <h2 class="card-title text-base leading-tight group-hover:text-primary transition-colors line-clamp-2">{{ .Title }}</h2>
              </div>
              {{/* Icons and year */}}
              <div class="flex items-center gap-1 shrink-0 text-sm">
                {{ with $categoryInfo }}<span class="tooltip" data-tip="{{ .name }}">{{ .emoji }}</span>{{ end }}
                {{- if .Params.extraterritorial }}<span class="tooltip" data-tip="Extraterritorial reach">üåç</span>{{ end -}}
                {{- if .Params.requiresLocalization }}<span class="tooltip" data-tip="Requires data localization">üìç</span>{{ end -}}
                {{- if .Params.requiresBackdoor }}<span class="tooltip" data-tip="Requires backdoor access">üîë</span>{{ end -}}
                {{- if and .Params.governmentAccess (ne .Params.governmentAccess "none") }}<span class="tooltip" data-tip="Government data access">üëÅÔ∏è</span>{{ end -}}
                {{ with .Params.legislationDate }}<span class="opacity-60 ml-1">{{ . }}</span>{{ end }}
              </div>
            </div>

            {{/* Alternate name */}}
            {{ with .Params.alternateName }}
            <p class="text-xs opacity-60 line-clamp-1 mt-1">{{ . }}</p>
            {{ end }}

            {{/* Abstract/Description */}}
            {{ with .Params.abstract }}
            <p class="text-sm text-neutral-600 dark:text-neutral-400 line-clamp-3 mt-2">{{ . }}</p>
            {{ else }}
            {{ with .Description }}
            <p class="text-sm text-neutral-600 dark:text-neutral-400 line-clamp-3 mt-2">{{ . }}</p>
            {{ end }}
            {{ end }}
          </div>
        </a>
      </article>
    {{ end }}
  </div>

  {{/* No results */}}
  <div id="no-results" class="hidden alert alert-warning my-4">
    <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>
    <span>No laws match your filters.</span>
  </div>

</div>

<script>
(function() {
  let filters = { category: 'all', jurisdiction: 'all', extraterritorial: 'all', localization: 'all', backdoor: 'all', search: '' };

  const grid = document.getElementById('laws-grid');
  const searchInput = document.getElementById('laws-search');
  const noResults = document.getElementById('no-results');
  const showingCount = document.getElementById('showing-count');
  const totalCount = document.getElementById('total-count');
  const activeFiltersDiv = document.getElementById('active-filters');
  const filterTags = document.getElementById('filter-tags');

  const allCards = Array.from(grid.querySelectorAll('.law-card'));

  function setActiveButton(groupEl, value) {
    groupEl.querySelectorAll('button').forEach(b => {
      b.classList.remove('btn-active');
      b.classList.add('btn-ghost');
    });
    const target = groupEl.querySelector(`button[data-value="${value}"]`) || groupEl.querySelector('button[data-value="all"]');
    if (target) {
      target.classList.add('btn-active');
      target.classList.remove('btn-ghost');
    }
  }

  function init() {
    const params = new URLSearchParams(window.location.search);
    if (params.get('category')) filters.category = params.get('category');
    if (params.get('jurisdiction')) filters.jurisdiction = params.get('jurisdiction');
    if (params.get('q')) {
      filters.search = params.get('q');
      searchInput.value = filters.search;
    }
    updateFilterButtons();
    applyFilters();
    setupEventListeners();
  }

  function setupEventListeners() {
    let searchTimeout;
    searchInput.addEventListener('input', (e) => {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        filters.search = e.target.value.toLowerCase();
        applyFilters();
        updateURL();
      }, 300);
    });

    // Category and Jurisdiction filters (toggle on/off)
    document.querySelectorAll('[data-filter-group="category"] button, [data-filter-group="jurisdiction"] button').forEach(btn => {
      btn.addEventListener('click', () => {
        const groupEl = btn.closest('[data-filter-group]');
        const filterGroup = groupEl.dataset.filterGroup;
        const value = btn.dataset.value;

        // If clicking the already active filter (not "all"), toggle it off
        if (value !== 'all' && filters[filterGroup] === value) {
          filters[filterGroup] = 'all';
        } else {
          filters[filterGroup] = value;
        }
        setActiveButton(groupEl, filters[filterGroup]);
        applyFilters();
        updateURL();
      });
    });

    // Feature filters (toggle on/off)
    document.querySelectorAll('[data-filter-group="features"] button').forEach(btn => {
      btn.addEventListener('click', () => {
        const filterType = btn.dataset.filter;
        if (btn.classList.contains('btn-active')) {
          btn.classList.remove('btn-active');
          btn.classList.add('btn-ghost');
          filters[filterType] = 'all';
        } else {
          btn.classList.add('btn-active');
          btn.classList.remove('btn-ghost');
          filters[filterType] = btn.dataset.value;
        }
        applyFilters();
        updateURL();
      });
    });

    document.getElementById('clear-filters').addEventListener('click', () => {
      filters = { category: 'all', jurisdiction: 'all', extraterritorial: 'all', localization: 'all', backdoor: 'all', search: '' };
      searchInput.value = '';
      updateFilterButtons();
      applyFilters();
      updateURL();
    });
  }

  function updateFilterButtons() {
    const categoryGroup = document.querySelector('[data-filter-group="category"]');
    const jurisdictionGroup = document.querySelector('[data-filter-group="jurisdiction"]');
    if (categoryGroup) setActiveButton(categoryGroup, filters.category);
    if (jurisdictionGroup) setActiveButton(jurisdictionGroup, filters.jurisdiction);

    // Feature toggles
    document.querySelectorAll('[data-filter-group="features"] button').forEach(btn => {
      const filterType = btn.dataset.filter;
      if (filters[filterType] === btn.dataset.value) {
        btn.classList.add('btn-active');
        btn.classList.remove('btn-ghost');
      } else {
        btn.classList.remove('btn-active');
        btn.classList.add('btn-ghost');
      }
    });
  }

  function applyFilters() {
    let visibleCount = 0;

    allCards.forEach(card => {
      const category = card.dataset.category;
      const jurisdictions = card.dataset.jurisdictions.split(',');
      const extraterritorial = card.dataset.extraterritorial;
      const localization = card.dataset.localization;
      const backdoor = card.dataset.backdoor;
      const name = card.dataset.name.toLowerCase();
      const alternateName = card.dataset.alternatename.toLowerCase();
      const description = card.dataset.description.toLowerCase();
      const year = card.dataset.year;

      let visible = true;

      if (filters.category !== 'all' && category !== filters.category) visible = false;
      if (filters.jurisdiction !== 'all' && !jurisdictions.includes(filters.jurisdiction)) visible = false;
      if (filters.extraterritorial === 'true' && extraterritorial !== 'true') visible = false;
      if (filters.localization === 'true' && localization !== 'true') visible = false;
      if (filters.backdoor === 'true' && backdoor !== 'true') visible = false;

      if (filters.search) {
        const searchStr = `${name} ${alternateName} ${description} ${year} ${jurisdictions.join(' ')}`;
        if (!searchStr.includes(filters.search)) visible = false;
      }

      card.style.display = visible ? '' : 'none';
      if (visible) visibleCount++;
    });

    totalCount.textContent = allCards.length;
    showingCount.textContent = visibleCount;
    noResults.classList.toggle('hidden', visibleCount > 0);
    updateActiveFiltersDisplay();
  }

  function updateActiveFiltersDisplay() {
    const hasActiveFilters = filters.category !== 'all' || filters.jurisdiction !== 'all' ||
                              filters.extraterritorial !== 'all' || filters.localization !== 'all' ||
                              filters.backdoor !== 'all' || filters.search;
    activeFiltersDiv.classList.toggle('hidden', !hasActiveFilters);

    if (hasActiveFilters) {
      let tags = '';
      if (filters.search) tags += `<span class="badge badge-primary badge-sm">Search: "${filters.search}"</span>`;
      if (filters.category !== 'all') tags += `<span class="badge badge-primary badge-sm">${filters.category}</span>`;
      if (filters.jurisdiction !== 'all') tags += `<span class="badge badge-primary badge-sm">${filters.jurisdiction}</span>`;
      if (filters.extraterritorial === 'true') tags += `<span class="badge badge-primary badge-sm">üåç Extraterritorial</span>`;
      if (filters.localization === 'true') tags += `<span class="badge badge-primary badge-sm">üìç Localization</span>`;
      if (filters.backdoor === 'true') tags += `<span class="badge badge-primary badge-sm">üîë Backdoor</span>`;
      filterTags.innerHTML = tags;
    }
  }

  function updateURL() {
    const params = new URLSearchParams();
    if (filters.category !== 'all') params.set('category', filters.category);
    if (filters.jurisdiction !== 'all') params.set('jurisdiction', filters.jurisdiction);
    if (filters.search) params.set('q', filters.search);
    const newURL = params.toString() ? `?${params.toString()}` : window.location.pathname;
    history.replaceState(null, '', newURL);
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
})();
</script>

{{/* Floating TOC for mobile */}}
{{ $tocSections := slice
    (dict "id" "laws-search" "title" "Search" "icon" "üîç")
    (dict "id" "laws-grid" "title" "Laws" "icon" "‚öñÔ∏è")
}}
{{ partial "floating-toc.html" (dict "sections" $tocSections) }}
{{ end }}
