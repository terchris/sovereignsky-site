{{ define "main" }}
<article class="max-w-full">
  {{/* Section Header */}}
  {{ partial "section-header.html" (dict
      "title" .Title
      "description" .Description
      "icon" "scale"
  ) }}

  <section class="flex flex-col max-w-full mt-0">
    <div class="min-w-0 min-h-0 max-w-full">
      {{/* Stats cards */}}
      {{ $total := len (where site.RegularPages "Section" "laws") }}
      <div class="not-prose my-6">
        <div class="stats stats-vertical lg:stats-horizontal shadow-lg w-full bg-base-100">
          <div class="stat">
            <div class="stat-figure text-primary">
              {{ partial "content-icon.html" (dict "name" "scale" "color" "primary" "size" "8") }}
            </div>
            <div class="stat-title">Laws Documented</div>
            <div class="stat-value text-primary">{{ $total }}</div>
            <div class="stat-desc">Legal frameworks</div>
          </div>
          <div class="stat">
            <div class="stat-figure text-error">
              {{ partial "content-icon.html" (dict "name" "globe" "color" "error" "size" "8") }}
            </div>
            <div class="stat-title">Extraterritorial Reach</div>
            <div class="stat-value text-error">12</div>
            <div class="stat-desc">Cross-border scope</div>
          </div>
          <div class="stat">
            <div class="stat-figure text-warning">
              {{ partial "content-icon.html" (dict "name" "eye" "color" "warning" "size" "8") }}
            </div>
            <div class="stat-title">Government Access</div>
            <div class="stat-value text-warning">8</div>
            <div class="stat-desc">Data access powers</div>
          </div>
        </div>
      </div>

      {{/* Laws search (client-side) */}}
      {{ $laws := site.Data.laws.laws | default (slice) }}
      {{ $items := slice }}
      {{ range $laws }}
        {{ $items = $items | append (dict
          "id" .id
          "name" .name
          "full_name" (.full_name | default "")
          "year" (.year | default 0)
          "type" (.type | default "")
          "scope" (.scope | default "")
          "applies_to" (.applies_to | default (slice))
        ) }}
      {{ end }}

      <div class="not-prose mt-6 mb-8">
        <div class="p-4 rounded-lg bg-neutral-100 dark:bg-neutral-800 border border-neutral-200 dark:border-neutral-700">
          <div class="flex flex-wrap items-center gap-3">
            <div class="flex-1 min-w-[240px]">
              <label for="laws-search-input" class="text-sm font-medium text-neutral-700 dark:text-neutral-200">Search laws</label>
              <input
                id="laws-search-input"
                type="search"
                placeholder="Search by name (e.g., GDPR, CLOUD Act, NIS2)â€¦"
                autocomplete="off"
                class="mt-1 w-full px-3 py-2 rounded border border-neutral-300 dark:border-neutral-600 bg-white dark:bg-neutral-900 text-neutral-900 dark:text-neutral-100 focus:outline-none focus:ring-2 focus:ring-primary-500"
              />
            </div>
            <div class="flex items-end gap-2">
              <button
                id="laws-search-clear"
                type="button"
                class="px-3 py-2 rounded bg-neutral-200 dark:bg-neutral-700 text-sm hover:bg-neutral-300 dark:hover:bg-neutral-600"
              >
                Clear
              </button>
            </div>
            <div class="ml-auto text-sm text-neutral-600 dark:text-neutral-300" id="laws-search-summary"></div>
          </div>

          <div class="mt-3">
            <div class="text-xs text-neutral-500 dark:text-neutral-400">Matches</div>
            <div id="laws-search-results" class="mt-2 flex flex-wrap gap-2"></div>
            <div id="laws-search-empty" class="mt-2 text-sm text-neutral-500 dark:text-neutral-400 hidden">No matches.</div>
          </div>
        </div>

        <script type="application/json" id="laws-search-data">{{ $items | jsonify | safeHTML }}</script>
        <script>
          (function () {
            function readJsonScript(id, fallback) {
              var el = document.getElementById(id);
              if (!el) return fallback;
              try {
                var v = JSON.parse(el.textContent || 'null');
                if (typeof v === 'string') {
                  try { return JSON.parse(v); } catch (e2) { return v; }
                }
                return v;
              } catch (e) {
                return fallback;
              }
            }

            var input = document.getElementById('laws-search-input');
            var clearBtn = document.getElementById('laws-search-clear');
            var resultsEl = document.getElementById('laws-search-results');
            var emptyEl = document.getElementById('laws-search-empty');
            var summaryEl = document.getElementById('laws-search-summary');
            var data = readJsonScript('laws-search-data', []);

            if (!input || !resultsEl) return;

            function norm(s) { return String(s || '').toLowerCase(); }

            function lawSearchText(law) {
              var parts = [];
              parts.push(law.id);
              parts.push(law.name);
              parts.push(law.full_name);
              parts.push(law.type);
              parts.push(law.scope);
              (law.applies_to || []).forEach(function (a) { parts.push(a); });
              return norm(parts.join(' '));
            }

            var indexed = (data || []).map(function (l) {
              return Object.assign({}, l, { _q: lawSearchText(l) });
            });

            function render(items, query) {
              resultsEl.innerHTML = '';
              if (summaryEl) summaryEl.textContent = query ? (items.length + ' match' + (items.length === 1 ? '' : 'es')) : '';
              if (!items.length) {
                if (emptyEl) emptyEl.classList.remove('hidden');
                return;
              }
              if (emptyEl) emptyEl.classList.add('hidden');
              items.forEach(function (law) {
                var a = document.createElement('a');
                a.href = '/laws/' + law.id + '/';
                a.className = 'inline-flex items-center gap-2 no-underline px-3 py-1.5 rounded-lg border border-neutral-200 dark:border-neutral-700 bg-white dark:bg-neutral-900 hover:border-primary-400 dark:hover:border-primary-500 transition-colors text-sm';
                var name = document.createElement('span');
                name.className = 'font-medium';
                name.textContent = law.name || law.id;
                a.appendChild(name);
                if (law.year) {
                  var year = document.createElement('span');
                  year.className = 'text-neutral-500 dark:text-neutral-400';
                  year.textContent = '(' + law.year + ')';
                  a.appendChild(year);
                }
                resultsEl.appendChild(a);
              });
            }

            function update() {
              var q = norm(input.value || '').trim();
              if (!q) { render([], ''); return; }
              var out = indexed.filter(function (law) { return law._q.indexOf(q) !== -1; }).slice(0, 20);
              render(out, q);
            }

            input.addEventListener('input', update);
            input.addEventListener('keydown', function (e) {
              if (e.key === 'Escape') {
                input.value = '';
                update();
                input.blur();
              }
            });
            if (clearBtn) {
              clearBtn.addEventListener('click', function () {
                input.value = '';
                update();
                input.focus();
              });
            }

            render([], '');
          })();
        </script>
      </div>

      <div class="article-content prose dark:prose-invert max-w-none mb-20">
        {{ .Content }}
      </div>
    </div>
  </section>
</article>
{{ end }}
