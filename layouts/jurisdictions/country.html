{{ define "main" }}
  {{ .Scratch.Set "scope" "single" }}

  {{/* Resolve country from slug */}}
  {{ $slug := "" }}
  {{ with .File }}
    {{ $slug = strings.TrimSuffix "/" (strings.TrimPrefix "jurisdictions/" .Dir) }}
  {{ end }}

  {{ $countryId := .Params.country_id | default "" }}
  {{ $country := dict }}
  {{ if not $countryId }}
    {{ $match := first 1 (where site.Data.regions "slug" $slug) }}
    {{ with index $match 0 }}
      {{ $country = . }}
      {{ $countryId = .id }}
    {{ end }}
  {{ else }}
    {{ $match := first 1 (where site.Data.regions "id" $countryId) }}
    {{ with index $match 0 }}
      {{ $country = . }}
    {{ end }}
  {{ end }}

  {{ $countryName := $countryId }}
  {{ $countryFlag := "" }}
  {{ if $country }}
    {{ $countryName = $country.name | default $countryId }}
    {{ $countryFlag = $country.flag | default "" }}
  {{ end }}

  {{/* Auto-generate title from regions.json if frontmatter title is not set or is default */}}
  {{ $autoTitle := "" }}
  {{ if and $countryFlag $countryName }}
    {{ $autoTitle = printf "%s %s" $countryFlag $countryName }}
  {{ else if $countryName }}
    {{ $autoTitle = $countryName }}
  {{ end }}
  {{ $displayTitle := .Title }}
  {{ if and $autoTitle (or (not .Title) (eq .Title "Index") (eq .Title "")) }}
    {{ $displayTitle = $autoTitle }}
  {{ end }}

  {{/* Pre-calculate stats for hero */}}
  {{ $riskLevel := $country.risk_level | default "unknown" }}
  {{ $blocs := $country.blocs | default (slice) }}

  {{/* Count datacenters in this country */}}
  {{ $datacenterCount := 0 }}
  {{ range (site.Data.datacenters.providers | default (slice)) }}
    {{ range (.regions | default (slice)) }}
      {{ if eq .country_id $countryId }}
        {{ $datacenterCount = add $datacenterCount 1 }}
      {{ end }}
    {{ end }}
  {{ end }}

  {{/* Count laws */}}
  {{ $applicableIds := slice $countryId }}
  {{ $blocsData := site.Data.jurisdictions.blocs | default (slice) }}
  {{ range $blocs }}
    {{ $blocId := . }}
    {{ $applicableIds = $applicableIds | append $blocId }}
    {{ range $blocsData }}
      {{ if eq .id $blocId }}
        {{ range (.inherits_from | default (slice)) }}
          {{ $applicableIds = $applicableIds | append . }}
        {{ end }}
      {{ end }}
    {{ end }}
  {{ end }}
  {{ $lawCount := 0 }}
  {{ $seenLaws := slice }}
  {{ range site.Data.laws.laws }}
    {{ $lawId := .id }}
    {{ range .applies_to }}
      {{ $applyTo := . }}
      {{ range $applicableIds }}
        {{ if eq $applyTo . }}
          {{ $alreadySeen := false }}
          {{ range $seenLaws }}
            {{ if eq . $lawId }}{{ $alreadySeen = true }}{{ end }}
          {{ end }}
          {{ if not $alreadySeen }}
            {{ $lawCount = add $lawCount 1 }}
            {{ $seenLaws = $seenLaws | append $lawId }}
          {{ end }}
        {{ end }}
      {{ end }}
    {{ end }}
  {{ end }}

  <article class="not-prose">
    {{/* Hero Header */}}
    <div class="bg-gradient-to-r from-primary to-secondary text-primary-content rounded-box p-8 mb-8">
      <div class="flex items-center gap-4">
        {{ if $countryFlag }}
        <span class="text-6xl">{{ $countryFlag }}</span>
        {{ end }}
        <div>
          <h1 class="text-4xl font-bold mb-2">{{ $countryName }}</h1>
          {{ with $country.description }}
          <p class="text-lg opacity-90 max-w-2xl">{{ . }}</p>
          {{ end }}
        </div>
      </div>
    </div>

    {{/* Stats Row */}}
    <div class="stats stats-vertical sm:stats-horizontal shadow-lg w-full mb-8 bg-base-100">
      {{/* Risk Level */}}
      <div class="stat">
        <div class="stat-figure">
          {{ if eq $riskLevel "low" }}
          <span class="text-success text-3xl">‚úÖ</span>
          {{ else if eq $riskLevel "moderate" }}
          <span class="text-warning text-3xl">‚ö†Ô∏è</span>
          {{ else if eq $riskLevel "elevated" }}
          <span class="text-warning text-3xl">‚ö†Ô∏è</span>
          {{ else if eq $riskLevel "high" }}
          <span class="text-error text-3xl">üö®</span>
          {{ else if eq $riskLevel "sanctioned" }}
          <span class="text-error text-3xl">üö´</span>
          {{ else }}
          <span class="text-neutral text-3xl">‚ùì</span>
          {{ end }}
        </div>
        <div class="stat-title">Risk Level</div>
        <div class="stat-value text-xl {{ if eq $riskLevel "low" }}text-success{{ else if eq $riskLevel "moderate" }}text-warning{{ else if eq $riskLevel "elevated" }}text-warning{{ else if eq $riskLevel "high" }}text-error{{ else if eq $riskLevel "sanctioned" }}text-error{{ end }}">
          {{ $riskLevel | title }}
        </div>
        <div class="stat-desc">Data sovereignty</div>
      </div>

      {{/* Laws Count */}}
      <div class="stat">
        <div class="stat-figure text-primary">
          {{ partial "content-icon.html" (dict "name" "scale" "color" "primary" "size" "8") }}
        </div>
        <div class="stat-title">Applicable Laws</div>
        <div class="stat-value text-primary">{{ $lawCount }}</div>
        <div class="stat-desc">Privacy, access & security</div>
      </div>

      {{/* Datacenters */}}
      <div class="stat">
        <div class="stat-figure text-secondary">
          {{ partial "content-icon.html" (dict "name" "server" "color" "secondary" "size" "8") }}
        </div>
        <div class="stat-title">Datacenter Regions</div>
        <div class="stat-value text-secondary">{{ $datacenterCount }}</div>
        <div class="stat-desc"><a href="/datacenters/{{ $slug }}/" class="link link-hover">View map ‚Üí</a></div>
      </div>

      {{/* Bloc Memberships */}}
      {{ if gt (len $blocs) 0 }}
      <div class="stat">
        <div class="stat-figure text-accent">
          {{ partial "content-icon.html" (dict "name" "globe" "color" "accent" "size" "8") }}
        </div>
        <div class="stat-title">Member Of</div>
        <div class="stat-value text-accent text-xl">{{ len $blocs }} {{ if eq (len $blocs) 1 }}Bloc{{ else }}Blocs{{ end }}</div>
        <div class="stat-desc">{{ delimit $blocs ", " }}</div>
      </div>
      {{ end }}
    </div>

    {{/* Body with right sidebar */}}
    <section class="flex flex-col max-w-full mt-0 lg:flex-row">
      {{ $enableToc := site.Params.article.showTableOfContents | default false }}
      {{ $enableToc = .Params.showTableOfContents | default $enableToc }}
      {{ $showToc := and $enableToc (in .TableOfContents "<ul") }}
      {{ $topClass := cond (hasPrefix site.Params.header.layout "fixed") "lg:top-[140px]" "lg:top-10" }}

      {{ $blocs := $country.blocs | default (slice) }}
      {{ $showSidebar := or $showToc (gt (len $blocs) 0) }}
      {{ if $showSidebar }}
        <div class="order-first lg:ml-auto px-0 lg:order-last lg:ps-8 lg:max-w-md lg:min-w-[300px]">
          <div class="print:hidden lg:sticky {{ $topClass }} space-y-4">
            {{ if $showToc }}
              {{ partial "toc.html" . }}
            {{ end }}

            {{/* Memberships Card */}}
            {{ if gt (len $blocs) 0 }}
            <div class="card bg-base-100 shadow-sm border border-base-300">
              <div class="card-body p-4">
                <h3 class="card-title text-sm font-semibold flex items-center gap-2">
                  {{ partial "content-icon.html" (dict "name" "globe" "color" "accent" "size" "4") }}
                  Memberships
                </h3>
                <div class="flex flex-wrap gap-2 mt-2">
                  {{ range $blocs }}
                    {{ $blocId := . }}
                    {{ $blocName := $blocId }}
                    {{ $blocFlag := "" }}
                    {{ range $blocsData }}
                      {{ if eq .id $blocId }}
                        {{ $blocName = .name }}
                        {{ $blocFlag = .flag | default "" }}
                      {{ end }}
                    {{ end }}
                    <a href="/jurisdictions/{{ $blocId | urlize }}/" class="badge badge-outline badge-lg gap-1 hover:badge-primary transition-colors">
                      {{ if $blocFlag }}{{ $blocFlag }}{{ end }} {{ $blocName }}
                    </a>
                  {{ end }}
                </div>
              </div>
            </div>
            {{ end }}

            {{/* Laws Summary Card */}}
            {{ if $countryId }}
              {{ $applicableIds := slice $countryId }}
              {{ $countryBlocs := $country.blocs | default (slice) }}

              {{ range $countryBlocs }}
                {{ $blocId := . }}
                {{ $applicableIds = $applicableIds | append $blocId }}
                {{ range $blocsData }}
                  {{ if eq .id $blocId }}
                    {{ range (.inherits_from | default (slice)) }}
                      {{ $applicableIds = $applicableIds | append . }}
                    {{ end }}
                  {{ end }}
                {{ end }}
              {{ end }}

              {{ $.Scratch.Set "laws_showLaws" false }}
              {{ $.Scratch.Set "laws_total" 0 }}
              {{ $.Scratch.Set "laws_byType" (dict) }}
              {{ $.Scratch.Set "laws_seen" (slice) }}
              {{ range site.Data.laws.laws }}
                {{ $law := . }}
                {{ $lawId := .id }}
                {{ range .applies_to }}
                  {{ $applyTo := . }}
                  {{ range $applicableIds }}
                    {{ if eq $applyTo . }}
                      {{ $seen := $.Scratch.Get "laws_seen" }}
                      {{ $alreadyCounted := false }}
                      {{ range $seen }}
                        {{ if eq . $lawId }}{{ $alreadyCounted = true }}{{ end }}
                      {{ end }}
                      {{ if not $alreadyCounted }}
                        {{ $.Scratch.Set "laws_showLaws" true }}
                        {{ $.Scratch.Set "laws_total" (add ($.Scratch.Get "laws_total") 1) }}
                        {{ $lawType := $law.type | default "other" }}
                        {{ $currentCount := index ($.Scratch.Get "laws_byType") $lawType | default 0 }}
                        {{ $.Scratch.SetInMap "laws_byType" $lawType (add $currentCount 1) }}
                        {{ $.Scratch.Add "laws_seen" $lawId }}
                      {{ end }}
                    {{ end }}
                  {{ end }}
                {{ end }}
              {{ end }}

              {{ if $.Scratch.Get "laws_showLaws" }}
              <div class="card bg-base-100 shadow-sm border border-base-300">
                <div class="card-body p-4">
                  <h3 class="card-title text-sm font-semibold flex items-center gap-2">
                    {{ partial "content-icon.html" (dict "name" "scale" "color" "primary" "size" "4") }}
                    Laws by Type
                  </h3>
                  <p class="text-xs opacity-60 -mt-1">{{ $.Scratch.Get "laws_total" }} applicable laws</p>
                  <ul class="menu menu-sm bg-base-200 rounded-box mt-2 p-1 w-full">
                    {{ $lawTypes := site.Data.tag_vocabulary.lawTypes | default (dict) }}
                    {{ $typeOrder := $lawTypes.values | default (slice "privacy" "access" "surveillance" "localization" "security" "sector") }}
                    {{ $shortLabels := $lawTypes.shortLabels | default (dict "privacy" "Privacy" "access" "Access" "surveillance" "Surveillance" "localization" "Localization" "security" "Security" "sector" "Sector") }}
                    {{ $emojis := $lawTypes.emojis | default (dict "privacy" "üõ°Ô∏è" "access" "üîì" "surveillance" "üëÅÔ∏è" "localization" "üìç" "security" "üîí" "sector" "üìã") }}
                    {{ $byType := $.Scratch.Get "laws_byType" }}
                    {{ range $typeOrder }}
                      {{ $type := . }}
                      {{ $count := index $byType $type }}
                      {{ if $count }}
                        {{ $label := index $shortLabels $type }}
                        {{ $emoji := index $emojis $type }}
                        <li>
                          <a href="#{{ $type }}-laws" class="flex justify-between items-center gap-2 min-w-0">
                            <span class="flex items-center gap-1 truncate">{{ $emoji }} {{ $label }}</span>
                            <span class="badge badge-sm flex-shrink-0">{{ $count }}</span>
                          </a>
                        </li>
                      {{ end }}
                    {{ end }}
                  </ul>
                </div>
              </div>
              {{ end }}
            {{ end }}

            {{/* Datacenters Card */}}
            {{ if $country }}
            <div class="card bg-base-100 shadow-sm border border-base-300">
              <div class="card-body p-4">
                <h3 class="card-title text-sm font-semibold flex items-center gap-2">
                  {{ partial "content-icon.html" (dict "name" "server" "color" "secondary" "size" "4") }}
                  Datacenters
                </h3>
                <a href="/datacenters/{{ $country.slug }}/" class="btn btn-sm btn-outline btn-secondary mt-2 gap-2">
                  {{ if $countryFlag }}{{ $countryFlag }}{{ end }} View {{ $datacenterCount }} Regions
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"/>
                  </svg>
                </a>
              </div>
            </div>
            {{ end }}

            {{/* Related content */}}
            {{ partial "related-content-sidebar.html" (dict "page" . "country_id" $countryId) }}
          </div>
        </div>
      {{ end }}

      <div class="min-w-0 min-h-0 max-w-fit">
        <div class="article-content max-w-5xl mb-20">
          {{/* Risk Assessment Card */}}
          {{ $riskDescription := "" }}
          {{ if eq $riskLevel "low" }}
            {{ $riskDescription = "Strong data protection laws aligned with GDPR. No extraterritorial data access concerns." }}
          {{ else if eq $riskLevel "moderate" }}
            {{ $riskDescription = "Generally acceptable data protection, but some concerns exist. Review specific laws before storing sensitive data." }}
          {{ else if eq $riskLevel "elevated" }}
            {{ $riskDescription = "Notable government access provisions or weaker privacy protections. Consider alternatives for sensitive data." }}
          {{ else if eq $riskLevel "high" }}
            {{ $riskDescription = "Broad government access to data, weak privacy protections, or extraterritorial reach. Avoid for sensitive data." }}
          {{ else if eq $riskLevel "sanctioned" }}
            {{ $riskDescription = "Subject to international sanctions. Data transfers may be legally prohibited or highly restricted." }}
          {{ end }}

          {{ if $riskDescription }}
          <div class="alert {{ if eq $riskLevel "low" }}alert-success{{ else if eq $riskLevel "moderate" }}alert-warning{{ else if eq $riskLevel "elevated" }}alert-warning{{ else }}alert-error{{ end }} mb-8">
            <svg class="w-6 h-6 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            <div>
              <h3 class="font-bold">Risk Assessment: {{ $riskLevel | title }}</h3>
              <p class="text-sm">{{ $riskDescription }}</p>
            </div>
          </div>
          {{ end }}

          {{/* Check if there's any custom content in the markdown file */}}
          {{ $rawContent := .RawContent | strings.TrimSpace }}
          {{ $hasCustomContent := gt (len $rawContent) 0 }}

          {{/* Render any custom page content from markdown */}}
          {{ if $hasCustomContent }}
          <div class="prose dark:prose-invert max-w-none mb-8">
            {{ .Content }}
          </div>
          {{ end }}

          {{/* Laws Section */}}
          {{ if $countryId }}
          <div class="mb-8">
            <h2 class="text-2xl font-bold text-neutral-800 dark:text-neutral-100 mb-2" id="laws">Applicable Laws</h2>
            <p class="text-neutral-600 dark:text-neutral-400 mb-6">
              These laws apply to {{ $countryName }}{{ if gt (len $blocs) 0 }}, including those inherited through {{ if gt (len $blocs) 1 }}bloc memberships{{ else }}{{ index $blocs 0 }}{{ end }}{{ end }}.
            </p>
            {{ partial "jurisdiction-laws-inline.html" (dict "jurisdictionId" $countryId "country" $country) }}
          </div>
          {{ end }}

          {{/* Footer navigation */}}
          <div class="divider"></div>
          <div class="flex flex-wrap gap-4">
            <a href="/jurisdictions/" class="btn btn-outline btn-sm">‚Üê All Jurisdictions</a>
            <a href="/datacenters/{{ $slug }}/" class="btn btn-outline btn-sm">{{ $countryFlag }} Datacenters</a>
            <a href="/software/" class="btn btn-outline btn-sm">Browse Software</a>
          </div>
        </div>
      </div>
    </section>
  </article>
{{ end }}
