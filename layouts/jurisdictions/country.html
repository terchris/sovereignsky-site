{{ define "main" }}
  {{ .Scratch.Set "scope" "single" }}

  {{/* Resolve country from frontmatter or slug */}}
  {{ $slug := "" }}
  {{ with .File }}
    {{ $slug = strings.TrimSuffix "/" (strings.TrimPrefix "jurisdictions/" .Dir) }}
  {{ end }}

  {{ $countryId := .Params.country_id | default "" }}
  {{ $country := dict }}
  {{ if not $countryId }}
    {{ $match := first 1 (where site.Data.regions "slug" $slug) }}
    {{ with index $match 0 }}
      {{ $country = . }}
      {{ $countryId = .identifier }}
    {{ end }}
  {{ else }}
    {{ $match := first 1 (where site.Data.regions "identifier" $countryId) }}
    {{ with index $match 0 }}
      {{ $country = . }}
    {{ end }}
  {{ end }}

  {{ $countryName := $countryId }}
  {{ $countryFlag := "" }}
  {{ if $country }}
    {{ $countryName = $country.name | default $countryId }}
    {{ $countryFlag = $country.flag | default "" }}
  {{ end }}

  {{/* Pre-calculate stats */}}
  {{ $riskLevel := $country.riskLevel | default "unknown" }}
  {{ $blocs := $country.blocs | default (slice) }}
  {{ $blocsData := site.Data.jurisdictions.blocs | default (slice) }}

  {{/* Count datacenters */}}
  {{ $datacenterCount := 0 }}
  {{ range (site.Data.datacenters.providers | default (slice)) }}
    {{ range (.regions | default (slice)) }}
      {{ if eq .country_id $countryId }}
        {{ $datacenterCount = add $datacenterCount 1 }}
      {{ end }}
    {{ end }}
  {{ end }}

  {{/* Count laws */}}
  {{ $applicableIds := slice $countryId }}
  {{ range $blocs }}
    {{ $blocId := . }}
    {{ $applicableIds = $applicableIds | append $blocId }}
    {{ range $blocsData }}
      {{ if eq .identifier $blocId }}
        {{ range (.inheritsFrom | default (slice)) }}
          {{ $applicableIds = $applicableIds | append . }}
        {{ end }}
      {{ end }}
    {{ end }}
  {{ end }}
  {{ $lawCount := 0 }}
  {{ $seenLaws := slice }}
  {{ range site.Data.laws.laws.itemListElement }}
    {{ $lawId := .identifier }}
    {{ range .legislationJurisdiction }}
      {{ $applyTo := . }}
      {{ range $applicableIds }}
        {{ if eq $applyTo . }}
          {{ $alreadySeen := false }}
          {{ range $seenLaws }}
            {{ if eq . $lawId }}{{ $alreadySeen = true }}{{ end }}
          {{ end }}
          {{ if not $alreadySeen }}
            {{ $lawCount = add $lawCount 1 }}
            {{ $seenLaws = $seenLaws | append $lawId }}
          {{ end }}
        {{ end }}
      {{ end }}
    {{ end }}
  {{ end }}

  <article class="max-w-full">
    {{/* Detail Header with breadcrumbs */}}
    {{ partial "common-detail-header.html" (dict
        "title" $countryName
        "description" ($country.description | default "")
        "flag" $countryFlag
        "breadcrumbs" (slice
            (dict "title" "Jurisdictions" "url" "/jurisdictions/")
        )
    ) }}

    {{/* Stats Row */}}
    <div class="stats stats-vertical sm:stats-horizontal shadow-lg w-full mb-8 bg-base-100">
      {{/* Risk Level */}}
      <div class="stat">
        <div class="stat-figure">
          {{ if eq $riskLevel "low" }}
          <span class="text-success text-3xl">‚úÖ</span>
          {{ else if eq $riskLevel "moderate" }}
          <span class="text-warning text-3xl">‚ö†Ô∏è</span>
          {{ else if eq $riskLevel "elevated" }}
          <span class="text-warning text-3xl">‚ö†Ô∏è</span>
          {{ else if eq $riskLevel "high" }}
          <span class="text-error text-3xl">üö®</span>
          {{ else if eq $riskLevel "sanctioned" }}
          <span class="text-error text-3xl">üö´</span>
          {{ else }}
          <span class="text-neutral text-3xl">‚ùì</span>
          {{ end }}
        </div>
        <div class="stat-title">Risk Level</div>
        <div class="stat-value text-xl {{ if eq $riskLevel "low" }}text-success{{ else if eq $riskLevel "moderate" }}text-warning{{ else if eq $riskLevel "elevated" }}text-warning{{ else if eq $riskLevel "high" }}text-error{{ else if eq $riskLevel "sanctioned" }}text-error{{ end }}">
          {{ $riskLevel | title }}
        </div>
        <div class="stat-desc">Data sovereignty</div>
      </div>

      {{/* Laws Count */}}
      <div class="stat">
        <div class="stat-figure text-primary">
          {{ partial "content-icon.html" (dict "name" "scale" "color" "primary" "size" "8") }}
        </div>
        <div class="stat-title">Applicable Laws</div>
        <div class="stat-value text-primary">{{ $lawCount }}</div>
        <div class="stat-desc">Privacy, access & security</div>
      </div>

      {{/* Datacenters */}}
      <div class="stat">
        <div class="stat-figure text-secondary">
          {{ partial "content-icon.html" (dict "name" "server" "color" "secondary" "size" "8") }}
        </div>
        <div class="stat-title">Datacenter Regions</div>
        <div class="stat-value text-secondary">{{ $datacenterCount }}</div>
        <div class="stat-desc"><a href="/datacenters/{{ $slug }}/" class="link link-hover">View map ‚Üí</a></div>
      </div>

      {{/* Bloc Memberships */}}
      {{ if gt (len $blocs) 0 }}
      <div class="stat">
        <div class="stat-figure text-accent">
          {{ partial "content-icon.html" (dict "name" "globe" "color" "accent" "size" "8") }}
        </div>
        <div class="stat-title">Member Of</div>
        <div class="stat-value text-accent text-xl">{{ len $blocs }} {{ if eq (len $blocs) 1 }}Bloc{{ else }}Blocs{{ end }}</div>
        <div class="stat-desc">{{ delimit $blocs ", " }}</div>
      </div>
      {{ end }}
    </div>

    {{/* Two-column layout with shared sidebar */}}
    <section class="flex flex-col max-w-full mt-0 lg:flex-row">

      {{/* Right Sidebar using shared pattern */}}
      {{ partial "sidebar/common-sidebar.html" . }}

        {{/* Sidebar cards */}}
        {{ partial "sidebar/jurisdiction-memberships-card.html" . }}
        {{ partial "sidebar/jurisdiction-laws-card.html" . }}
        {{ partial "sidebar/bloc-datacenters-card.html" (dict "countryId" $countryId "countrySlug" $country.slug) }}

        {{/* Related content */}}
        {{ partial "related-content-sidebar.html" (dict "page" . "country_id" $countryId) }}

      {{ partial "sidebar/common-sidebar-end.html" . }}

      {{/* Main Content */}}
      <div class="min-w-0 flex-1">
        <div class="article-content max-w-5xl mb-20">
          {{/* Risk Assessment Card */}}
          {{ $riskDescription := "" }}
          {{ if eq $riskLevel "low" }}
            {{ $riskDescription = "Strong data protection laws aligned with GDPR. No extraterritorial data access concerns." }}
          {{ else if eq $riskLevel "moderate" }}
            {{ $riskDescription = "Generally acceptable data protection, but some concerns exist. Review specific laws before storing sensitive data." }}
          {{ else if eq $riskLevel "elevated" }}
            {{ $riskDescription = "Notable government access provisions or weaker privacy protections. Consider alternatives for sensitive data." }}
          {{ else if eq $riskLevel "high" }}
            {{ $riskDescription = "Broad government access to data, weak privacy protections, or extraterritorial reach. Avoid for sensitive data." }}
          {{ else if eq $riskLevel "sanctioned" }}
            {{ $riskDescription = "Subject to international sanctions. Data transfers may be legally prohibited or highly restricted." }}
          {{ end }}

          {{ if $riskDescription }}
          <div class="alert {{ if eq $riskLevel "low" }}alert-success{{ else if eq $riskLevel "moderate" }}alert-warning{{ else if eq $riskLevel "elevated" }}alert-warning{{ else }}alert-error{{ end }} mb-8">
            <svg class="w-6 h-6 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            <div>
              <h3 class="font-bold">Risk Assessment: {{ $riskLevel | title }}</h3>
              <p class="text-sm">{{ $riskDescription }}</p>
            </div>
          </div>
          {{ end }}

          {{/* Custom content from markdown */}}
          {{ $rawContent := .RawContent | strings.TrimSpace }}
          {{ $hasCustomContent := gt (len $rawContent) 0 }}
          {{ if $hasCustomContent }}
          <div class="prose dark:prose-invert max-w-none mb-8">
            {{ .Content }}
          </div>
          {{ end }}

          {{/* Laws Section */}}
          {{ if $countryId }}
          <div class="mb-8">
            <h2 class="text-2xl font-bold text-neutral-800 dark:text-neutral-100 mb-2" id="laws">Applicable Laws</h2>
            <p class="text-neutral-600 dark:text-neutral-400 mb-6">
              These laws apply to {{ $countryName }}{{ if gt (len $blocs) 0 }}, including those inherited through {{ if gt (len $blocs) 1 }}bloc memberships{{ else }}{{ index $blocs 0 }}{{ end }}{{ end }}.
            </p>
            {{ partial "jurisdiction-laws-inline.html" (dict "jurisdictionId" $countryId "country" $country) }}
          </div>
          {{ end }}

          {{/* Footer navigation */}}
          <div class="divider"></div>
          <div class="flex flex-wrap gap-4">
            <a href="/jurisdictions/" class="btn btn-outline btn-sm">‚Üê All Jurisdictions</a>
            <a href="/datacenters/{{ $slug }}/" class="btn btn-outline btn-sm">{{ $countryFlag }} Datacenters</a>
            <a href="/software/" class="btn btn-outline btn-sm">Browse Software</a>
          </div>
        </div>
      </div>
    </section>
  </article>
{{ end }}
