{{ define "main" }}
  {{ .Scratch.Set "scope" "single" }}

  {{/* Resolve bloc from frontmatter or slug */}}
  {{ $slug := "" }}
  {{ with .File }}
    {{ $slug = strings.TrimSuffix "/" (strings.TrimPrefix "jurisdictions/" .Dir) }}
  {{ end }}

  {{ $blocId := .Params.bloc_id | default "" }}
  {{ $bloc := dict }}
  {{ $blocsData := site.Data.jurisdictions.blocs | default (slice) }}

  {{ if not $blocId }}
    {{ $match := first 1 (where $blocsData "slug" $slug) }}
    {{ with index $match 0 }}
      {{ $bloc = . }}
      {{ $blocId = .identifier }}
    {{ end }}
  {{ else }}
    {{ $match := first 1 (where $blocsData "identifier" $blocId) }}
    {{ with index $match 0 }}
      {{ $bloc = . }}
    {{ end }}
  {{ end }}

  {{ $blocName := $bloc.name | default $blocId }}
  {{ $blocFlag := $bloc.flag | default "" }}
  {{ $riskLevel := $bloc.riskLevel | default "unknown" }}

  {{/* Build lookup for blocs by id */}}
  {{ $blocsById := dict }}
  {{ range $blocsData }}
    {{ $blocsById = merge $blocsById (dict .identifier .) }}
  {{ end }}

  {{/* Get effective members (direct + inherited) */}}
  {{ $directMembers := $bloc.members | default (slice) }}
  {{ $allMembers := slice }}
  {{ range $directMembers }}
    {{ $allMembers = $allMembers | append . }}
  {{ end }}

  {{/* Add inherited members */}}
  {{ range ($bloc.inheritsFrom | default (slice)) }}
    {{ $parentBloc := index $blocsById . }}
    {{ if $parentBloc }}
      {{ range ($parentBloc.members | default (slice)) }}
        {{ if not (in $allMembers .) }}
          {{ $allMembers = $allMembers | append . }}
        {{ end }}
      {{ end }}
      {{/* Go one more level for grandparent inheritance */}}
      {{ range ($parentBloc.inheritsFrom | default (slice)) }}
        {{ $grandparent := index $blocsById . }}
        {{ if $grandparent }}
          {{ range ($grandparent.members | default (slice)) }}
            {{ if not (in $allMembers .) }}
              {{ $allMembers = $allMembers | append . }}
            {{ end }}
          {{ end }}
        {{ end }}
      {{ end }}
    {{ end }}
  {{ end }}

  {{ $memberCount := len $allMembers }}

  {{/* Count laws (direct + inherited) */}}
  {{ $applicableBlocIds := slice $blocId }}
  {{ range ($bloc.inheritsFrom | default (slice)) }}
    {{ $applicableBlocIds = $applicableBlocIds | append . }}
    {{ $parentBloc := index $blocsById . }}
    {{ if $parentBloc }}
      {{ range ($parentBloc.inheritsFrom | default (slice)) }}
        {{ $applicableBlocIds = $applicableBlocIds | append . }}
      {{ end }}
    {{ end }}
  {{ end }}

  {{ $lawCount := 0 }}
  {{ $seenLaws := slice }}
  {{ range site.Data.laws.laws.itemListElement }}
    {{ $lawId := .identifier }}
    {{ range .legislationJurisdiction }}
      {{ $applyTo := . }}
      {{ range $applicableBlocIds }}
        {{ if eq $applyTo . }}
          {{ $alreadySeen := false }}
          {{ range $seenLaws }}
            {{ if eq . $lawId }}{{ $alreadySeen = true }}{{ end }}
          {{ end }}
          {{ if not $alreadySeen }}
            {{ $lawCount = add $lawCount 1 }}
            {{ $seenLaws = $seenLaws | append $lawId }}
          {{ end }}
        {{ end }}
      {{ end }}
    {{ end }}
  {{ end }}

  {{/* Count datacenters across all member countries */}}
  {{ $datacenterCount := 0 }}
  {{ range (site.Data.datacenters.providers | default (slice)) }}
    {{ range (.regions | default (slice)) }}
      {{ $dcCountry := .country_id }}
      {{ if in $allMembers $dcCountry }}
        {{ $datacenterCount = add $datacenterCount 1 }}
      {{ end }}
    {{ end }}
  {{ end }}

  <article class="max-w-full">
    {{/* Detail Header with breadcrumbs */}}
    {{ partial "common-detail-header.html" (dict
        "title" $blocName
        "description" ($bloc.description | default "")
        "flag" $blocFlag
        "breadcrumbs" (slice
            (dict "title" "Jurisdictions" "url" "/jurisdictions/")
        )
    ) }}

    {{/* Stats Row */}}
    <div class="stats stats-vertical sm:stats-horizontal shadow-lg w-full mb-8 bg-base-100">
      {{/* Risk Level */}}
      <div class="stat">
        <div class="stat-figure">
          {{ if eq $riskLevel "low" }}
          <span class="text-success text-3xl">‚úÖ</span>
          {{ else if eq $riskLevel "moderate" }}
          <span class="text-warning text-3xl">‚ö†Ô∏è</span>
          {{ else if eq $riskLevel "elevated" }}
          <span class="text-warning text-3xl">‚ö†Ô∏è</span>
          {{ else if eq $riskLevel "high" }}
          <span class="text-error text-3xl">üö®</span>
          {{ else if eq $riskLevel "sanctioned" }}
          <span class="text-error text-3xl">üö´</span>
          {{ else }}
          <span class="text-neutral text-3xl">‚ùì</span>
          {{ end }}
        </div>
        <div class="stat-title">Risk Level</div>
        <div class="stat-value text-xl {{ if eq $riskLevel "low" }}text-success{{ else if eq $riskLevel "moderate" }}text-warning{{ else if eq $riskLevel "elevated" }}text-warning{{ else if eq $riskLevel "high" }}text-error{{ else if eq $riskLevel "sanctioned" }}text-error{{ end }}">
          {{ $riskLevel | title }}
        </div>
        <div class="stat-desc">Data sovereignty</div>
      </div>

      {{/* Member Countries */}}
      <div class="stat">
        <div class="stat-figure text-accent">
          {{ partial "content-icon.html" (dict "name" "globe" "color" "accent" "size" "8") }}
        </div>
        <div class="stat-title">Member Countries</div>
        <div class="stat-value text-accent">{{ $memberCount }}</div>
        <div class="stat-desc">{{ if gt (len $directMembers) 0 }}{{ len $directMembers }} direct{{ if gt (len ($bloc.inheritsFrom | default (slice))) 0 }}, {{ sub $memberCount (len $directMembers) }} inherited{{ end }}{{ else }}All inherited{{ end }}</div>
      </div>

      {{/* Laws Count */}}
      <div class="stat">
        <div class="stat-figure text-primary">
          {{ partial "content-icon.html" (dict "name" "scale" "color" "primary" "size" "8") }}
        </div>
        <div class="stat-title">Applicable Laws</div>
        <div class="stat-value text-primary">{{ $lawCount }}</div>
        <div class="stat-desc">Privacy, access & security</div>
      </div>

      {{/* Datacenters */}}
      <div class="stat">
        <div class="stat-figure text-secondary">
          {{ partial "content-icon.html" (dict "name" "server" "color" "secondary" "size" "8") }}
        </div>
        <div class="stat-title">Datacenter Regions</div>
        <div class="stat-value text-secondary">{{ $datacenterCount }}</div>
        <div class="stat-desc">Across member countries</div>
      </div>
    </div>

    {{/* Two-column layout */}}
    <section class="flex flex-col max-w-full mt-0 lg:flex-row">

      {{/* Right Sidebar */}}
      {{ partial "sidebar/common-sidebar.html" . }}

        {{/* Inherits From Card */}}
        {{ if gt (len ($bloc.inheritsFrom | default (slice))) 0 }}
        <div class="card bg-base-100 shadow-sm border border-base-300">
          <div class="card-body p-4">
            <h3 class="card-title text-sm font-semibold flex items-center gap-2">
              {{ partial "content-icon.html" (dict "name" "arrow-up" "color" "info" "size" "4") }}
              Inherits From
            </h3>
            <ul class="mt-2 space-y-1">
              {{ range ($bloc.inheritsFrom | default (slice)) }}
                {{ $parent := index $blocsById . }}
                {{ if $parent }}
                <li>
                  <a href="/jurisdictions/{{ $parent.slug }}/" class="flex items-center gap-2 text-sm hover:text-primary-600 dark:hover:text-primary-400">
                    <span>{{ $parent.flag }}</span>
                    <span>{{ $parent.name }}</span>
                  </a>
                </li>
                {{ end }}
              {{ end }}
            </ul>
          </div>
        </div>
        {{ end }}

        {{/* Member Countries Card */}}
        {{ if gt $memberCount 0 }}
        <div class="card bg-base-100 shadow-sm border border-base-300">
          <div class="card-body p-4">
            <h3 class="card-title text-sm font-semibold flex items-center gap-2">
              {{ partial "content-icon.html" (dict "name" "globe" "color" "accent" "size" "4") }}
              Member Countries
            </h3>
            <p class="text-xs opacity-60 -mt-1">{{ $memberCount }} countries</p>
            <div class="mt-2 flex flex-wrap gap-x-5 gap-y-2 max-h-48 overflow-y-auto">
              {{ range $allMembers }}
                {{ $countryMatch := first 1 (where site.Data.regions "identifier" .) }}
                {{ with index $countryMatch 0 }}
                <a href="/jurisdictions/{{ .slug }}/"
                   class="text-sm hover:text-primary-600 dark:hover:text-primary-400 no-underline whitespace-nowrap"
                   title="{{ .name }}">
                  {{ .flag }} {{ .name }}
                </a>
                {{ end }}
              {{ end }}
            </div>
          </div>
        </div>
        {{ end }}

        {{/* Laws by Type Card */}}
        {{ partial "sidebar/bloc-laws-card.html" (dict "blocId" $blocId "bloc" $bloc "blocsById" $blocsById) }}

        {{/* Datacenters Card */}}
        {{ partial "sidebar/bloc-datacenters-card.html" (dict "allMembers" $allMembers "blocName" $blocName "blocFlag" $blocFlag) }}

      {{ partial "sidebar/common-sidebar-end.html" . }}

      {{/* Main Content */}}
      <div class="min-w-0 flex-1">
        <div class="article-content max-w-5xl mb-20">
          {{/* Risk Assessment Card */}}
          {{ $riskDescription := "" }}
          {{ $riskInfo := index site.Data.jurisdictions.riskLevels $riskLevel }}
          {{ if $riskInfo }}
            {{ $riskDescription = $riskInfo.description }}
          {{ end }}

          {{ if $riskDescription }}
          <div class="alert {{ if eq $riskLevel "low" }}alert-success{{ else if eq $riskLevel "moderate" }}alert-warning{{ else if eq $riskLevel "elevated" }}alert-warning{{ else }}alert-error{{ end }} mb-8">
            <svg class="w-6 h-6 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            <div>
              <h3 class="font-bold">Risk Assessment: {{ $riskLevel | title }}</h3>
              <p class="text-sm">{{ $riskDescription }}</p>
            </div>
          </div>
          {{ end }}

          {{/* Notes */}}
          {{ with $bloc.notes }}
          <div class="alert alert-info mb-8">
            <svg class="w-6 h-6 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            <div>
              <h3 class="font-bold">Note</h3>
              <p class="text-sm">{{ . }}</p>
            </div>
          </div>
          {{ end }}

          {{/* Custom content from markdown */}}
          {{ $rawContent := .RawContent | strings.TrimSpace }}
          {{ $hasCustomContent := gt (len $rawContent) 0 }}
          {{ if $hasCustomContent }}
          <div class="prose dark:prose-invert max-w-none mb-8">
            {{ .Content }}
          </div>
          {{ end }}

          {{/* Laws Section */}}
          <div class="mb-8">
            <h2 class="text-2xl font-bold text-neutral-800 dark:text-neutral-100 mb-2" id="laws">Applicable Laws</h2>
            <p class="text-neutral-600 dark:text-neutral-400 mb-6">
              These laws apply to all member countries of {{ $blocName }}{{ if gt (len ($bloc.inheritsFrom | default (slice))) 0 }}, including inherited laws{{ end }}.
            </p>
            {{ partial "jurisdiction-laws-inline.html" (dict "jurisdictionId" $blocId) }}
          </div>

          {{/* Member Countries Table */}}
          {{ if gt $memberCount 0 }}
          <div class="mb-8">
            <h2 class="text-2xl font-bold text-neutral-800 dark:text-neutral-100 mb-2" id="members">Member Countries</h2>
            <p class="text-neutral-600 dark:text-neutral-400 mb-6">
              {{ $memberCount }} countries are part of {{ $blocName }}.
            </p>
            <div class="overflow-x-auto">
              <table class="table table-zebra w-full">
                <thead>
                  <tr>
                    <th>Country</th>
                    <th>Risk Level</th>
                    <th>Membership</th>
                  </tr>
                </thead>
                <tbody>
                  {{ range $allMembers }}
                    {{ $countryMatch := first 1 (where site.Data.regions "identifier" .) }}
                    {{ with index $countryMatch 0 }}
                    {{ $isDirect := in $directMembers .identifier }}
                    <tr>
                      <td>
                        <a href="/jurisdictions/{{ .slug }}/" class="flex items-center gap-2 hover:text-primary-600 dark:hover:text-primary-400 no-underline">
                          <span>{{ .flag }}</span>
                          <span>{{ .name }}</span>
                        </a>
                      </td>
                      <td>
                        <span class="badge {{ if eq .riskLevel "low" }}badge-success{{ else if eq .riskLevel "moderate" }}badge-warning{{ else if eq .riskLevel "elevated" }}badge-warning{{ else }}badge-error{{ end }} badge-sm">
                          {{ .riskLevel | title }}
                        </span>
                      </td>
                      <td>
                        {{ if $isDirect }}
                        <span class="text-xs text-neutral-500">Direct</span>
                        {{ else }}
                        <span class="text-xs text-neutral-400">Inherited</span>
                        {{ end }}
                      </td>
                    </tr>
                    {{ end }}
                  {{ end }}
                </tbody>
              </table>
            </div>
          </div>
          {{ end }}

          {{/* Footer navigation */}}
          <div class="divider"></div>
          <div class="flex flex-wrap gap-4">
            <a href="/jurisdictions/" class="btn btn-outline btn-sm">‚Üê All Jurisdictions</a>
            <a href="/software/" class="btn btn-outline btn-sm">Browse Software</a>
          </div>
        </div>
      </div>
    </section>
  </article>
{{ end }}
